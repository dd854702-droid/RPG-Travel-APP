<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêçÂè§Â±ãÂÜíÈö™Êó•Ë™å | Nagoya Adventure Log</title>
    
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5ZCN5Y+qk9aF6ZqquZzmXlSIsInNob3J0X25hbWUiOiLlgpLpmprljp8iLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tanRpZmYtY29tLnRpbnlwaXguY29tL3VwbG9hZHMvMjAyMy0xMS0wNy9jbHVlc19tYXBfMTI4eDEyOC5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#151e32', 900: '#0f172a' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards', 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "canvas-confetti": "https://esm.sh/canvas-confetti@1.6.0",
            "html2canvas": "https://esm.sh/html2canvas@1.4.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }
        .light-mode {
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
        }
        
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; transition: background-color 0.3s, color 0.3s; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glow-text { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .ticket-edge { mask-image: radial-gradient(circle at center, transparent 10px, black 11px); mask-position: -10px 50%; mask-size: 100% 200%; mask-repeat: no-repeat; }
        /* Markdown-like link style */
        .desc-link { color: #60a5fa; text-decoration: underline; text-underline-offset: 2px; }
        .hp-bar-container { background: var(--bg-input); border-radius: 4px; height: 12px; overflow: hidden; border: 1px solid var(--border-color); }
        .hp-bar-fill { height: 100%; transition: width 0.5s ease-out, background-color 0.3s; }
        .stamp-mark {
            border: 3px double currentColor;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            transform: rotate(-15deg);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            mask-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.5'/%3E%3C/svg%3E");
            mask-mode: alpha;
        }
        .guild-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #fbbf24;
            position: relative;
            overflow: hidden;
        }
        .light-mode .guild-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 2px solid #d97706;
        }
        .guild-card::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 60%);
            animation: shine 10s infinite linear;
        }
        @keyframes shine { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Drag and Drop Styling */
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .drag-over { border-top: 2px solid #fbbf24; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import confetti from 'canvas-confetti';
        import html2canvas from 'html2canvas';
        import { 
            Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, 
            Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
            Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Thermometer,
            TrendingUp, Save, Clock, Map, PieChart, Volume2, Image as ImageIcon, Navigation, Timer, Bus, Car, Ticket,
            Compass, Search, ArrowRightLeft, Landmark, LogOut, User, Star, Check, FileText, CreditCard, Wallet, Users,
            CloudRain, CloudSun, Sun, Share2, Copy, RotateCcw, ScanLine, Calculator, Link as LinkIcon, WifiOff,
            Umbrella, Wind, Snowflake, Flame, Activity, Banknote, HelpCircle, Mic, Plus, Award, Filter, CheckCircle2,
            Crown, QrCode, SunMoon, GripVertical, Download, Settings, Key
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, enableIndexedDbPersistence } from 'firebase/firestore';

        // --- CONFIGURATION ---
        // Ê≥®ÊÑèÔºöÂÖ¨ÈñãÊ≠§Ê™îÊ°àÂèØËÉΩÊúÉÊö¥Èú≤ÊÇ®ÁöÑ API Key„ÄÇÂª∫Ë≠∞Âú®Ê≠£ÂºèÁí∞Â¢É‰∏≠ÈôêÂà∂ API Key ÁöÑ‰æÜÊ∫êÁ∂≤Âüü„ÄÇ
        const USE_REAL_GOOGLE_AUTH = true; 
        const userFirebaseConfig = {
            apiKey: "AIzaSyDuVNALTfclUEXxhlDEolTLX_68mkyW59k",
            authDomain: "rpg-travel-app.firebaseapp.com",
            projectId: "rpg-travel-app",
            storageBucket: "rpg-travel-app.firebasestorage.app",
            messagingSenderId: "120243575408",
            appId: "1:120243575408:web:eb941d7a7af5cd65ecf2b5",
            measurementId: "G-0ZSW6HSN2S"
        };

        const systemConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = (systemConfig) ? systemConfig : userFirebaseConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error:", e); }

        const AppContext = createContext();

        // --- Constants & Helpers ---
        const ICON_MAP = { Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle, Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Save, Clock, Map, PieChart, Volume2, ImageIcon, Navigation, Timer, Bus, Car, Ticket, Compass, Search, ArrowRightLeft, Landmark, Star, CreditCard, Wallet, Users, CloudRain, CloudSun, Sun, RotateCcw };
        
        const EXPENSE_ICONS = {
            loot: Utensils,
            travel: Train,
            save: Home,
            trade: ShoppingBag,
            other: HelpCircle
        };

        const SPELL_DATA = [ 
            { icon: "üßÖ", title: "È©ÖÈô§Ëî•Ëä±", jp: "„Éç„ÇÆÊäú„Åç„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ã‰∏çË¶ÅÂä†Ëî•", romaji: "Negi nuki de onegaishimasu", type: "defense" }, 
            { icon: "üßä", title: "ÂéªÂÜ∞Âíí", jp: "Ê∞∑„Å™„Åó„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÂéªÂÜ∞", romaji: "Koori nashi de onegaishimasu", type: "defense" }, 
            { icon: "üíß", title: "Âè¨ÂñöÊ∞¥", jp: "„ÅäÊ∞¥„Åè„Å†„Åï„ÅÑ", zh: "Ë´ãÁµ¶ÊàëÊ∞¥", romaji: "Omizu kudasai", type: "support" }, 
            { icon: "üöª", title: "Â∞ãÊâæÂØÜÂÆ§", jp: "„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", zh: "ÂªÅÊâÄÂú®Âì™Ë£°", romaji: "Toire wa doko desu ka?", type: "exploration" }, 
            { icon: "üßæ", title: "ÁµêÁÆóÂç∑Ëª∏", jp: "„Åä‰ºöË®à„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÁµêÂ∏≥", romaji: "Okaikei onegaishimasu", type: "interaction" }, 
            { icon: "üì∏", title: "ÊîùÈ≠ÇË°ì", jp: "ÂÜôÁúü„ÇíÊíÆ„Å£„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü", zh: "ÂèØ‰ª•ÊãçÁÖßÂóéÔºü", romaji: "Shashin o totte mo ii desu ka?", type: "interaction" }, 
            { icon: "üôè", title: "Á•àÊ±ÇË°ì", jp: "„Åì„Çå„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "ÊàëË¶ÅÈÄôÂÄã (ÊåáËèúÂñÆ)", romaji: "Kore o onegaishimasu", type: "interaction" }, 
            { icon: "ü•°", title: "Â∏∂Ëµ∞Ë°ì", jp: "ÊåÅ„Å°Â∏∞„Çä„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÂπ´ÊàëÂ§ñÂ∏∂", romaji: "Mochikaeri de onegaishimasu", type: "support" } 
        ];
        
        const GUIDE_DETAILS = [ 
            { id: 'nagoya_castle', title: 'ÂêçÂè§Â±ãÂüé', subtitle: 'ÈáëÈØ±ÈñÉËÄÄÁöÑÂ∞æÂºµÂæ∑Â∑ùÂÆ∂Â±ÖÂüé', tags: ['Ê≠∑Âè≤', 'È¢®ÊôØ', 'ÁôæÂ§ßÂêçÂüé'], image: 'üèØ', desc: 'Êó•Êú¨‰∏âÂêçÂüé‰πã‰∏ÄÔºåÂ±ãÈ†Ç‰∏äÁöÑÈáëÈØ±ÊòØÂêçÂè§Â±ãÁöÑË±°Âæµ„ÄÇ', content: { history: 'Áî±Âæ∑Â∑ùÂÆ∂Â∫∑Êñº1612Âπ¥Âª∫ÈÄ†Ôºå‰ΩúÁÇ∫Â∞æÂºµÂæ∑Â∑ùÂÆ∂ÁöÑÂ±ÖÂüé„ÄÇ', features: '„ÄêÊú¨‰∏∏Âæ°ÊÆø„ÄëÂÖßÈÉ®ÈáëÁ¢ßËºùÁÖåÔºåÂ±èÈ¢®Áï´‰Ωú‰ª§‰∫∫ÂòÜÁÇ∫ËßÄÊ≠¢„ÄÇ', tips: 'Êé®Ëñ¶ÂèÉËßÄ‰∫å‰πã‰∏∏Â∫≠ÂúíÔºåÊàñÂú®ÂüéÂÖßÈÅáË¶ã„ÄåÂêçÂè§Â±ãÊ¨æÂæÖÊ≠¶Â∞áÈöä„Äç„ÄÇ', warning: 'Â§©ÂÆàÈñ£ÁõÆÂâçÂõ†ËÄêÈúáÂ∑•Á®ãÈñâÈ§®‰∏≠ÔºåÂÉÖËÉΩÂèÉËßÄÊú¨‰∏∏Âæ°ÊÆø„ÄÇ' } }, 
            { id: 'atsuta', title: 'ÁÜ±Áî∞Á•ûÂÆÆ', subtitle: 'ÂøÉÈùàÂØÑË®óÂçÉÂπ¥Âè§Ââé', tags: ['Ê≠∑Âè≤', 'È¢®ÊôØ', 'Á•ûÁ§æ'], image: '‚õ©Ô∏è', desc: '‰æõÂ•â‰∏âÁ•ûÂô®‰πã‰∏Ä„ÄåËçâËñôÂäç„ÄçÔºåÂú∞‰ΩçÂÉÖÊ¨°Êñº‰ºäÂã¢Á•ûÂÆÆ„ÄÇ', content: { history: 'ÊìÅÊúâËøëÂÖ©ÂçÉÂπ¥Ê≠∑Âè≤ÔºåÁπîÁî∞‰ø°Èï∑Âá∫ÂæÅÊ°∂ÁãπÈñìÂâçÊõæÂú®Ê≠§Á•àÈ°ò„ÄÇ', features: 'ËëóÂêçÁöÑ„Äå‰ø°Èï∑Â£Å„ÄçËàáÊ®πÈΩ°ÂçÉÂπ¥ÁöÑ„ÄåÂ§ßÊ•†„Äç„ÄÇ', tips: 'Â¢ÉÂÖßÁöÑ„ÄåÂÆÆÂêâÈ∫µ„ÄçÊúâÁæéÂë≥ÁöÑÁ¢ÅÂ≠êÈ∫µÔºõÂà•Âøò‰∫ÜÂéª„ÄåÊ∏ÖÊ∞¥Á§æ„ÄçÊ¥óÁúºÁ•àÊ±ÇÁæéËÇå„ÄÇ', warning: 'Â§èÂ≠£ËöäËü≤ËºÉÂ§öÔºåÂª∫Ë≠∞Âô¥Èò≤ËöäÊ∂≤„ÄÇ' } }, 
            { id: 'inuyama', title: 'Áä¨Â±±Âüé', subtitle: 'ÂúãÂØ∂‰∫îÂüé‰πã‰∏Ä', tags: ['Ê≠∑Âè≤', 'È¢®ÊôØ', 'ÂúãÂØ∂'], image: 'üè∞', desc: 'Êó•Êú¨ÁèæÂ≠òÊúÄÂè§ËÄÅÁöÑÊú®ÈÄ†Â§©ÂÆàÈñ£Ôºå‰ΩçÊñºÊú®Êé®Â∑ùÁïîÁöÑÂ∞èÂ±±‰∏ò‰∏ä„ÄÇ', content: { history: 'ÁπîÁî∞‰ø°Â∫∑Êñº1537Âπ¥Âª∫ÈÄ†ÔºåÊõæÊòØÊàêÁÄ®ÂÆ∂ÁöÑÁßÅ‰∫∫ÂüéÂ†°„ÄÇ', features: 'Â§©ÂÆàÈñ£Ë¶ñÈáéÊ•µ‰Ω≥ÔºåÂèØ‰øØÁû∞Êú®ÊõæÂ∑ùÂÖ®ÊôØ„ÄÇ', tips: 'Â±±‰∏ãÁöÑ‰∏âÂÖâÁ®ªËç∑Á•ûÁ§æÊúâÁ≤âÁ¥ÖÊÑõÂøÉÁπ™È¶¨ÔºåÊ±ÇÂßªÁ∑£Ë∂ÖÈùàÈ©ó„ÄÇ', warning: 'Â§©ÂÆàÈñ£Ê®ìÊ¢ØÈùûÂ∏∏Èô°Â≥≠ÔºàÁ¥Ñ50Â∫¶ÔºâÔºåÂª∫Ë≠∞Á©øËëóË§≤Ë£ùËàáÂ•ΩËµ∞ÁöÑÈûã„ÄÇ' } },
            { id: 'toyota_museum', title: 'Ë±êÁî∞Áî¢Ê•≠ÊäÄË°ìÁ¥ÄÂøµÈ§®', subtitle: 'Ë¶ãË≠âÊó•Êú¨Ë£ΩÈÄ†Ê•≠ÁöÑËµ∑Èªû', tags: ['Ê≠∑Âè≤', 'ÂÆ§ÂÖß', 'Ë¶ãÂ≠∏'], image: 'üè≠', desc: 'Âà©Áî®Ë±êÁî∞Ëá™ÂãïÁπîÊ©üË£Ω‰ΩúÊâÄËàäÂª†ÊàøÊîπÂª∫ÔºåÂ±ïÁ§∫Á¥°ÁπîÂà∞Ê±ΩËªäÁöÑÈÄ≤ÂåñÂè≤„ÄÇ', content: { history: 'ÈÄôË£°ÊòØË±êÁî∞ÈõÜÂúòÁöÑÁôºÁ••Âú∞Ôºå‰øùÁïô‰∫ÜÁ¥ÖÁ£öÂª†ÊàøÂª∫ÁØâ„ÄÇ', features: 'Ê±ΩËªäÈ§®Â±ïÁ§∫‰∫ÜÊ≠∑‰ª£Á∂ìÂÖ∏ËªäÊ¨æËàáÁîüÁî¢Á∑öÈÅã‰ΩúÊºîÁ§∫„ÄÇ', tips: 'ÈñÄÁ•®ÂÉÖ ¬•500ÔºåCPÂÄºÊ•µÈ´òÔºåÈùûÂ∏∏ÈÅ©ÂêàÈõ®Â§©ÂÇôÊ°à„ÄÇ', warning: 'Â±ïÈ§®ÂæàÂ§ßÔºåË™çÁúüÈÄõÈúÄË¶Å 2-3 Â∞èÊôÇ„ÄÇ' } },
            { id: 'osu', title: 'Â§ßÈ†àÂïÜÂ∫óË°ó', subtitle: 'Ê∑∑Êê≠ÊñáÂåñÁôºÊ∫êÂú∞', tags: ['Ë≥ºÁâ©', 'ÁæéÈ£ü', 'Ê≠∑Âè≤'], image: 'üõçÔ∏è', desc: 'ËûçÂêàÂè§Ëëó„ÄÅÂãïÊº´„ÄÅÁï∞ÂúãÊñôÁêÜËàáÂÇ≥Áµ±ÂØ∫ÂªüÁöÑÊ¥ªÂäõÂïÜÂ∫óË°ó„ÄÇ', content: { history: 'Áî±Â§ßÈ†àËßÄÈü≥ÁöÑÈñÄÂâçÁî∫ÁôºÂ±ïËÄå‰æÜÔºåÊúâ400Â§öÂπ¥Ê≠∑Âè≤„ÄÇ', features: 'Ë∂ÖÈÅé1200ÂÆ∂Â∫óÈã™ÔºåÂåÖÂê´ Alice on Wednesday Á≠âÁâπËâ≤Â∫ó„ÄÇ', tips: 'ÂøÖÂêÉÔºöÊùéÂÖàÁîüÁöÑÂè∞ÁÅ£ÂêçÁâ©ÁÇ∏Èõû„ÄÅÁ¥çÂ±ãÊ©ãÈ•ÖÈ†≠„ÄÇÊØèÂÄãÊúà18Êó•/28Êó•ÊúâÂè§Ëë£Â∏ÇÈõÜ„ÄÇ', warning: 'ÁØÑÂúçÂæàÂ§ß‰∏îÂ∑∑ÂºÑË§áÈõúÔºåÂÆπÊòìËø∑Ë∑ØÔºåÂª∫Ë≠∞ÂÖàÁúãÂ•ΩÂú∞Âúñ„ÄÇ' } }, 
            { id: 'sakae', title: 'Ê¶Æ / Á∂†Ê¥≤21', subtitle: 'ÂêçÂè§Â±ãÊôÇÂ∞ö‰∏≠ÂøÉ', tags: ['Ë≥ºÁâ©', 'È¢®ÊôØ', 'Â§úÊôØ'], image: 'üåÉ', desc: 'ÁôæË≤®ÂÖ¨Âè∏ÊûóÁ´ãÁöÑÁπÅËèØË°óÔºåÁ∂†Ê¥≤21ÁöÑÊ∞¥‰πãÂÆáÂÆôËàπÊòØÂøÖÊãçÂú∞Ê®ô„ÄÇ', content: { history: 'ÂêçÂè§Â±ãÊúÄÂÖ∑‰ª£Ë°®ÊÄßÁöÑÁèæ‰ª£ÂåñÂïÜÂúà„ÄÇ', features: 'Á∂†Ê¥≤21È†ÇÂ±§ÁöÑÈÄèÊòéÊ∞¥Ê±†Â±ãÈ†ÇÔºåÊôö‰∏äÊâìÁáàÈùûÂ∏∏Â§¢Âπª„ÄÇ', tips: 'ÊóÅÈÇäÂ∞±ÊòØÂêçÂè§Â±ãÈõªË¶ñÂ°îÔºà‰∏≠ÈÉ®ÈõªÂäõ MIRAI TOWERÔºâÔºåÂèØÈ†ÜÈÅìÂèÉËßÄ„ÄÇ', warning: 'Á∂†Ê¥≤21È†ÇÂ±§Âú∞ÊùøËºÉÊªëÔºå‰∏îÊôö‰∏äÈ¢®Â§ßÔºåË´ãÊ≥®ÊÑèÂÆâÂÖ®„ÄÇ' } },
            { id: 'jr_gate_tower', title: 'JR Gate Tower', subtitle: 'ËªäÁ´ôÁõ¥ÁµêË≥ºÁâ©Â§©Â†Ç', tags: ['Ë≥ºÁâ©', 'ÁæéÈ£ü', 'ÂÆ§ÂÖß'], image: 'üè¢', desc: 'ËàáÂêçÂè§Â±ãËªäÁ´ôÂÖ±ÊßãÁöÑÂ∑®Â§ßË≥ºÁâ©‰∏≠ÂøÉÔºåBic Camera„ÄÅUniqlo ÊóóËâ¶Â∫óÈÉΩÂú®ÈÄô„ÄÇ', content: { history: '2017Âπ¥ÂÖ®Èù¢ÈñãÂπïÔºåÊòØÂêçÂè§Â±ãÁ´ôÂë®ÈÇäÂÜçÈñãÁôºÁöÑÊ†∏ÂøÉ„ÄÇ', features: 'ÊìÅÊúâÊó•Êú¨ÊúÄÈ´òÁöÑÊòüÂ∑¥ÂÖãÔºà15FÔºâËàáÊï¥Â±§ÁöÑÂêâÂçúÂäõÂÖ±ÂíåÂúã„ÄÇ', tips: '12-13Ê®ìÁöÑÁæéÈ£üË°óÂåØÈõÜ‰∫ÜÊâÄÊúâÂêçÂè§Â±ãÂêçÁâ©Ôºå‰∏çÁî®Êù±Â•îË•øË∑ë„ÄÇ', warning: 'ÈÄ±Êú´‰∫∫ÊΩÆÊ¥∂ÊπßÔºåÈ§êÂª≥Âª∫Ë≠∞ÈÅøÈñãÂ∞ñÂ≥∞ÊôÇÊÆµ„ÄÇ' } },
            { id: 'noritake_garden', title: 'AEON Mall Noritake Garden', subtitle: 'Ê£ÆÊûóÁ≥ªÊúÄÁæéÊõ∏Â∫ó', tags: ['Ë≥ºÁâ©', 'È¢®ÊôØ', 'ÂÆ§ÂÖß'], image: 'üìö', desc: 'ÁµêÂêà‰∫ÜÂâáÊ≠¶‰πãÊ£ÆÁì∑Âô®ÂçöÁâ©È§®ËàáÁèæ‰ª£Ë≥ºÁâ©‰∏≠ÂøÉÁöÑË§áÂêàË®≠ÊñΩ„ÄÇ', content: { history: 'ÂéüÁÇ∫‰∏ñÁïåÁü•ÂêçÁì∑Âô®ÂìÅÁâå Noritake ÁöÑÂ∑•Âª†ËàäÂùÄ„ÄÇ', features: 'Ëî¶Â±ãÊõ∏Â∫óÁöÑÂ∑®ÂûãÊõ∏ÁâÜÊòØÁÜ±ÈñÄÊâìÂç°Èªû„ÄÇ', tips: 'Ë∑ùÈõ¢ÂêçÂè§Â±ãÁ´ôÊ≠•Ë°åÁ¥Ñ 15 ÂàÜÈêòÔºåÂª∫Ë≠∞Êê≠ÂÖ¨ËªäÊàñË®àÁ®ãËªä„ÄÇ', warning: 'Êõ∏Â∫óÂÖßÊãçÁÖßË´ã‰øùÊåÅÂÆâÈùúÔºå‰∏çË¶ÅÊâìÊìæÈñ±ËÆÄËÄÖ„ÄÇ' } },
            { id: 'yabaton', title: 'Áü¢Â†¥Âë≥ÂôåË±¨Êéí', subtitle: 'ÂêçÂè§Â±ãÂøÖÂêÉÈùàÈ≠ÇÁæéÈ£ü', tags: ['ÁæéÈ£ü', 'Ê≠∑Âè≤'], image: 'üê∑', desc: 'ÊøÉÈÉÅÁöÑËµ§Âë≥ÂôåÈÜ¨Ê±ÅÊ∑ãÂú®ÂâõÁÇ∏Â•ΩÁöÑË±¨Êéí‰∏äÔºåÈ¶ôÊ∞£ÈÄº‰∫∫„ÄÇ', content: { history: 'ÂâµÊ•≠Êñº 1947 Âπ¥ÔºåÊòØÂë≥ÂôåË±¨ÊéíÁöÑ‰ª£ÂêçË©û„ÄÇ', features: 'Êé®Ëñ¶„ÄåÈêµÊùøÂë≥ÂôåË±¨Êéí„ÄçÔºå‰∏äÊ°åÊôÇÈÜ¨Ê±ÅÊªãÊªã‰ΩúÈüø„ÄÇ', tips: 'Êú¨Â∫óÂú®Áü¢Â†¥Áî∫ÔºåËã•‰∏çÊÉ≥ÊéíÈöäÂèØÂéªÁôæË≤®ÂÖ¨Âè∏ÂàÜÂ∫ó„ÄÇ', warning: 'Âè£Âë≥ÂÅèÈáçÈππÁîúÔºåÂª∫Ë≠∞Êê≠ÈÖçÂ§ßÈáèÈ´òÈ∫óËèúÁµ≤ÊàñÁôΩÈ£Ø„ÄÇ' } },
            { id: 'houraiken', title: 'ÁÜ±Áî∞Ëì¨ËêäËªí', subtitle: 'È∞ªÈ≠öÈ£Ø‰∏âÂêÉÁôºÊ∫êÂú∞', tags: ['ÁæéÈ£ü', 'Ê≠∑Âè≤'], image: 'üç±', desc: 'ÊéíÈöä‰πüË¶ÅÂêÉÁöÑÂÇ≥Â•áÈ∞ªÈ≠öÈ£ØÔºåÁÇ≠ÁÅ´È¶ôÊ∞£ÂçÅË∂≥„ÄÇ', content: { history: 'ÂâµÁ´ãÊñºÊòéÊ≤ª 6 Âπ¥Ôºà1873Âπ¥ÔºâÔºåË®ªÂÜä‰∫Ü„Äå„Å≤„Å§„Åæ„Å∂„Åó„ÄçÂïÜÊ®ô„ÄÇ', features: 'Áç®ÁâπÁöÑ‰∏âÁ®ÆÂêÉÊ≥ïÔºöÂéüÂë≥„ÄÅÂä†‰ΩêÊñôÔºàÊµ∑Ëãî/Ëî•/Ëä•Êú´Ôºâ„ÄÅËå∂Ê≥°È£Ø„ÄÇ', tips: 'Êú¨Â∫óËàáÁ•ûÂÆÆÂ∫óÈÄöÂ∏∏Ë¶ÅÊéí 1-2 Â∞èÊôÇÔºåÂª∫Ë≠∞‰∏ÄÈñãÂ∫óÂ∞±ÂéªÊäΩÊï¥ÁêÜÂà∏„ÄÇ', warning: 'ÂÉπÊ†ºËºÉÈ´òÔºàÁ¥Ñ ¬•4,600 Ëµ∑ÔºâÔºå‰ΩÜÁµïÂ∞çÁâ©ÊúâÊâÄÂÄº„ÄÇ' } },
            { id: 'komeda', title: 'Komeda\'s Coffee', subtitle: 'ÂêçÂè§Â±ãÊó©È§êÊñáÂåñ', tags: ['ÁæéÈ£ü', 'ÂÆ§ÂÖß'], image: '‚òï', desc: '„ÄåÈªûÈ£≤ÊñôÈÄÅÊó©È§ê„ÄçÁöÑÁôºÊ∫êÂú∞ÔºåÈ´îÈ©óÂú®Âú∞‰∫∫ÁöÑÊó©Êô®„ÄÇ', content: { history: '1968 Âπ¥ÁôºÊ∫êÊñºÂêçÂè§Â±ãÔºåÁèæÂú®ÂÖ®Êó•Êú¨ÈÉΩÊúâÂàÜÂ∫ó„ÄÇ', features: 'Êó©‰∏ä 11 ÈªûÂâçÈªûÈ£≤ÊñôÔºåÂÖçË≤ªÈÄÅÂéöÁâáÂêêÂè∏ÈÖçÊ∞¥ÁÖÆËõã/Á¥ÖË±ÜÊ≥•„ÄÇ', tips: 'ÂøÖÈªû„ÄåÂÜ∞ËàáÁÅ´ÔºàShiro-NoirÔºâ„ÄçÔºöÁÜ±‰∏πÈ∫•È∫µÂåÖ‰∏äÊúâÂÜ∞Ê∑áÊ∑ã„ÄÇ', warning: 'ÂÅáÊó•Êó©‰∏äÈÄöÂ∏∏ÈúÄË¶ÅÊéíÈöäÁ≠âÂÄôÂÖ•Â∫ß„ÄÇ' } },
            { id: 'yamachan', title: '‰∏ñÁïå‰πãÂ±±Â∞á', subtitle: 'Â§¢ÂπªÊâãÁæΩÂÖàÔºàÁÇ∏ÈõûÁøÖÔºâ', tags: ['ÁæéÈ£ü', 'Â§úÊôØ'], image: 'üçó', desc: 'ËÉ°Ê§íÂë≥Âº∑ÁÉàÁöÑÁÇ∏ÈõûÁøÖÔºåÊòØÂêçÂè§Â±ãÂ§úÊôöÁöÑÊúÄ‰Ω≥‰∏ãÈÖíËèú„ÄÇ', content: { history: 'Âæû‰∏ÄÂÆ∂Â∞èÂ±ÖÈÖíÂ±ãËµ∑ÂÆ∂ÔºåÁèæÂú®ÊòØÂêçÂè§Â±ãÁöÑÂÆµÂ§ú‰ª£ÂêçË©û„ÄÇ', features: 'ÈõûÁøÖÁÇ∏ÂæóÈÖ•ËÑÜÔºåËÉ°Ê§íËæõËæ£Âë≥ËÆì‰∫∫‰∏ÄÊîØÊé•‰∏ÄÊîØ„ÄÇ', tips: 'ÂêÉÊ≥ïÊúâÊäÄÂ∑ßÔºöÊâ≠ÈñãÈóúÁØÄÔºå‰∏ÄÂè£Â∞áËÇâÊªëÂá∫„ÄÇ', warning: 'ËÉ°Ê§íÂë≥ÁúüÁöÑÂæàÈáçÔºå‰∏çÂêÉËæ£ÁöÑ‰∫∫ÂèØËÉΩË¶ÅÈªû„ÄåÂ∞ëËÉ°Ê§í„Äç„ÄÇ' } },
            { id: 'port_aquarium', title: 'ÂêçÂè§Â±ãÊ∏ØÊ∞¥ÊóèÈ§®', subtitle: 'Êó•Êú¨ÊúÄÂ§ßÁ¥öÊ∞¥ÊóèÈ§®', tags: ['È¢®ÊôØ', 'ÂÆ§ÂÖß', 'Ë¶™Â≠ê'], image: 'üê¨', desc: 'ÊìÅÊúâÂ£ØËßÄÁöÑÊµ∑Ë±öË°®ÊºîËàáÂèØÊÑõÁöÑËôéÈØ®„ÄÅÂ∞èÁôΩÈØ®„ÄÇ', content: { history: '‰ΩçÊñºÂêçÂè§Â±ãÊ∏ØËä±ÂúíÁ¢ºÈ†≠ÔºåÂàÜÁÇ∫ÂåóÈ§®ËàáÂçóÈ§®„ÄÇ', features: 'ÂåóÈ§®‰∏ªÊâìÈØ®Ë±öÔºåÂçóÈ§®Â±ïÁ§∫ÂçóÊ•µËá≥Ëµ§ÈÅìÁöÑÊµ∑Ê¥ãÁîüÊÖã„ÄÇ', tips: 'Ê≤ô‰∏ÅÈ≠öÈæçÊç≤È¢®È§µÈ£üÁßÄÈùûÂ∏∏Â£ØËßÄÔºåÂãôÂøÖÁ¢∫Ë™çÊôÇÂàªË°®„ÄÇ', warning: 'Êµ∑Ë±öË°®ÊºîÂ†¥Âú∞Âú®Êà∂Â§ñÔºåÂ§èÂ§©Ë´ãÊ≥®ÊÑèÈò≤Êõ¨„ÄÇ' } },
            { id: 'higashiyama', title: 'Êù±Â±±ÂãïÊ§çÁâ©Âúí', subtitle: 'ÂûãÁî∑Â§ßÁå©Áå©ÁöÑÂÆ∂', tags: ['È¢®ÊôØ', 'Ë¶™Â≠ê'], image: 'ü¶ç', desc: 'ÂúíÂçÄÊ•µÂ§ßÔºåÂåÖÂê´ÂãïÁâ©Âúí„ÄÅÊ§çÁâ©ÂúíËàáÈÅäÊ®ÇÂúíÔºåCPÂÄºË∂ÖÈ´ò„ÄÇ', content: { history: '1937Âπ¥ÈñãÂúíÔºåÊòØÊó•Êú¨Âπ¥ÈÅäÂÆ¢Êï∏Á¨¨‰∫åÂ§öÁöÑÂãïÁâ©Âúí„ÄÇ', features: 'ÊòéÊòüÂãïÁâ©„ÄåÂ§èÂ∑¥Â∞º„ÄçÂ§ßÁå©Áå©‰ª•Â∏•Ê∞£Â§ñË°®ËÅûÂêç„ÄÇ', tips: 'ÂúíÂÖßÁöÑ„ÄåÊù±Â±±Â§©Á©∫Â°î„ÄçÂèØ‰ª•Áú∫ÊúõÂêçÂè§Â±ãÂ∏ÇÊôØ„ÄÇ', warning: 'ÂúíÂçÄÈùûÂ∏∏Â§ß‰∏îÊúâÂù°Â∫¶ÔºåË´ãÁ©øÂ•ΩËµ∞ÁöÑÈûãÂ≠ê„ÄÇ' } },
            { id: 'legoland', title: 'Ê®ÇÈ´òÊ®ÇÂúí', subtitle: 'Ëâ≤ÂΩ©ÁπΩÁ¥õÁöÑÁ©çÊú®ÁéãÂúã', tags: ['È¢®ÊôØ', 'Ë¶™Â≠ê', 'ÈÅäÊ®ÇÂúí'], image: 'üß±', desc: 'ÈÅ©Âêà 2-12 Ê≠≤ÂÖíÁ´•ÁöÑÊà∂Â§ñ‰∏ªÈ°åÊ®ÇÂúíÔºåÂÖÖÊªøÊ®ÇÈ´òÂÖÉÁ¥†„ÄÇ', content: { history: '2017Âπ¥ÈñãÂπïÔºåÊó•Êú¨ÂîØ‰∏ÄÁöÑÊ®ÇÈ´òÊ®ÇÂúí„ÄÇ', features: 'Miniland Áî®Ê®ÇÈ´òÁ©çÊú®Á•ûÈÇÑÂéüÊó•Êú¨ÂêÑÂú∞ÂêçÂãù„ÄÇ', tips: 'Â¶ÇÊûúÂñúÊ≠°Ê∞¥ÊóèÈ§®ÔºåÂèØ‰ª•Ë≤∑ Sea Life ÁöÑÂ•óÁ•®„ÄÇ', warning: 'Êàê‰∫∫Á•®ÂÉπËºÉÈ´òÔºåÂª∫Ë≠∞ÊèêÂâç‰∏äÁ∂≤Ë≤∑Êó©È≥•Á•®„ÄÇ' } }
        ];
        
        const INITIAL_CHECKLIST = [ { id: 1, text: "Ë≠∑ÁÖß", checked: false }, { id: 2, text: "Á∂≤Âç°/Êº´ÈÅä", checked: false }, { id: 3, text: "Êó•Âπ£ÁèæÈáë", checked: false }, { id: 4, text: "Ë°åÂãïÈõªÊ∫ê", checked: false }, { id: 5, text: "Â∏∏Áî®Ëó•ÂìÅ", checked: false }, { id: 6, text: "VJWÊà™Âúñ", checked: false } ];
        const INITIAL_EXPENSES = [ { id: 1, item: "Ê©üÁ•®È†ê‰ªò", cost: 12000, type: "travel", date: "2025-10-15", method: "card", payer: "me" }, { id: 2, item: "‰ΩèÂÆøÈ†êË®Ç", cost: 8000, type: "save", date: "2025-11-20", method: "card", payer: "me" } ];
        const INITIAL_QUEST_DATA = [
            {
                day: 0,
                title: "Â∫èÁ´†: ÈôçËêΩËàáÊΩõÂÖ•",
                date: "2026-03-02",
                events: [
                { id: 'e0', time: "16:45", icon: "Plane", title: "ÂïüÁ®ã: Ê°ÉÂúíÊ©üÂ†¥", desc: "Êê≠‰πòËôéËà™ IT778 (16:45-20:25)", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e1', time: "20:25", icon: "MapPin", title: "ÊäµÈÅîÊñ∞Âú∞Âúñ", desc: "‰∏≠ÈÉ®ÂúãÈöõÊ©üÂ†¥ T2", type: "checkpoint", transportTime: "3h 40m", transportCost: 0, transportMode: "Plane", completed: false },
                { id: 'e2', time: "21:15", icon: "Footprints", title: "Á©øË∂äÈÄöÈÅì", desc: "ÂâçÂæÄ‰∫§ÈÄöÂª£Â†¥", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e3', time: "21:37", icon: "Train", title: "Êê≠‰πòÂêçÈêµÁâπÊÄ•", desc: "ÂæÄÂêçÂè§Â±ã/Â≤êÈòúÊñπÂêë", type: "travel", transportTime: "10m", transportCost: 1250, transportMode: "Train", completed: false },
                { id: 'e4', time: "22:08", icon: "MapPin", title: "ÊäµÈÅîÈáëÂ±±Á´ô", desc: "ÈóúÈçµËΩâ‰πòÈªû", type: "checkpoint", transportTime: "31m", transportCost: 0, transportMode: "Train", completed: false },
                { id: 'e5', time: "22:23", icon: "Train", title: "ËΩâ‰πòÂú∞‰∏ãÈêµ", desc: "ÂêçÂüéÁ∑ö (Âè≥Áí∞)", type: "travel", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e6', time: "22:40", icon: "Home", title: "Â≠òÊ™îÈªû: Trip & Sleep", desc: "Ëæ¶ÁêÜÂÖ•‰Ωè", type: "save", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                ]
            },
            {
                day: 1,
                title: "Á¨¨‰∏ÄÁ´†: Â∏ÇÂ†¥ËàáÁ•ûÊÆø",
                date: "2026-03-03",
                events: [
                { id: 'e11', time: "08:00", icon: "Home", title: "ÂÜíÈö™ÈñãÂßã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e12', time: "08:45", icon: "Utensils", title: "Êü≥Ê©ã‰∏≠Â§ÆÂ∏ÇÂ†¥", desc: "Ë£úÁµ¶: ÁîüÈ≠öÁâá„ÄÅÊµ∑ÈÆÆÂ∑°Á¶Æ", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e12_5', time: "10:15", icon: "ShoppingBag", title: "JR Gate Tower", desc: "ÂêâÂçúÂäõÂÖ±ÂíåÂúã(1F)„ÄÅBicCamera(9F)„ÄÅUniqlo", type: "trade", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e13', time: "12:00", icon: "Utensils", title: "ÂçàÈ§ê: È≥•ÈñãÁ∑èÊú¨ÂÆ∂", desc: "Áç≤ÂæóÁâ©ÂìÅ: ÈáëË≥ûË¶™Â≠ê‰∏º (‰ΩçÊñº Gate Tower 12F)", type: "loot", transportTime: "0m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e14', time: "13:30", icon: "ShoppingBag", title: "Â§ßÈ†àÂïÜÂ∫óË°ó", desc: "‰∫§ÊòìËàáÊé¢Á¥¢ (Á¥Ñ2Â∞èÊôÇ)", type: "action", transportTime: "20m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e15', time: "15:30", icon: "Coffee", title: "‰∏ãÂçàËå∂: Konparu", desc: "Ë£úÁµ¶: ÁÇ∏Ëù¶‰∏âÊòéÊ≤ª", type: "heal", transportTime: "5m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e16', time: "18:30", icon: "Utensils", title: "ÊôöÈ§ê: ÁÜ±Áî∞Ëì¨ËêäËªí", desc: "ÊåëÊà∞ÂÇ≥Ë™™ÁæéÈ£ü: È∞ªÈ≠öÈ£Ø‰∏âÂêÉ https://www.houraiken.com/", type: "boss", transportTime: "30m", transportCost: 270, transportMode: "Train", completed: false },
                { id: 'e17', time: "20:30", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "40m", transportCost: 270, transportMode: "Train", completed: false },
                ]
            },
            {
                day: 2,
                title: "Á¨¨‰∫åÁ´†: Âè§ÂüéËàáÂíñÂï°",
                date: "2026-03-04",
                events: [
                { id: 'e20', time: "07:45", icon: "Home", title: "Êó©ÂÆâÂêçÂè§Â±ã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e21', time: "08:00", icon: "Coffee", title: "Êó©È§ê: Bucyo Coffee", desc: "Ë£úÁµ¶: Â∞èÂÄâÁ¥ÖË±ÜÂêêÂè∏", type: "heal", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e22', time: "10:00", icon: "MapPin", title: "Áä¨Â±±ÂüéÊîªÁï•", desc: "ÂúãÂØ∂Â§©ÂÆàÈñ£ (ÈñÄÁ•® ¬•550)", type: "dungeon", transportTime: "50m", transportCost: 600, transportMode: "Train", completed: false },
                { id: 'e23', time: "12:30", icon: "Utensils", title: "ÂçàÈ§ê: Sakura Chaya", desc: "Áç≤ÂæóÁâ©ÂìÅ: Áî∞Ê®ÇÁÉ§Ë±ÜËÖê‰∏≤", type: "loot", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e24', time: "15:00", icon: "Coffee", title: "GOLPIE COFFEE", desc: "Â∑ùÂêçÂ±±ÂÜ†ËªçÂíñÂï°Â∑°Á¶Æ", type: "action", transportTime: "1h 20m", transportCost: 800, transportMode: "Train", completed: false },
                { id: 'e25', time: "18:00", icon: "Utensils", title: "Solo Pizza", desc: "Â§ßÈ†àÊú¨Â∫ó (‰∏ñÁïåÂÜ†ËªçÊä´Ëñ©)", type: "loot", transportTime: "30m", transportCost: 240, transportMode: "Train", completed: false },
                { id: 'e26', time: "20:00", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                ]
            },
            {
                day: 3,
                title: "Á¨¨‰∏âÁ´†: Â∞áËªçÁöÑÊ¶ÆËÄÄ",
                date: "2026-03-05",
                events: [
                { id: 'e30', time: "07:45", icon: "Home", title: "Êó©ÂÆâÂêçÂè§Â±ã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e31', time: "08:00", icon: "Coffee", title: "Êó©È§ê: Karasu", desc: "Â≠§Áç®ÁöÑÁæéÈ£üÂÆ∂ÂíñÂï°Âª≥", type: "heal", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e32', time: "09:30", icon: "MapPin", title: "ÂêçÂè§Â±ãÂüé", desc: "ÈáëÈØ±ËàáÊú¨‰∏∏Âæ°ÊÆø (ÈñÄÁ•® ¬•500)", type: "dungeon", transportTime: "20m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e33', time: "11:30", icon: "Camera", title: "Âæ∑Â∑ùÂúí", desc: "Êó•ÂºèÂ∫≠ÂúíÊï£Ê≠• (ÈñÄÁ•® ¬•300)", type: "action", transportTime: "30m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e34', time: "13:00", icon: "Utensils", title: "ÂçàÈ§ê: Yellow", desc: "ÂâáÊ≠¶Êñ∞Áî∫ ÊøÉÂéöÊ≠êÂßÜËõãÂåÖÈ£Ø", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e35', time: "15:00", icon: "ShoppingBag", title: "Ê¶Æ (Sakae)", desc: "LACHIC, ‰∏≠Êó•Â§ßÊ®ì Ë≥ºÁâ©", type: "trade", transportTime: "20m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e36', time: "18:00", icon: "Utensils", title: "ÊôöÈ§ê: Êµ∑ËÄÅ„Å©„Å¶", desc: "ÊåëÊà∞: 35cm ÁâπÂ§ßÁÇ∏Ëù¶", type: "boss", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e37', time: "20:00", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                ]
            },
            {
                day: 4,
                title: "ÁµÇÁ´†: Ê≠∏ÈÄî",
                date: "2026-03-06",
                events: [
                { id: 'e41', time: "09:40", icon: "Home", title: "ÊóÖÂ∫óÈÄÄÊàø", desc: "ÂëäÂà• Trip & Sleep hostelÔºåÂâçÂæÄÊ©üÂ†¥", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e42', time: "09:50", icon: "Train", title: "Âú∞‰∏ãÈêµÁßªÂãï", desc: "‰∏äÂâçÊ¥• (M03) -> ÈáëÂ±± (M01)", type: "travel", transportTime: "10m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e43', time: "10:18", icon: "Train", title: "ÂêçÈêµÁâπÊÄ• Œº-SKY", desc: "ÈáëÂ±±Á´ô -> ‰∏≠ÈÉ®ÂúãÈöõÊ©üÂ†¥", type: "travel", transportTime: "28m", transportCost: 1250, transportMode: "Train", completed: false },
                { id: 'e44', time: "10:50", icon: "MapPin", title: "ÊäµÈÅîÊ©üÂ†¥ T1", desc: "ÂâçÂæÄ‰∫§ÈÄöÂª£Â†¥", type: "checkpoint", transportTime: "5m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e45', time: "11:05", icon: "Footprints", title: "Ê≠•Ë°åËá≥ T2", desc: "Èï∑Ë∑ùÈõ¢ÁßªÂãï (10-15ÂàÜ)", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e46', time: "11:05", icon: "Plane", title: "Â†±Âà∞ & Ë®óÈÅã", desc: "ËôéËà™Ê´ÉÊ™Ø IT779 (13:15 Ëµ∑È£õ)", type: "action", transportTime: "0m", transportCost: 0, transportMode: "", completed: false },
                { id: 'e47', time: "13:15", icon: "Plane", title: "ËøîËà™: IT779", desc: "È£õÂæÄÊ°ÉÂúíÊ©üÂ†¥ (13:15-15:25)", type: "travel", transportTime: "", transportCost: 0, transportMode: "Plane", completed: false },
                { id: 'e48', time: "15:25", icon: "Home", title: "Mission Complete", desc: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥Ôºå‰ªªÂãôÁµêÊùü", type: "end", transportTime: "3h 10m", transportCost: 0, transportMode: "Plane", completed: false },
                ]
            }
        ];

        // Helper: Linkify Text
        const LinkifyText = ({ text }) => {
            if (!text) return null;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);
            return (
                <span>
                    {parts.map((part, i) => 
                        part.match(urlRegex) ? (
                            <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="desc-link flex items-center inline-flex gap-1" onClick={e=>e.stopPropagation()}>
                                <ExternalLink size={10} />{part.length > 20 ? part.substring(0,20)+'...' : part}
                            </a>
                        ) : part
                    )}
                </span>
            );
        };

        // Helper: Call Gemini
        const callGeminiAPI = async (prompt, imageBase64 = null) => {
             // Retrieve API Key from LocalStorage
             const apiKey = localStorage.getItem('gemini_api_key') || "";
             
             if (!apiKey) {
                 return "È≠îÂäõ‰∏çË∂≥: Ë´ãÂÖàËá≥„ÄåË≥áË®ä„ÄçÈ†ÅÈù¢Ë®≠ÂÆö Gemini API Key„ÄÇ";
             }
             
             const payload = {
                 contents: [{
                     parts: [
                         { text: prompt },
                         ...(imageBase64 ? [{ inline_data: { mime_type: "image/jpeg", data: imageBase64.split(',')[1] } }] : [])
                     ]
                 }]
             };

             try {
                 const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });
                 const data = await response.json();
                 if (data.error) throw new Error(data.error.message);
                 return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
             } catch (e) {
                 return `Ë©†Âî±Â§±Êïó: ${e.message}`;
             }
        };

        // --- Hook with Offline Support & LocalStorage Backup ---
        function useFirestoreData(user, tripId, collectionName, initialData, isObject = false) {
            const [data, setData] = useState(initialData);
            const [isOffline, setIsOffline] = useState(false);

            // 1. Force load from localStorage whenever key changes (Fix for persistence issue)
            useEffect(() => {
                if (!tripId) return;
                const localKey = `${tripId}_${collectionName}`;
                const cached = localStorage.getItem(localKey);
                if (cached) {
                    try {
                        setData(JSON.parse(cached));
                    } catch (e) {
                        console.error("Local load error", e);
                    }
                } else {
                    // If strictly no local data for this user, we might want to default to initialData
                    // But if initialData is empty array, it's fine.
                }
            }, [tripId, collectionName]);

            // 2. Firestore Sync
            useEffect(() => {
                if (!user || !tripId) return;

                let docRef;
                if (typeof __app_id !== 'undefined') {
                     docRef = doc(collection(db, 'artifacts', __app_id, 'public', 'data', 'trip_data'), `${tripId}_${collectionName}`);
                } else {
                     docRef = doc(collection(db, 'trip_data'), `${tripId}_${collectionName}`);
                }

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setIsOffline(docSnap.metadata.fromCache);
                    if (docSnap.exists()) {
                        const cloudData = isObject ? docSnap.data() : docSnap.data().items;
                        setData(cloudData);
                        localStorage.setItem(`${tripId}_${collectionName}`, JSON.stringify(cloudData)); 
                    } else {
                        // First time creation: Save initialData to Cloud
                        setDoc(docRef, isObject ? initialData : { items: initialData }).catch(e => console.error("Init data failed", e));
                    }
                }, (error) => {
                    console.error(`Offline or Error fetching ${collectionName}:`, error);
                    setIsOffline(true);
                });
                return () => unsubscribe();
            }, [user, tripId, collectionName]);

            const updateData = (newData) => {
                setData(newData);
                // Save to local immediately
                localStorage.setItem(`${tripId}_${collectionName}`, JSON.stringify(newData)); 
                
                if (!user || !tripId) return;
                let docRef;
                if (typeof __app_id !== 'undefined') {
                     docRef = doc(collection(db, 'artifacts', __app_id, 'public', 'data', 'trip_data'), `${tripId}_${collectionName}`);
                } else {
                     docRef = doc(collection(db, 'trip_data'), `${tripId}_${collectionName}`);
                }
                
                setDoc(docRef, isObject ? newData : { items: newData }).catch(e => {
                    if (e.code === 'resource-exhausted' || e.message.includes('exceeds the maximum')) {
                        alert("‚ö†Ô∏è Èõ≤Á´ØÁ©∫Èñì‰∏çË∂≥ (ÂúñÁâáÂèØËÉΩÈÅéÂ§ß)„ÄÇË≥áÊñôÂ∑≤‰øùÂ≠òÊñºÊú¨Âú∞Ôºå‰ΩÜÁÑ°Ê≥ïÂêåÊ≠•Áµ¶‰ªñ‰∫∫„ÄÇ");
                    } else {
                        console.error("Cloud save failed, using local", e);
                    }
                });
            };
            return [data, updateData, isOffline];
        }

        // --- SUB-COMPONENTS ---
        const LoginView = ({ onLogin }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] animate-enter"><div className="bg-slate-800 border-2 border-yellow-500 p-8 rounded-lg shadow-2xl text-center max-w-xs w-full relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-yellow-500 to-red-500"></div><div className="mb-6"><div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto border-4 border-yellow-500 mb-4 shadow-[0_0_20px_rgba(234,179,8,0.5)]"><Shield size={40} className="text-yellow-500" /></div><h2 className="text-2xl font-bold text-yellow-400 mb-1">ÂÜíÈö™ËÄÖÁôªÂÖ•</h2><p className="text-xs text-slate-400 font-mono">ADVENTURER LOGIN</p></div><button onClick={onLogin} className="w-full bg-white hover:bg-slate-200 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-3 transition group"><User size={20} />{USE_REAL_GOOGLE_AUTH ? "‰ΩøÁî® Google Â∏≥Ëôü" : "‰ª•Ë®™ÂÆ¢Ë∫´‰ªΩÈÄ≤ÂÖ•"}</button></div></div>
        );

        const QuestView = () => {
            const { quests, setQuests, activeLevel, setActiveLevel, countdown, weatherForecast, stats, setExpenses, expenses } = useContext(AppContext);
            const [isAddingEvent, setIsAddingEvent] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [newEventData, setNewEventData] = useState({ time: "10:00", title: "", desc: "", type: "action", locationQuery: "", transportTime: "", transportCost: "", transportMode: "Footprints", tags: "", completed: false });
            const fileInputRef = useRef(null); const [uploadingEventId, setUploadingEventId] = useState(null);
            
            const triggerImageUpload = (id) => { setUploadingEventId(id); fileInputRef.current.click(); };
            const handleImageUpload = (e) => {
                const file = e.target.files[0]; if (!file || !uploadingEventId) return;
                const reader = new FileReader(); reader.onload = (ev) => {
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const s = 600/img.width; 
                        c.width=Math.min(img.width, 600); 
                        c.height=img.height*s; 
                        ctx.drawImage(img,0,0,c.width,c.height);
                        const base64 = c.toDataURL('image/jpeg', 0.4);
                        const newQuests = [...quests]; const day = newQuests[activeLevel].events; const idx = day.findIndex(e=>e.id===uploadingEventId); if(idx>-1){ day[idx].image=base64; setQuests(newQuests); }
                    }; img.src = ev.target.result;
                }; reader.readAsDataURL(file); e.target.value='';
            };
            
            // Drag & Drop Handlers
            const handleDragStart = (e, index) => {
                e.dataTransfer.setData("text/plain", index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                const dragIndex = parseInt(e.dataTransfer.getData("text/plain"));
                if (dragIndex === dropIndex) return;

                const newQuests = [...quests];
                const events = [...newQuests[activeLevel].events];
                const [movedEvent] = events.splice(dragIndex, 1);
                events.splice(dropIndex, 0, movedEvent);
                
                newQuests[activeLevel].events = events;
                setQuests(newQuests);
            };

            // Export to Image
            const exportItinerary = async () => {
                const element = document.getElementById('quest-container');
                if(!element) return;
                try {
                    const canvas = await html2canvas(element, { backgroundColor: '#0f172a', scale: 2 });
                    const link = document.createElement('a');
                    link.download = `Day${activeLevel}_Itinerary.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    alert("ÂåØÂá∫Â§±Êïó");
                    console.error(err);
                }
            };
            
            // Route Map Link Generator
            const openRouteMap = () => {
                const events = quests[activeLevel].events;
                if (events.length < 2) return alert("Ë°åÁ®ãÈÅéÂ∞ëÔºåÁÑ°Ê≥ïÁî¢ÁîüË∑ØÁ∑öÂúñ");
                
                // Limit to 10 waypoints (Google Maps limitation)
                const origin = encodeURIComponent(events[0].title);
                const destination = encodeURIComponent(events[events.length-1].title);
                const waypoints = events.slice(1, -1).map(e => encodeURIComponent(e.title)).join('|');
                
                // Updated standard Google Maps URL
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}&travelmode=transit`, '_blank');
            };

            // Edit Event Logic
            const openEditModal = (ev) => {
                setNewEventData({
                    time: ev.time, title: ev.title, desc: ev.desc, type: ev.type || 'action', 
                    transportTime: ev.transportTime || "", transportCost: ev.transportCost || "", 
                    transportMode: ev.transportMode || "Footprints", tags: ev.tags ? ev.tags.join(" ") : "",
                    completed: ev.completed
                });
                setEditingId(ev.id);
                setIsEditing(true);
                setIsAddingEvent(true);
            };

            const saveEvent = () => {
                if(!newEventData.title) return alert("Ë´ãËº∏ÂÖ•Ê®ôÈ°å");
                let icon = "MapPin"; if(newEventData.type==='travel') icon="Train"; else if(newEventData.type==='loot') icon="Utensils"; else if(newEventData.type==='save') icon="Home";
                
                const eventPayload = { 
                    ...newEventData, 
                    icon, 
                    transportCost: parseInt(newEventData.transportCost)||0, 
                    tags: newEventData.tags.split(' ').filter(t=>t) 
                };

                const newQuests = [...quests];
                
                if (isEditing && editingId) {
                    const idx = newQuests[activeLevel].events.findIndex(e => e.id === editingId);
                    if (idx > -1) {
                        eventPayload.id = editingId;
                        eventPayload.image = newQuests[activeLevel].events[idx].image; 
                        newQuests[activeLevel].events[idx] = eventPayload;
                    }
                } else {
                    eventPayload.id = Date.now().toString();
                    newQuests[activeLevel].events.push(eventPayload);
                }
                
                // Only sort if not dragged (simple logic: sort on save if added new)
                if (!isEditing) {
                    newQuests[activeLevel].events.sort((a,b)=>a.time.localeCompare(b.time));
                }
                
                setQuests(newQuests); 
                setIsAddingEvent(false);
                setIsEditing(false);
                setEditingId(null);
            };

            const deleteEvent = (eventId) => {
                 if(!window.confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) return;
                 const newQuests = [...quests]; newQuests[activeLevel].events = newQuests[activeLevel].events.filter(e => e.id !== eventId); setQuests(newQuests);
            };
            
            const toggleComplete = (eventId) => {
                const newQuests = [...quests];
                const evt = newQuests[activeLevel].events.find(e => e.id === eventId);
                if(evt) {
                    evt.completed = !evt.completed;
                    if (evt.completed) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                }
                setQuests(newQuests);
            };
            const openMap = (title) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`, '_blank');
            };
            
            const syncToExpense = (ev) => {
                if (!ev.transportCost) return;
                const confirmSync = confirm(`Á¢∫ÂÆöÂ∞á„Äå${ev.title}„ÄçÁöÑË≤ªÁî® ¬•${ev.transportCost} Âä†ÂÖ•Ë®òÂ∏≥ÂóéÔºü`);
                if (confirmSync) {
                    const newExpense = {
                        id: Date.now(),
                        item: `${ev.title} (Ë°åÁ®ã)`,
                        cost: parseInt(ev.transportCost),
                        type: ev.type === 'loot' ? 'loot' : 'travel',
                        method: 'cash',
                        payer: 'me',
                        date: quests[activeLevel].date,
                        currency: 'JPY'
                    };
                    setExpenses([newExpense, ...expenses]);
                    alert("Â∑≤Âä†ÂÖ•Ë°åÂõäÔºÅ");
                }
            };

            const updateNote = (text) => { const newQuests=[...quests]; newQuests[activeLevel].note = text; setQuests(newQuests); };
            const weather = weatherForecast[activeLevel] || {};
            const WeatherIcon = weather.code < 3 ? Sun : (weather.code < 60 ? CloudSun : CloudRain);

            return (
                <div className="animate-enter w-full pb-20">
                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    
                    {/* Dynamic Stats Header */}
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        <div className="bg-[var(--bg-card)] p-2 rounded border border-yellow-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-yellow-500 font-bold">LV. {Math.floor(stats.xp/1000)+1}</span>
                            <span className="text-lg font-bold text-[var(--text-main)]">{stats.xp} XP</span>
                        </div>
                         <div className="bg-[var(--bg-card)] p-2 rounded border border-blue-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-blue-500 font-bold">FATIGUE</span>
                            <span className="text-lg font-bold text-[var(--text-main)]">{stats.fatigue}%</span>
                        </div>
                        <div className="bg-[var(--bg-card)] p-2 rounded border border-green-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-green-500 font-bold">GOLD</span>
                            <span className="text-lg font-bold text-[var(--text-main)]">¬•{stats.goldRemaining.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="flex w-full overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar px-1">{quests.map((q, i) => (<button key={i} onClick={() => setActiveLevel(i)} className={`flex-shrink-0 px-4 py-2 border-2 text-xs font-bold whitespace-nowrap rounded-sm ${activeLevel === i ? "bg-blue-600 border-blue-400 text-white" : "bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-muted)]"}`}>{i===0?"Â∫èÁ´†":i===4?"ÁµÇÁ´†":`Day ${i}`}</button>))}</div>
                    
                    <div id="quest-container" className="relative">
                        <div className="w-full bg-[var(--bg-card)] border-2 border-[var(--border-color)] p-4 mb-6 rounded-sm relative overflow-hidden">
                            <div className="flex justify-between items-start">
                                <h2 className="text-xl font-bold text-green-400 mb-1">{quests[activeLevel].title}</h2>
                                <div className="flex gap-2">
                                    <button onClick={openRouteMap} className="text-xs text-blue-400 hover:text-white flex items-center gap-1"><Map size={14}/> Ë∑ØÁ∑ö</button>
                                    <button onClick={exportItinerary} className="text-xs text-slate-400 hover:text-white flex items-center gap-1"><Camera size={14}/> Êà™Âúñ</button>
                                </div>
                            </div>
                            <div className="text-sm text-[var(--text-muted)] mb-4 flex justify-between items-center"><span className="flex items-center gap-2"><Calendar size={12}/> {quests[activeLevel].date} {weather.max && <span className="flex items-center gap-1 text-yellow-500 ml-2"><WeatherIcon size={14}/> {weather.min}¬∞-{weather.max}¬∞</span>}</span><span className="text-blue-400 font-mono text-xs">T-{countdown}</span></div>
                        </div>
                        <div className="w-full relative pl-4">
                            <div className="absolute left-[27px] top-4 bottom-4 w-1 bg-slate-700 z-0"></div>
                            {quests[activeLevel].events.map((ev, idx) => {
                                const IconC = ICON_MAP[ev.icon] || MapPin; const ModeIcon = ICON_MAP[ev.transportMode] || Footprints;
                                return (
                                    <div 
                                        key={ev.id} 
                                        draggable="true"
                                        onDragStart={(e) => handleDragStart(e, idx)}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, idx)}
                                        className={`relative z-10 mb-6 group transition-all duration-300 ${ev.completed ? 'opacity-50 grayscale' : ''} cursor-grab active:cursor-grabbing`}
                                    >
                                            {(ev.transportTime || ev.transportCost > 0) && (
                                                <div className="flex items-center ml-[19px] mb-3 relative">
                                                    <div className="w-2 h-2 bg-slate-600 rounded-full border-2 border-slate-900 z-20"></div>
                                                    <div className="ml-4 flex items-center gap-2 text-[10px] text-slate-400 bg-[var(--bg-card)]/90 px-2 py-1 rounded border border-[var(--border-color)]">
                                                        <ModeIcon size={12}/> 
                                                        {ev.transportTime} 
                                                        {ev.transportCost > 0 && <span className="text-yellow-500 font-mono">¬•{ev.transportCost}</span>}
                                                    </div>
                                                </div>
                                            )}
                                            <div className="flex items-start">
                                                <div className="mr-2 mt-4 text-slate-600 opacity-0 group-hover:opacity-50"><GripVertical size={16}/></div>
                                                <div onClick={()=>toggleComplete(ev.id)} className={`cursor-pointer w-12 h-12 flex-shrink-0 rounded-lg border-2 flex items-center justify-center shadow-lg z-10 transition-colors ${ev.completed ? 'bg-green-900 border-green-500 text-green-300' : 'bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-muted)]'}`}>
                                                    {ev.completed ? <Check size={20}/> : <IconC size={20}/>}
                                                </div>
                                                <div className="ml-4 flex-1 border-2 border-[var(--border-color)] bg-[var(--bg-card)]/50 p-3 rounded-lg relative hover:bg-[var(--bg-card)] transition-colors">
                                                    <div className="absolute top-4 -left-2 w-3 h-3 border-l-2 border-b-2 border-inherit bg-[var(--bg-card)] transform rotate-45"></div>
                                                    <div className="flex justify-between mb-1">
                                                        <span className="font-bold text-sm text-[var(--text-main)]">{ev.title}</span>
                                                        <span className="text-xs font-mono opacity-50 text-[var(--text-muted)]">{ev.time}</span>
                                                    </div>
                                                    <p className="text-xs opacity-70 mb-2 leading-relaxed text-[var(--text-main)]"><LinkifyText text={ev.desc}/></p>
                                                    {ev.tags && <div className="flex gap-1 mb-2">{ev.tags.map(t=><span key={t} className="text-[9px] bg-blue-900 text-blue-200 px-1 rounded">#{t}</span>)}</div>}
                                                    {ev.image && <img src={ev.image} className="w-full h-32 object-cover rounded border border-slate-700 mb-2"/>}
                                                    
                                                    {/* Action Bar */}
                                                    <div className="flex justify-between items-center mt-2 border-t border-[var(--border-color)] pt-2">
                                                        <div className="flex gap-2">
                                                            {ev.transportCost > 0 && (
                                                                <button onClick={()=>syncToExpense(ev)} className="text-xs text-yellow-500 flex items-center gap-1 hover:text-yellow-300 bg-yellow-900/20 px-2 py-0.5 rounded border border-yellow-800" title="ËΩâÂÖ•Ë®òÂ∏≥">
                                                                    <Coins size={10}/> ¬•{ev.transportCost}
                                                                </button>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-3">
                                                            <button onClick={()=>openMap(ev.title)} className="text-xs text-blue-400 flex items-center gap-1 hover:text-blue-300"><MapPin size={12}/> Â∞éËà™</button>
                                                            <button onClick={()=>openEditModal(ev)} className="text-xs text-slate-400 flex items-center gap-1 hover:text-[var(--text-main)]"><Edit size={12}/> Á∑®ËºØ</button>
                                                            <button onClick={()=>triggerImageUpload(ev.id)} className="text-xs text-slate-400 flex items-center gap-1 hover:text-[var(--text-main)]"><ImageIcon size={12}/> ÁÖßÁâá</button>
                                                            <button onClick={()=>deleteEvent(ev.id)} className="text-xs text-red-400 flex items-center gap-1 hover:text-red-300"><Trash2 size={12}/> Âà™Èô§</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>
                                )
                            })}
                            <div className="relative z-10 mt-4 mb-10 pl-16"><button onClick={() => { setIsEditing(false); setIsAddingEvent(true); setNewEventData({ time: "10:00", title: "", desc: "", type: "action", locationQuery: "", transportTime: "", transportCost: "", transportMode: "Footprints", tags: "", completed: false }); }} className="w-full border-2 border-dashed border-[var(--border-color)] text-[var(--text-muted)] rounded-lg p-3 hover:text-[var(--text-main)]"><PlusCircle className="inline mr-2"/>Êñ∞Â¢ûË°åÁ®ã</button></div>
                            <div className="ml-4 mt-8 bg-[var(--bg-card)] border border-[var(--border-color)] p-3 rounded"><h4 className="text-xs text-blue-400 mb-2 font-bold flex items-center gap-2"><FileText size={12}/> ÂÜíÈö™Êó•Ë®ò (Journal)</h4><textarea className="w-full bg-transparent text-sm text-[var(--text-main)] outline-none resize-none h-24" placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºË∂£‰∫ã..." value={quests[activeLevel].note||""} onChange={(e)=>updateNote(e.target.value)}></textarea></div>
                        </div>
                    </div>
                    {isAddingEvent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-slate-900 border-2 border-yellow-600 w-full max-w-sm rounded p-5">
                                <h3 className="text-yellow-500 font-bold mb-4">{isEditing ? "Á∑®ËºØË°åÁ®ã" : "Êñ∞Â¢ûË°åÁ®ã"}</h3>
                                <div className="space-y-3">
                                    <input type="time" value={newEventData.time} onChange={e=>setNewEventData({...newEventData,time:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <div className="relative">
                                        <input type="text" placeholder="Âú∞ÈªûÂêçÁ®±" value={newEventData.title} onChange={e=>setNewEventData({...newEventData,title:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white pr-20"/>
                                        <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(newEventData.title || "")}`} target="_blank" className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-blue-400 flex items-center gap-1"><Search size={10}/> Âú∞ÂúñÊâæ</a>
                                    </div>
                                    <input type="text" placeholder="ÊèèËø∞ (ÂèØË≤ºÁ∂≤ÂùÄ)" value={newEventData.desc} onChange={e=>setNewEventData({...newEventData,desc:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="ÁßªÂãïÊôÇÈñì (15m)" value={newEventData.transportTime} onChange={e=>setNewEventData({...newEventData,transportTime:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                        <input type="number" placeholder="Ë≤ªÁî® (¬•)" value={newEventData.transportCost} onChange={e=>setNewEventData({...newEventData,transportCost:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto pb-1">
                                        {['Footprints','Train','Bus','Car','Plane'].map(m => {
                                            const MIcon = ICON_MAP[m];
                                            return <button key={m} onClick={()=>setNewEventData({...newEventData, transportMode: m})} className={`p-2 rounded border ${newEventData.transportMode === m ? 'bg-blue-600 border-blue-400 text-white' : 'bg-slate-800 border-slate-600 text-slate-400'}`}><MIcon size={16}/></button>
                                        })}
                                    </div>
                                    <input type="text" placeholder="#Ê®ôÁ±§ (‰ª•Á©∫ÁôΩÂàÜÈöî)" value={newEventData.tags} onChange={e=>setNewEventData({...newEventData,tags:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <button onClick={saveEvent} className="w-full bg-yellow-600 text-black font-bold py-2 rounded">ÂÑ≤Â≠ò</button>
                                    <button onClick={()=>{setIsAddingEvent(false); setIsEditing(false);}} className="w-full text-slate-500 text-xs mt-2">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryView = () => {
            const { expenses, setExpenses, budget, setBudget, exchangeRate, shoppingList, setShoppingList, quests, activeLevel, settingsData, updateSettings } = useContext(AppContext);
            const [newExp, setNewExp] = useState({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });
            const [newShopItem, setNewShopItem] = useState("");
            const [isEditingBudget, setIsEditingBudget] = useState(false); 
            const [tempBudget, setTempBudget] = useState(budget);
            const [tempCashBudget, setTempCashBudget] = useState(settingsData?.cashBudget || 50000);
            const [tempIcBudget, setTempIcBudget] = useState(settingsData?.icBudget || 3000);
            const [isScanning, setIsScanning] = useState(false);
            const [isEditingExpense, setIsEditingExpense] = useState(false);
            const [editingExpId, setEditingExpId] = useState(null);
            
            // Fund Management State
            const [isManagingFunds, setIsManagingFunds] = useState(false);
            const [fundType, setFundType] = useState('charge'); // charge (cash->ic), withdraw (atm->cash), cc_charge (cc->ic)
            const [fundAmount, setFundAmount] = useState("");
            
            const ocrInputRef = useRef(null);

            // Expense Category Configuration
            const EXPENSE_CATS = [
                { id: 'loot', label: 'ÁæéÈ£ü', icon: Utensils, activeClass: 'bg-yellow-600 border-yellow-500 text-white ring-2 ring-yellow-500/20' },
                { id: 'travel', label: '‰∫§ÈÄö', icon: Train, activeClass: 'bg-blue-600 border-blue-500 text-white ring-2 ring-blue-500/20' },
                { id: 'trade', label: 'Ë≥ºÁâ©', icon: ShoppingBag, activeClass: 'bg-pink-600 border-pink-500 text-white ring-2 ring-pink-500/20' },
                { id: 'save', label: '‰ΩèÂÆø', icon: Home, activeClass: 'bg-green-600 border-green-500 text-white ring-2 ring-green-500/20' },
                { id: 'other', label: 'ÂÖ∂‰ªñ', icon: HelpCircle, activeClass: 'bg-slate-600 border-slate-500 text-white ring-2 ring-slate-500/20' }
            ];

            const cashBudget = settingsData?.cashBudget || 50000;
            const icBudget = settingsData?.icBudget || 3000; 
            
            const handleSaveBudget = () => {
                const newTotal = parseInt(tempBudget) || 0;
                const newCash = parseInt(tempCashBudget) || 0;
                const newIc = parseInt(tempIcBudget) || 0;
                
                updateSettings({
                    ...settingsData,
                    budget: newTotal,
                    cashBudget: newCash,
                    icBudget: newIc
                });
                setIsEditingBudget(false);
            };

            // Handle Fund Updates
            const handleFundUpdate = () => {
                const val = parseInt(fundAmount);
                if (!val || val <= 0) return alert("Ë´ãËº∏ÂÖ•ÊúâÊïàÈáëÈ°ç");

                const newSettings = { ...settingsData, cashBudget, icBudget };

                if (fundType === 'withdraw') {
                    // ATM Withdraw: Add to Cash
                    newSettings.cashBudget += val;
                    alert(`Â∑≤Ë®òÈåÑÊèêÊ¨æ: ¬•${val}`);
                } else if (fundType === 'charge') {
                    // Cash Charge IC: Cash decreases, IC increases
                    const cashSpentReal = expenses.filter(e => e.method === 'cash').reduce((a,c) => a + c.cost, 0);
                    const currentCash = cashBudget - cashSpentReal;
                    
                    if (currentCash < val) return alert("Èå¢ÂåÖÁèæÈáë‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂÑ≤ÂÄºÔºÅ");
                    
                    newSettings.cashBudget -= val;
                    newSettings.icBudget += val;
                    alert(`Â∑≤‰ΩøÁî®ÁèæÈáëÂÑ≤ÂÄº IC Âç°: ¬•${val}`);
                } else if (fundType === 'cc_charge') {
                    // CC Charge IC: IC increases only
                    newSettings.icBudget += val;
                    alert(`Â∑≤Âà∑Âç°ÂÑ≤ÂÄº IC Âç°: ¬•${val}`);
                }

                updateSettings(newSettings);
                setIsManagingFunds(false);
                setFundAmount("");
            };

            const addOrUpdateExpense = () => {
                if(!newExp.item || !newExp.cost) return;
                const finalCost = newExp.currency === 'TWD' ? Math.round(parseInt(newExp.cost)/exchangeRate) : parseInt(newExp.cost);
                const payload = { ...newExp, cost: finalCost };
                
                if (isEditingExpense && editingExpId) {
                    setExpenses(expenses.map(e => e.id === editingExpId ? { ...payload, id: editingExpId } : e));
                    setIsEditingExpense(false);
                    setEditingExpId(null);
                } else {
                    setExpenses([{ id: Date.now(), ...payload }, ...expenses]);
                    if (newExp.type === 'trade' || newExp.type === 'loot') {
                        confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#FFD700', '#FFA500'] });
                    }
                }
                setNewExp({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });
            };

            const editExpense = (exp) => {
                setNewExp({ ...exp, cost: exp.cost, currency: 'JPY' });
                setEditingExpId(exp.id);
                setIsEditingExpense(true);
            };

            const deleteExpense = (id) => { if(confirm("Âà™Èô§?")) setExpenses(expenses.filter(e=>e.id!==id)); };
            const addShopItem = () => { if(newShopItem){ setShoppingList([...shoppingList, {id: Date.now(), text: newShopItem, checked: false}]); setNewShopItem(""); }};
            const deleteShopItem = (id) => { if(confirm("Âà™Èô§?")) setShoppingList(shoppingList.filter(i=>i.id!==id)); };
            const toggleShop = (id) => setShoppingList(shoppingList.map(i=>i.id===id?{...i,checked:!i.checked}:i));
            
            const totalSpent = expenses.reduce((a,c)=>a+c.cost,0);
            const remainingBudget = budget - totalSpent;
            const budgetPercent = Math.max(0, (remainingBudget / budget) * 100);
            
            // Cash Tracker Logic
            const cashSpent = expenses.filter(e => e.method === 'cash').reduce((a,c) => a + c.cost, 0);
            const cashRemaining = cashBudget - cashSpent;

            // IC Card Tracker Logic
            const icSpent = expenses.filter(e => e.method === 'ic').reduce((a,c) => a + c.cost, 0);
            const icRemaining = icBudget - icSpent;

            // Daily Cap Logic
            const remainingDays = Math.max(1, quests.length - activeLevel);
            const dailyCap = Math.floor(remainingBudget / remainingDays);

            // Splitwise Logic
            const myCredits = expenses.filter(e => e.payer === 'partner').reduce((acc, curr) => acc + curr.cost, 0); 
            
            // OCR Logic
            const handleOCR = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                setIsScanning(true);
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const base64 = ev.target.result;
                        const result = await callGeminiAPI("Analyze this receipt. Return ONLY a JSON object with {item: string (summary), cost: number (integer), currency: 'JPY' or 'TWD', date: 'YYYY-MM-DD'}. No markdown.", base64);
                        const cleanResult = result.replace(/```json|```/g, '').trim();
                        const parsed = JSON.parse(cleanResult);
                        setNewExp({ ...newExp, item: parsed.item || "ÊéÉÊèèÈ†ÖÁõÆ", cost: parsed.cost || 0, currency: parsed.currency || 'JPY', date: parsed.date || newExp.date });
                    } catch (err) {
                        alert("Ëæ®Ë≠òÂ§±ÊïóÔºåË´ãÈáçË©¶");
                        console.error(err);
                    } finally { setIsScanning(false); }
                };
                reader.readAsDataURL(file);
            };

            // Calculate TWD equivalent
            const totalSpentTWD = Math.round(totalSpent * exchangeRate);

            return (
                <div className="w-full animate-enter pb-32">
                    {/* Budget Health Bar Card */}
                    <div className="bg-[var(--bg-card)] border-2 border-yellow-600 p-4 mb-4 rounded relative overflow-hidden">
                        <div className="flex justify-between items-end mb-2 relative z-10">
                            <div>
                                <div className="text-xs text-yellow-600 font-bold mb-1 flex gap-2 items-center">
                                    Á∏ΩÈ°çÂ∫¶ (TOTAL BUDGET) 
                                    {!isEditingBudget && <button onClick={()=>{setIsEditingBudget(true);setTempBudget(budget);setTempCashBudget(cashBudget);setTempIcBudget(icBudget)}}><Edit size={12}/></button>}
                                </div>
                                {isEditingBudget ? (
                                    <div className="flex flex-col gap-2 bg-slate-900 p-2 rounded border border-slate-600">
                                            <div className="flex gap-2 items-center justify-between">
                                                <span className="text-[10px] w-8">Á∏ΩÈ°ç:</span>
                                                <input type="number" value={tempBudget} onChange={e=>setTempBudget(e.target.value)} className="bg-slate-800 w-24 px-1 text-white border border-slate-600 text-right"/>
                                            </div>
                                            <div className="flex gap-2 items-center justify-between">
                                                <span className="text-[10px] w-8 text-green-300">ÁèæÈáë:</span>
                                                <input type="number" value={tempCashBudget} onChange={e=>setTempCashBudget(e.target.value)} className="bg-slate-800 w-24 px-1 text-white border border-slate-600 text-right"/>
                                            </div>
                                            <div className="flex gap-2 items-center justify-between">
                                                <span className="text-[10px] w-8 text-blue-300">ICÂç°:</span>
                                                <input type="number" value={tempIcBudget} onChange={e=>setTempIcBudget(e.target.value)} className="bg-slate-800 w-24 px-1 text-white border border-slate-600 text-right"/>
                                            </div>
                                            <button onClick={handleSaveBudget} className="text-xs bg-green-600 text-white py-1 rounded w-full mt-1">Á¢∫Ë™çÂÑ≤Â≠ò</button>
                                    </div>
                                ) : (
                                    <div className="flex gap-4">
                                        <div>
                                            <div className="text-3xl text-yellow-400 font-bold tracking-tighter">¬•{remainingBudget.toLocaleString()}</div>
                                            <div className="text-[9px] text-[var(--text-muted)]">Ââ©È§òÁ∏ΩÈ°ç</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-[var(--text-muted)]">‰ªäÊó•Âª∫Ë≠∞‰∏äÈôê</div>
                                <div className="text-sm font-bold text-blue-300">¬•{dailyCap.toLocaleString()}</div>
                            </div>
                        </div>
                        {/* HP Bar */}
                        <div className="hp-bar-container w-full relative">
                            <div className={`hp-bar-fill ${budgetPercent > 50 ? 'bg-green-500' : budgetPercent > 20 ? 'bg-yellow-500' : 'bg-red-500 animate-pulse'}`} style={{width: `${budgetPercent}%`}}></div>
                        </div>
                        <div className="flex justify-between text-[10px] text-[var(--text-muted)] mt-1">
                            <span className="flex items-center gap-1">
                                Â∑≤ÊîØÂá∫: ¬•{totalSpent.toLocaleString()} 
                                <span className="text-[9px] opacity-70">‚âà NT${totalSpentTWD.toLocaleString()}</span>
                            </span>
                            <span>{Math.round(budgetPercent)}%</span>
                        </div>
                    </div>
                    
                    {/* Cash & IC & Fund Management */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className={`bg-[var(--bg-card)] border p-3 rounded relative flex flex-col justify-between ${cashRemaining < 10000 ? 'border-red-500/50' : 'border-[var(--border-color)]'}`}>
                            <div>
                                <div className="flex items-center gap-2 text-[var(--text-muted)] mb-1"><Banknote size={14}/> <span className="text-xs font-bold">Èå¢ÂåÖÁèæÈáë</span></div>
                                <div className={`text-lg font-bold font-mono ${cashRemaining < 3000 ? 'text-red-500' : cashRemaining < 10000 ? 'text-yellow-500' : 'text-[var(--text-main)]'}`}>¬•{cashRemaining.toLocaleString()}</div>
                            </div>
                            {cashRemaining < 10000 && <div className="text-[9px] text-red-400 absolute top-2 right-2 flex items-center"><AlertTriangle size={10}/> Ë£úÊ∞¥!</div>}
                        </div>

                        <div className={`bg-[var(--bg-card)] border p-3 rounded relative flex flex-col justify-between ${icRemaining < 1000 ? 'border-red-500/50' : 'border-[var(--border-color)]'}`}>
                            <div>
                                <div className="flex items-center gap-2 text-[var(--text-muted)] mb-1"><ScanLine size={14}/> <span className="text-xs font-bold">IC Âç°È§òÈ°ç</span></div>
                                <div className={`text-lg font-bold font-mono ${icRemaining < 1000 ? 'text-red-500' : 'text-green-400'}`}>¬•{icRemaining.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <button onClick={() => setIsManagingFunds(true)} className="w-full bg-[var(--bg-card)] border border-[var(--border-color)] hover:bg-slate-700 text-[var(--text-muted)] py-2 rounded-lg text-xs font-bold mb-4 flex items-center justify-center gap-2 transition">
                        <Activity size={14}/> üí∞ Ë≥áÈáëË™øÂ∫¶ (ÂÑ≤ÂÄº/ÊèêÊ¨æ)
                    </button>

                    {/* Settlement Dashboard */}
                    <div className="bg-[var(--bg-card)] border border-[var(--border-color)] p-3 mb-4 rounded flex justify-between items-center">
                        <div className="flex items-center gap-2 text-[var(--text-muted)]"><Calculator size={16}/> <span className="text-xs font-bold">ÁµêÁÆó‰∏≠ÂøÉ</span></div>
                        <div className="text-right">
                            <div className="text-[10px] text-[var(--text-muted)]">ÁõÆÂâç‰ª£Â¢äÁ∏ΩÈ°ç</div>
                            <div className="text-lg font-bold text-green-400">+¬•{myCredits.toLocaleString()}</div>
                        </div>
                    </div>

                    {/* Fund Management Modal */}
                    {isManagingFunds && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 animate-in fade-in">
                            <div className="bg-slate-900 border-2 border-blue-500 w-full max-w-sm rounded-xl p-5 shadow-2xl relative">
                                <button onClick={() => setIsManagingFunds(false)} className="absolute top-3 right-3 text-slate-500"><X size={20}/></button>
                                <h3 className="text-blue-400 font-bold mb-4 flex items-center gap-2"><Banknote size={18}/> Ë≥áÈáëÁÆ°ÁêÜ</h3>
                                
                                <div className="flex gap-2 mb-4 bg-slate-800 p-1 rounded-lg">
                                    <button onClick={()=>setFundType('charge')} className={`flex-1 py-2 text-xs rounded-md transition ${fundType==='charge' ? 'bg-green-600 text-white font-bold' : 'text-slate-400'}`}>ÁèæÈáëÂÑ≤ÂÄºIC</button>
                                    <button onClick={()=>setFundType('withdraw')} className={`flex-1 py-2 text-xs rounded-md transition ${fundType==='withdraw' ? 'bg-yellow-600 text-white font-bold' : 'text-slate-400'}`}>ATMÊèêÊ¨æ</button>
                                    <button onClick={()=>setFundType('cc_charge')} className={`flex-1 py-2 text-xs rounded-md transition ${fundType==='cc_charge' ? 'bg-blue-600 text-white font-bold' : 'text-slate-400'}`}>Âà∑Âç°ÂÑ≤ÂÄº</button>
                                </div>

                                <div className="mb-4">
                                    <div className="text-xs text-slate-400 mb-2">
                                        {fundType === 'charge' && "Âæû„ÄåÈå¢ÂåÖÁèæÈáë„ÄçÊâ£Èô§ÔºåÂ≠òÂÖ•„ÄåIC Âç°„Äç„ÄÇ"}
                                        {fundType === 'withdraw' && "ÂæûÈäÄË°åÈ†òÂá∫ÔºåÂ¢ûÂä†„ÄåÈå¢ÂåÖÁèæÈáë„Äç„ÄÇ"}
                                        {fundType === 'cc_charge' && "Âà∑‰ø°Áî®Âç°ÔºåÁõ¥Êé•Â¢ûÂä†„ÄåIC Âç°„ÄçÈ§òÈ°ç„ÄÇ"}
                                    </div>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-white font-bold">¬•</span>
                                        <input type="number" value={fundAmount} onChange={e=>setFundAmount(e.target.value)} placeholder="Ëº∏ÂÖ•ÈáëÈ°ç" className="w-full bg-slate-800 border-2 border-slate-600 rounded-lg py-3 pl-8 pr-4 text-white text-lg font-mono focus:border-blue-500 outline-none" autoFocus />
                                    </div>
                                </div>

                                <button onClick={handleFundUpdate} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">Á¢∫Ë™çÂü∑Ë°å</button>
                            </div>
                        </div>
                    )}

                    <div className={`bg-[var(--bg-card)] border p-3 mb-4 rounded ${isEditingExpense ? 'border-blue-500' : 'border-[var(--border-color)]'}`}>
                        <h3 className="font-bold text-[var(--text-main)] mb-2 flex justify-between items-center">
                            <span className="flex gap-2"><CreditCard size={16}/> {isEditingExpense ? "Á∑®ËºØÊîØÂá∫" : "Êñ∞Â¢ûÊîØÂá∫"}</span>
                            <div className="relative">
                                <button onClick={()=>ocrInputRef.current.click()} className="text-[10px] bg-blue-600 px-2 py-1 rounded text-white flex items-center gap-1">
                                    {isScanning ? <Loader2 size={10} className="animate-spin"/> : <ScanLine size={10}/>} AI ÊéÉÊèè
                                </button>
                                <input type="file" ref={ocrInputRef} onChange={handleOCR} accept="image/*" className="hidden"/>
                            </div>
                        </h3>
                        
                        {/* Optimized Category Selection */}
                        <div className="flex gap-2 mb-3 overflow-x-auto pb-1 no-scrollbar">
                            {EXPENSE_CATS.map(cat => {
                                const Icon = cat.icon;
                                const isActive = newExp.type === cat.id;
                                return (
                                    <button 
                                        key={cat.id} 
                                        onClick={()=>setNewExp({...newExp, type: cat.id})} 
                                        className={`flex items-center gap-1.5 px-3 py-2 rounded-lg border text-xs font-bold transition-all whitespace-nowrap ${isActive ? cat.activeClass : 'bg-[var(--bg-input)] border-[var(--border-color)] text-[var(--text-muted)] hover:bg-slate-700'}`}
                                    >
                                        <Icon size={14} />
                                        {cat.label}
                                    </button>
                                );
                            })}
                        </div>
                        
                        {/* New Date Picker Field */}
                        <div className="mb-2">
                             <input type="date" value={newExp.date} onChange={e=>setNewExp({...newExp, date:e.target.value})} className="w-full bg-[var(--bg-input)] border-[var(--border-color)] p-2 text-xs rounded text-[var(--text-main)]" />
                        </div>

                        <div className="flex flex-wrap gap-2 mb-2"><input type="text" placeholder="È†ÖÁõÆ" value={newExp.item} onChange={e=>setNewExp({...newExp,item:e.target.value})} className="flex-[2] min-w-[120px] bg-[var(--bg-input)] border-[var(--border-color)] p-2 text-xs rounded text-[var(--text-main)]"/><div className="flex-[1] flex border border-[var(--border-color)] rounded min-w-[110px]"><input type="number" placeholder="ÈáëÈ°ç" value={newExp.cost} onChange={e=>setNewExp({...newExp,cost:e.target.value})} className="w-full bg-[var(--bg-input)] p-2 text-xs text-[var(--text-main)] outline-none"/><button onClick={()=>setNewExp({...newExp,currency:newExp.currency==='JPY'?'TWD':'JPY'})} className="px-2 bg-slate-700 text-[10px] text-white shrink-0">{newExp.currency}</button></div></div>
                        <div className="flex justify-between items-center flex-wrap gap-2">
                            <div className="flex gap-2">
                                <select value={newExp.payer} onChange={e=>setNewExp({...newExp,payer:e.target.value})} className="bg-[var(--bg-input)] text-[var(--text-main)] text-xs rounded px-1"><option value="me">Ëá™Áî®</option><option value="partner">‰ª£Â¢ä</option></select>
                                <select value={newExp.method} onChange={e=>setNewExp({...newExp,method:e.target.value})} className="bg-[var(--bg-input)] text-[var(--text-main)] text-xs rounded px-1"><option value="cash">ÁèæÈáë</option><option value="card">Âà∑Âç°</option><option value="ic">ICÂç°</option></select>
                            </div>
                            <div>
                                {isEditingExpense && <button onClick={()=>{setIsEditingExpense(false); setNewExp({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });}} className="text-slate-500 text-xs mr-2">ÂèñÊ∂à</button>}
                                <button onClick={addOrUpdateExpense} className="bg-yellow-600 text-black px-4 py-1 rounded text-xs font-bold">{isEditingExpense ? "Êõ¥Êñ∞" : "Á¥ÄÈåÑ"}</button>
                            </div>
                        </div>
                        {newExp.cost && newExp.currency==='TWD' && <div className="text-[10px] text-right text-slate-500 mt-1">‚âà ¬•{Math.round(newExp.cost/exchangeRate).toLocaleString()}</div>}
                    </div>

                    <div className="bg-[var(--bg-card)] border border-[var(--border-color)] p-3 mb-4 rounded">
                        <h3 className="font-bold text-pink-300 mb-2 flex gap-2"><ShoppingBag size={16}/> ÂøÖË≤∑Ê∏ÖÂñÆ (Shopping)</h3>
                        <div className="flex gap-2 mb-2"><input type="text" placeholder="Êñ∞Â¢ûÂïÜÂìÅ..." value={newShopItem} onChange={e=>setNewShopItem(e.target.value)} className="flex-1 bg-[var(--bg-input)] border-[var(--border-color)] p-2 text-xs rounded text-[var(--text-main)]"/><button onClick={addShopItem}><PlusCircle size={20} className="text-pink-400"/></button></div>
                        <div className="space-y-1">{shoppingList.map(item=><div key={item.id} className={`flex items-center gap-2 p-2 rounded border border-[var(--border-color)] ${item.checked?'opacity-50 line-through bg-slate-900':'bg-[var(--bg-card)]'}`}><div onClick={()=>toggleShop(item.id)} className={`w-4 h-4 border ${item.checked?'bg-pink-500 border-pink-500':'border-slate-500'} rounded-sm flex items-center justify-center cursor-pointer`}>{item.checked&&<Check size={12} className="text-white"/>}</div><span className="flex-1 text-xs">{item.text}</span><button onClick={(e)=>{e.stopPropagation();deleteShopItem(item.id)}} className="text-red-400"><Trash2 size={12}/></button></div>)}</div>
                    </div>

                    <div className="space-y-1">
                        {expenses.map(e => {
                            const TypeIcon = EXPENSE_ICONS[e.type] || HelpCircle;
                            return (
                                <div key={e.id} onClick={() => editExpense(e)} className="flex justify-between items-center p-2 border-b border-[var(--border-color)] bg-[var(--bg-card)] hover:bg-slate-700/50 transition cursor-pointer">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${e.type==='trade'?'bg-pink-900 text-pink-300':e.type==='loot'?'bg-yellow-900 text-yellow-300':e.type==='travel'?'bg-blue-900 text-blue-300':e.type==='save'?'bg-green-900 text-green-300':'bg-slate-700 text-slate-300'}`}>
                                            <TypeIcon size={14} />
                                        </div>
                                        <div className="flex flex-col">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold">{e.item}</span>
                                                <span className="text-[9px] text-[var(--text-muted)] bg-[var(--bg-input)] px-1 rounded">{e.date}</span>
                                            </div>
                                            <span className="text-[9px] text-[var(--text-muted)]">{e.payer==='partner'?'(‰ª£Â¢ä)':'(Ëá™Áî®)'} ¬∑ {e.method}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-mono font-bold">¬•{e.cost.toLocaleString()}</span>
                                        <button onClick={(ev)=>{ev.stopPropagation();deleteExpense(e.id)}} className="text-slate-600 hover:text-red-400"><Trash2 size={12}/></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        // --- Guide View ---
        const GuideView = () => {
            const [expandedGuideId, setExpandedGuideId] = useState(null);
            return (
                <div className="w-full animate-enter pb-20"><div className="space-y-4">{GUIDE_DETAILS.map((place) => (<div key={place.id} className="bg-[var(--bg-card)] border-2 border-[var(--border-color)] rounded-lg overflow-hidden transition-all duration-300"><div className="p-4 cursor-pointer hover:bg-slate-700/50 flex items-center gap-4" onClick={() => setExpandedGuideId(expandedGuideId === place.id ? null : place.id)}><div className="text-4xl">{place.image}</div><div className="flex-1"><h3 className="font-bold text-lg text-yellow-400">{place.title}</h3><p className="text-xs text-[var(--text-muted)] mb-1">{place.subtitle}</p><div className="flex gap-1 flex-wrap">{place.tags.map(tag => (<span key={tag} className="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-blue-300 border border-slate-600">#{tag}</span>))}</div></div><div className={`transition-transform duration-300 ${expandedGuideId === place.id ? 'rotate-180' : ''}`}><ArrowDown size={16} className="text-slate-500" /></div></div>{expandedGuideId === place.id && (<div className="p-4 pt-0 border-t border-[var(--border-color)] bg-[var(--bg-input)] animate-in slide-in-from-top-2"><div className="text-sm text-[var(--text-main)] mb-4 leading-relaxed mt-4">{place.desc}</div><div className="space-y-3 text-xs"><div className="bg-[var(--bg-card)] p-3 rounded border border-[var(--border-color)]"><h4 className="font-bold text-blue-400 mb-1 flex items-center gap-2"><Clock size={12}/> Ê≠∑Âè≤Â∞èÁü•Ë≠ò</h4><p className="text-[var(--text-muted)]">{place.content.history}</p></div><div className="bg-[var(--bg-card)] p-3 rounded border border-[var(--border-color)]"><h4 className="font-bold text-yellow-400 mb-1 flex items-center gap-2"><Star size={12} /> ÁâπËâ≤ËàáÂøÖÁúã</h4><p className="text-[var(--text-muted)]">{place.content.features}</p></div><div className="bg-[var(--bg-card)] p-3 rounded border border-[var(--border-color)]"><h4 className="font-bold text-green-400 mb-1 flex items-center gap-2"><MapPin size={12}/> ÊîªÁï• Tips</h4><p className="text-[var(--text-muted)]">{place.content.tips}</p></div><div className="bg-red-900/20 p-3 rounded border border-red-900/50"><h4 className="font-bold text-red-400 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> Ê≥®ÊÑè‰∫ãÈ†Ö</h4><p className="text-red-200/80">{place.content.warning}</p></div></div></div>)}</div>))}</div></div>
            );
        };

        // --- Grimoire View ---
        const GrimoireView = () => {
            const { speakJapanese, user, tripId } = useContext(AppContext);
            const [transInput, setTransInput] = useState("");
            const [transResult, setTransResult] = useState("");
            const [transMode, setTransMode] = useState("JP"); // JP (Target is JP), ZH (Target is ZH)
            const [isTranslating, setIsTranslating] = useState(false);
            const [selectedSpell, setSelectedSpell] = useState(null);
            const [filterType, setFilterType] = useState("all");
            
            // New States for Features
            const [isAddingSpell, setIsAddingSpell] = useState(false);
            const [newSpellData, setNewSpellData] = useState({ title: "", jp: "", zh: "", romaji: "", type: "custom" });
            
            // Custom Spells & History Data
            const [customSpells, setCustomSpells] = useFirestoreData(user, tripId, 'custom_spells', []);
            const [history, setHistory] = useFirestoreData(user, tripId, 'trans_history', []);

            // Combine built-in and custom spells
            const allSpells = [...SPELL_DATA, ...customSpells];
            const filteredSpells = filterType === 'all' ? allSpells : allSpells.filter(s => s.type === filterType);

            const handleTranslate = async () => {
                if (!transInput) return;
                setIsTranslating(true);
                setTransResult("");
                try {
                    const prompt = transMode === 'JP' 
                        ? `Translate Traditional Chinese to Japanese (Polite/Travel). Output ONLY Japanese. Input: "${transInput}"`
                        : `Translate Japanese to Traditional Chinese. Output ONLY Traditional Chinese. Input: "${transInput}"`;
                        
                    const result = await callGeminiAPI(prompt);
                    const finalResult = result ? result.trim() : "Ë©†Âî±Â§±Êïó...";
                    setTransResult(finalResult);
                    
                    // Add to history
                    const newRecord = { id: Date.now(), input: transInput, output: finalResult, mode: transMode };
                    setHistory([newRecord, ...history].slice(0, 10)); // Keep last 10
                } catch (error) { setTransResult("È≠îÂäõ‰∏çË∂≥: " + error.message); } finally { setIsTranslating(false); }
            };
            
            const saveCustomSpell = () => {
                if (!newSpellData.title || !newSpellData.jp) return alert("Ë´ãËº∏ÂÖ•Ê®ôÈ°åÂíåÊó•Êñá");
                const newSpell = { ...newSpellData, id: Date.now() };
                setCustomSpells([...customSpells, newSpell]);
                setIsAddingSpell(false);
                setNewSpellData({ title: "", jp: "", zh: "", romaji: "", type: "custom" });
            };

            const copyText = (text) => {
                navigator.clipboard.writeText(text);
                alert("Â∑≤Ë§áË£ΩÂííË™ûÔºÅ");
            };

            return (
                <div className="w-full animate-enter pb-20">
                     {/* Translation Tool */}
                     <div className="bg-[var(--bg-card)] border-2 border-blue-500 p-4 rounded-sm mb-6 relative overflow-hidden shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                        <div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">LIVE TRANSLATE</div>
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><Globe className="text-blue-400" size={20} /><h3 className="font-bold text-blue-300">ÈÄöÁî®Ë™ûÁøªË≠ØË°ì</h3></div>
                            <button onClick={()=>setTransMode(transMode==='JP'?'ZH':'JP')} className="text-[10px] bg-slate-700 px-2 py-1 rounded border border-slate-500 hover:bg-slate-600 transition flex items-center gap-1">
                                {transMode==='JP' ? '‰∏≠ ‚Æï Êó•' : 'Êó• ‚Æï ‰∏≠'} <RotateCcw size={10}/>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            <input type="text" placeholder={transMode==='JP'?"Ëº∏ÂÖ•‰∏≠Êñá...":"Ëº∏ÂÖ•Êó•Êñá..."} value={transInput} onChange={(e) => setTransInput(e.target.value)} className="flex-1 min-w-0 bg-[var(--bg-input)] border border-[var(--border-color)] p-2 text-sm text-[var(--text-main)] rounded outline-none focus:border-blue-400 placeholder:text-slate-500"/>
                            <button onClick={handleTranslate} disabled={isTranslating} className="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:text-gray-400 text-white px-4 rounded font-bold text-xs transition flex items-center gap-1 whitespace-nowrap shrink-0">
                                {isTranslating ? <Loader2 className="animate-spin" size={14} /> : "Ë©†Âî±"}
                            </button>
                        </div>
                        
                        {/* Result Area */}
                        {transResult && (
                            <div className="mt-3 p-3 bg-slate-900 border border-blue-500/50 rounded animate-enter flex justify-between items-start">
                                <div>
                                    <div className="text-[10px] text-blue-400 mb-1 font-bold font-mono">RESULT</div>
                                    <div className="text-lg text-white font-bold leading-relaxed">{transResult}</div>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => speakJapanese(transResult)} className="text-blue-400 hover:text-white p-1"><Volume2 size={18} /></button>
                                    <button onClick={() => copyText(transResult)} className="text-slate-500 hover:text-white p-1"><Copy size={16} /></button>
                                </div>
                            </div>
                        )}

                        {/* History (Recent 3) */}
                        {history.length > 0 && !transResult && (
                            <div className="mt-3 pt-3 border-t border-[var(--border-color)]">
                                <div className="text-[10px] text-slate-500 mb-2">Ë©†Âî±Á¥ÄÈåÑ</div>
                                <div className="space-y-2">
                                    {history.slice(0,3).map(h => (
                                        <div key={h.id} className="flex justify-between items-center text-xs text-slate-400 bg-[var(--bg-input)] p-2 rounded">
                                            <span>{h.input} ‚Æï <span className="text-[var(--text-main)]">{h.output}</span></span>
                                            <button onClick={() => copyText(h.output)}><Copy size={12}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                     </div>

                     {/* Spell Filters */}
                     <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                        {[
                            {id: 'all', label: 'ÂÖ®ÈÉ®'},
                            {id: 'defense', label: 'üõ°Ô∏è Èò≤Á¶¶'},
                            {id: 'support', label: 'ü©π ÊîØÊè¥'},
                            {id: 'interaction', label: 'üó£Ô∏è ‰∫§ÊµÅ'},
                            {id: 'exploration', label: 'üó∫Ô∏è Êé¢Á¥¢'},
                            {id: 'custom', label: '‚ú® Ëá™Ë®Ç'}
                        ].map(f => (
                            <button 
                                key={f.id} 
                                onClick={()=>setFilterType(f.id)}
                                className={`px-3 py-1.5 rounded-full text-xs font-bold border whitespace-nowrap transition-colors ${filterType === f.id ? 'bg-purple-600 border-purple-400 text-white' : 'bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-muted)] hover:bg-slate-700'}`}
                            >
                                {f.label}
                            </button>
                        ))}
                     </div>

                     {/* Spells Grid */}
                     <div className="grid grid-cols-2 gap-3">
                        <div onClick={()=>setIsAddingSpell(true)} className="bg-[var(--bg-card)] border-2 border-dashed border-[var(--border-color)] p-3 rounded hover:border-purple-500 transition cursor-pointer flex flex-col items-center justify-center text-[var(--text-muted)] hover:text-purple-400 min-h-[100px]">
                            <Plus size={24} className="mb-2"/>
                            <span className="text-xs font-bold">Êí∞ÂØ´Êñ∞ÂííË™û</span>
                        </div>
                        {filteredSpells.map((spell, idx) => (
                            <div key={idx} onClick={() => setSelectedSpell(spell)} className="bg-[var(--bg-card)] border border-[var(--border-color)] p-3 rounded hover:border-purple-500 transition group cursor-pointer relative overflow-hidden flex flex-col items-center text-center shadow-md active:scale-[0.98]">
                                <div className="text-3xl mb-2 group-hover:scale-110 transition-transform">{spell.icon || "‚ú®"}</div>
                                <div className="font-bold text-purple-300 text-sm mb-1">{spell.title}</div>
                                <div className="text-[10px] text-[var(--text-muted)] line-clamp-1">{spell.zh}</div>
                                <div className="absolute top-2 right-2 text-slate-500 hover:text-white" onClick={(e) => { e.stopPropagation(); speakJapanese(spell.jp); }}><Volume2 size={16} /></div>
                            </div>
                        ))}
                     </div>

                     {/* Add Custom Spell Modal */}
                     {isAddingSpell && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-slate-900 border-2 border-purple-600 w-full max-w-sm rounded p-5">
                                <h3 className="text-purple-400 font-bold mb-4">Êí∞ÂØ´Êñ∞ÂííË™û</h3>
                                <div className="space-y-3">
                                    <input type="text" placeholder="Ê®ôÈ°å (‰æã: Áî≤ÊÆºÈ°ûÈÅéÊïè)" value={newSpellData.title} onChange={e=>setNewSpellData({...newSpellData,title:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <textarea placeholder="Êó•ÊñáÂÖßÂÆπ" value={newSpellData.jp} onChange={e=>setNewSpellData({...newSpellData,jp:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white h-20"/>
                                    <input type="text" placeholder="ÁæÖÈ¶¨ÊãºÈü≥ (ÈÅ∏Â°´)" value={newSpellData.romaji} onChange={e=>setNewSpellData({...newSpellData,romaji:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <input type="text" placeholder="‰∏≠ÊñáÂÇôË®ª (ÈÅ∏Â°´)" value={newSpellData.zh} onChange={e=>setNewSpellData({...newSpellData,zh:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <button onClick={saveCustomSpell} className="w-full bg-purple-600 text-white font-bold py-2 rounded">ÂÑ≤Â≠òÂííË™û</button>
                                    <button onClick={()=>setIsAddingSpell(false)} className="w-full text-slate-500 text-xs mt-2">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Spell Detail Modal */}
                     {selectedSpell && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-enter" onClick={() => setSelectedSpell(null)}>
                            <div className="bg-slate-900 border-4 border-purple-500 p-6 rounded-lg max-w-sm w-full relative shadow-[0_0_50px_rgba(168,85,247,0.5)] flex flex-col items-center" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelectedSpell(null)} className="absolute top-2 right-2 text-slate-400 hover:text-white p-2"><X size={24} /></button>
                                <div className="text-8xl mb-6 animate-bounce">{selectedSpell.icon || "‚ú®"}</div>
                                <div className="text-2xl font-bold text-purple-300 mb-2 w-full text-center">{selectedSpell.title}</div>
                                {selectedSpell.romaji && <div className="text-xs text-purple-400/80 mb-4 font-mono">{selectedSpell.romaji}</div>}
                                
                                <div className="bg-white text-black p-6 rounded-lg mb-4 shadow-inner w-full flex flex-col items-center relative group">
                                    <div className="text-2xl font-black leading-snug text-center mb-2">{selectedSpell.jp}</div>
                                    <div className="flex gap-4 mt-2">
                                        <button onClick={() => speakJapanese(selectedSpell.jp)} className="text-purple-600 p-2 bg-purple-100 rounded-full hover:bg-purple-200"><Volume2 size={24} /></button>
                                        <button onClick={() => copyText(selectedSpell.jp)} className="text-slate-600 p-2 bg-slate-100 rounded-full hover:bg-slate-200"><Copy size={24} /></button>
                                    </div>
                                </div>
                                <div className="text-lg text-slate-400 text-center">{selectedSpell.zh}</div>
                                <div className="mt-8 text-[10px] text-purple-500 font-mono tracking-[0.2em] animate-pulse">SPELL CARD ACTIVE</div>
                            </div>
                        </div>
                     )}
                </div>
            );
        };

        // --- Info View (Hub) ---
        const InfoView = () => {
            const { user, checklist, setChecklist, tickets, setTickets, tripId, setTripId, weatherTemp, setQuests, isOffline, exchangeRate, stats, weatherForecast, quests } = useContext(AppContext);
            const [newTicket, setNewTicket] = useState({ title: "", type: "Flight", image: "" });
            const [isEditingTicket, setIsEditingTicket] = useState(false);
            const [tempTripId, setTempTripId] = useState(tripId);
            const ticketInputRef = useRef(null);
            
            // Currency Calculator State
            const [calcAmount, setCalcAmount] = useState("");
            const [calcDir, setCalcDir] = useState('J2T'); // 'J2T' (JPY->TWD) or 'T2J' (TWD->JPY)
            
            // SOS Modal State
            const [sosModalContent, setSosModalContent] = useState(null);
            // Call Confirmation State
            const [confirmCall, setConfirmCall] = useState(null);
            // Settings Modal State
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [apiKeyInput, setApiKeyInput] = useState(localStorage.getItem('gemini_api_key') || '');
            
            // Ticket Lightbox State
            const [viewingTicket, setViewingTicket] = useState(null);
            
            // Checklist Add State
            const [newItemText, setNewItemText] = useState("");

            const handleTicketUpload = (e) => {
                const file=e.target.files[0]; if(!file)return;
                const r=new FileReader(); r.onload=ev=>{ 
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const s = 600/img.width; 
                        c.width=Math.min(img.width, 600); 
                        c.height=img.height*s; 
                        ctx.drawImage(img,0,0,c.width,c.height);
                        setNewTicket({...newTicket, image: c.toDataURL('image/jpeg', 0.4)});
                    }; img.src = ev.target.result;
                }; r.readAsDataURL(file);
            };
            const saveTicket = () => { if(newTicket.title){ setTickets([...tickets, {id: Date.now(), ...newTicket}]); setIsEditingTicket(false); setNewTicket({title:"",type:"Flight",image:""}); }};
            const deleteTicket = (id) => { if(confirm("Âà™Èô§Á•®Âà∏Ôºü")) setTickets(tickets.filter(t=>t.id!==id)); };
            const joinTrip = () => { if(confirm("ÂàáÊèõÊóÖÁ®ãÂ∞áÊúÉÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÔºåÁ¢∫ÂÆöÂóéÔºü")) { setTripId(tempTripId); localStorage.setItem('tripId', tempTripId); window.location.reload(); }};
            const resetQuests = () => { if(confirm("‚ö†Ô∏è Ë≠¶ÂëäÔºöÈÄôÂ∞áÊúÉÊ∏ÖÈô§ÊâÄÊúâË°åÁ®ãËÆäÊõ¥‰∏¶ÊÅ¢Âæ©È†êË®≠ÂÄº„ÄÇÁ¢∫ÂÆöÂóéÔºü")) { setQuests(INITIAL_QUEST_DATA); alert("Â∑≤ÈáçÁΩÆË°åÁ®ãÔºÅ"); } };
            
            const addChecklistItem = () => {
                if(!newItemText.trim()) return;
                setChecklist([...checklist, { id: Date.now(), text: newItemText, checked: false }]);
                setNewItemText("");
            };
            const deleteChecklistItem = (id) => {
                if(confirm("Âà™Èô§È†ÖÁõÆ?")) setChecklist(checklist.filter(i => i.id !== id));
            };
            
            const copyShareLink = () => {
                const url = window.location.origin + window.location.pathname + '?tripId=' + tripId;
                navigator.clipboard.writeText(url);
                alert("Â∑≤Ë§áË£ΩÂàÜ‰∫´ÈÄ£ÁµêÔºÅ\n" + url);
            };
            
            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', apiKeyInput);
                setIsSettingsOpen(false);
                alert("API Key Â∑≤ÂÑ≤Â≠òÔºÅ");
            };

            // Improved Weather/Outfit Logic (Reuse)
            const getWeatherDetails = (t) => {
                if (t <= 5) return { text: "Ê•µÂØí", icon: Snowflake, color: "text-blue-300" };
                if (t <= 12) return { text: "ÂØíÂÜ∑", icon: Wind, color: "text-cyan-300" };
                if (t <= 20) return { text: "Ê∂ºÁàΩ", icon: Cloud, color: "text-green-300" };
                if (t <= 28) return { text: "Ê∫´Êöñ", icon: Sun, color: "text-orange-300" };
                return { text: "ÁÇéÁÜ±", icon: Flame, color: "text-red-400" };
            };
            
            // Guild Rank Logic
            const getRank = (xp) => {
                const lv = Math.floor(xp/1000) + 1;
                if (lv >= 10) return { title: "ÂÇ≥Â•áÈÅä‰ø†", color: "text-yellow-400" };
                if (lv >= 7) return { title: "Ë≥áÊ∑±ÂöÆÂ∞é", color: "text-purple-400" };
                if (lv >= 4) return { title: "‰∏≠Á¥öÊé¢Èö™ÂÆ∂", color: "text-blue-400" };
                return { title: "ÂàùÁ¥öÂÜíÈö™ËÄÖ", color: "text-slate-400" };
            };
            const rank = getRank(stats.xp);

            return (
                <div className="w-full animate-enter pb-32 space-y-4">
                    
                    {/* Settings Button */}
                    <div className="flex justify-end">
                        <button onClick={()=>setIsSettingsOpen(true)} className="text-slate-400 hover:text-white p-2 bg-slate-800 rounded-full"><Settings size={18}/></button>
                    </div>

                    {/* Guild Card (Replaces simple Trip ID) */}
                    <div className="guild-card p-5 rounded-xl shadow-2xl relative">
                        <div className="relative z-10 flex justify-between items-start">
                            <div>
                                <div className={`text-xs font-bold uppercase tracking-widest ${rank.color} mb-1`}>{rank.title}</div>
                                <div className="text-3xl font-black text-white italic tracking-tighter">LV. {Math.floor(stats.xp/1000)+1}</div>
                                <div className="text-[10px] text-slate-400 mt-1">Á¥ØÁ©çÁ∂ìÈ©ó: {stats.xp} XP</div>
                            </div>
                            <Award className={`w-12 h-12 ${rank.color} opacity-80`} />
                        </div>
                        <div className="mt-6 relative z-10 bg-black/40 p-3 rounded border border-white/10 backdrop-blur-sm">
                            <div className="text-[9px] text-slate-400 uppercase font-mono mb-1 flex items-center gap-1"><Users size={9}/> Trip ID (Share Code)</div>
                            <div className="flex gap-2">
                                <input type="text" value={tempTripId} onChange={e=>setTempTripId(e.target.value)} className="flex-1 bg-transparent border-none text-white font-mono text-sm outline-none tracking-wider font-bold" />
                                <button onClick={copyShareLink} className="text-[10px] bg-blue-600/50 hover:bg-blue-600 px-3 rounded text-white transition flex items-center gap-1"><LinkIcon size={10}/> Ë§áË£Ω</button>
                                <button onClick={joinTrip} className="text-[10px] bg-white/10 hover:bg-white/20 px-3 rounded text-white transition">ÂàáÊèõ</button>
                            </div>
                        </div>
                    </div>

                    {/* Quick Links */}
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={() => window.open('https://www.vjw.digital.go.jp/', '_blank')} className="bg-[var(--bg-card)] p-2 rounded flex flex-col items-center gap-1 hover:bg-slate-700 transition">
                            <QrCode size={20} className="text-pink-400"/>
                            <span className="text-[9px]">VJW</span>
                        </button>
                        <button onClick={() => window.open('https://www.google.com/maps', '_blank')} className="bg-[var(--bg-card)] p-2 rounded flex flex-col items-center gap-1 hover:bg-slate-700 transition">
                            <Map size={20} className="text-green-400"/>
                            <span className="text-[9px]">Âú∞Âúñ</span>
                        </button>
                        <button onClick={() => window.open('https://www.nagoya-info.jp/common/pdf/nagoya_route_map_en.pdf', '_blank')} className="bg-[var(--bg-card)] p-2 rounded flex flex-col items-center gap-1 hover:bg-slate-700 transition">
                            <Train size={20} className="text-blue-400"/>
                            <span className="text-[9px]">Âú∞ÈêµÂúñ</span>
                        </button>
                    </div>

                    {/* 5-Day Weather Forecast */}
                    <div className="bg-[var(--bg-card)] border border-[var(--border-color)] p-3 rounded overflow-hidden">
                        <h3 className="font-bold text-[var(--text-main)] text-xs mb-3 flex items-center gap-2"><CloudSun size={14}/> Êú™‰æÜÂ§©Ê∞£È†êÂ†±</h3>
                        <div className="flex gap-3 overflow-x-auto no-scrollbar pb-1">
                            {quests.map((q, idx) => {
                                const w = weatherForecast[idx] || {};
                                if (!w.max) return null;
                                const info = getWeatherDetails(w.max);
                                const WIcon = info.icon;
                                return (
                                    <div key={idx} className="flex-shrink-0 w-20 bg-[var(--bg-input)] p-2 rounded border border-[var(--border-color)] flex flex-col items-center text-center">
                                        <div className="text-[9px] text-[var(--text-muted)] mb-1">{idx===0?'‰ªäÂ§©':`Day ${idx}`}</div>
                                        <WIcon size={20} className={info.color} />
                                        <div className="text-xs font-bold text-[var(--text-main)] mt-1">{w.max}¬∞</div>
                                        <div className="text-[9px] text-[var(--text-muted)]">{w.min}¬∞</div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    
                    {/* Emergency Hub (Existing) */}
                    <div className="grid grid-cols-3 gap-2">
                         <button onClick={() => setConfirmCall({num: '110', name: 'Ë≠¶ÂØü'})} className="bg-red-900/40 border border-red-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-red-900/60 transition">
                             <Siren className="text-red-500" size={24} />
                             <span className="text-xs font-bold text-red-200">Ë≠¶ÂØü 110</span>
                         </button>
                         <button onClick={() => setConfirmCall({num: '119', name: 'ÊïëË≠∑'})} className="bg-red-900/40 border border-red-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-red-900/60 transition">
                             <div className="relative"><Siren className="text-red-500" size={24} /><div className="absolute -top-1 -right-1 w-2 h-2 bg-white rounded-full animate-ping"></div></div>
                             <span className="text-xs font-bold text-red-200">ÊïëË≠∑ 119</span>
                         </button>
                         <button onClick={() => setSosModalContent('card')} className="bg-orange-900/40 border border-orange-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-orange-900/60 transition">
                             <CreditCard className="text-orange-500" size={24} />
                             <span className="text-xs font-bold text-orange-200">Ê±ÇÂä©Â≠óÂç°</span>
                         </button>
                    </div>

                    {/* Settings Modal (API Key) */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 animate-in fade-in">
                            <div className="bg-slate-900 border-2 border-blue-500 w-full max-w-sm rounded-xl p-5 shadow-2xl relative">
                                <button onClick={() => setIsSettingsOpen(false)} className="absolute top-3 right-3 text-slate-500"><X size={20}/></button>
                                <h3 className="text-blue-400 font-bold mb-4 flex items-center gap-2"><Settings size={18}/> Á≥ªÁµ±Ë®≠ÂÆö</h3>
                                <div className="mb-4">
                                    <div className="text-xs text-slate-400 mb-2 font-bold flex items-center gap-1"><Key size={12}/> Gemini API Key</div>
                                    <input type="password" value={apiKeyInput} onChange={e=>setApiKeyInput(e.target.value)} placeholder="Ë≤º‰∏äÊÇ®ÁöÑ API Key" className="w-full bg-slate-800 border-2 border-slate-600 rounded-lg py-2 px-3 text-white text-xs outline-none focus:border-blue-500" />
                                    <p className="text-[9px] text-slate-500 mt-2">Ê≠§ Key ÂÉÖÂÑ≤Â≠òÊñºÊÇ®ÁöÑÁÄèË¶ΩÂô®Êú¨Âú∞Á´ØÔºåÁî®ÊñºÁøªË≠ØËàá OCR ÂäüËÉΩ„ÄÇ</p>
                                </div>
                                <button onClick={saveApiKey} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition text-xs">ÂÑ≤Â≠òË®≠ÂÆö</button>
                            </div>
                        </div>
                    )}

                    {/* Call Confirmation Modal (Safeguard) (Existing) */}
                    {confirmCall && (
                        <div className="fixed inset-0 z-[70] bg-black/90 flex flex-col items-center justify-center p-6 animate-in fade-in duration-200" onClick={() => setConfirmCall(null)}>
                            <div className="bg-slate-900 border-2 border-red-500 p-6 rounded-xl w-full max-w-sm text-center shadow-[0_0_50px_rgba(239,68,68,0.5)] relative overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent animate-pulse"></div>
                                <Siren className="w-16 h-16 text-red-500 mx-auto mb-4 animate-bounce" />
                                <h3 className="text-xl font-bold text-white mb-2">‚ö†Ô∏è Á∑äÊÄ•Êí•ËôüÁ¢∫Ë™ç</h3>
                                <p className="text-slate-400 mb-6 text-sm">Âç≥Â∞áÊí•Êâì <span className="text-red-400 font-bold text-lg mx-1">{confirmCall.name} ({confirmCall.num})</span></p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setConfirmCall(null)} className="py-3 rounded-lg border border-slate-600 text-slate-400 hover:bg-slate-800 transition">ÂèñÊ∂à</button>
                                    <button onClick={() => { window.open(`tel:${confirmCall.num}`); setConfirmCall(null); }} className="py-3 rounded-lg bg-red-600 text-white font-bold shadow-[0_0_15px_rgba(220,38,38,0.5)] hover:bg-red-500 transition flex items-center justify-center gap-2"><Phone size={16}/> Á¢∫Ë™çÊí•Êâì</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SOS Modal (Existing) */}
                    {sosModalContent && (
                        <div className="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center p-6 animate-in fade-in duration-200" onClick={() => setSosModalContent(null)}>
                            <div className="text-center space-y-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <h3 className="text-red-500 font-bold text-xl mb-4 border-b border-red-900 pb-2">EMERGENCY CARD</h3>
                                <div className="space-y-4">
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">Ë´ãÂπ´ÊàëÂè´ÊïëË≠∑Ëªä</p>
                                        <p className="text-3xl font-black">ÊïëÊÄ•Ëªä„ÇíÂëº„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                                    </div>
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">ÊàëËø∑Ë∑Ø‰∫Ü</p>
                                        <p className="text-3xl font-black">ÈÅì„Å´Ëø∑„ÅÑ„Åæ„Åó„Åü</p>
                                    </div>
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">ÊàëÊòØÂè∞ÁÅ£‰∫∫</p>
                                        <p className="text-3xl font-black">ÁßÅ„ÅØÂè∞Êπæ‰∫∫„Åß„Åô</p>
                                    </div>
                                </div>
                                <button onClick={() => setSosModalContent(null)} className="mt-8 text-slate-500 text-sm border border-slate-700 px-6 py-2 rounded-full">ÈóúÈñâ (Close)</button>
                            </div>
                        </div>
                    )}

                    {/* Currency Converter Widget */}
                    <div className="bg-[var(--bg-card)] border border-[var(--border-color)] p-4 rounded">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-[var(--text-main)] flex items-center gap-2"><Calculator size={16}/> Âø´ÈÄüÂåØÁéáÊèõÁÆó</h3>
                            <button onClick={()=>setCalcDir(calcDir==='J2T'?'T2J':'J2T')} className="text-[10px] bg-slate-700 px-2 py-1 rounded border border-slate-600 flex items-center gap-1 hover:bg-slate-600 transition">
                                {calcDir==='J2T' ? 'Êó• ‚Æï Âè∞' : 'Âè∞ ‚Æï Êó•'} <RotateCcw size={10}/>
                            </button>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex-1 relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">{calcDir==='J2T'?'JPY':'TWD'}</span>
                                <input type="number" placeholder="ÈáëÈ°ç" value={calcAmount} onChange={(e) => setCalcAmount(e.target.value)} className="w-full bg-[var(--bg-input)] border border-[var(--border-color)] rounded pl-10 p-2 text-[var(--text-main)] outline-none focus:border-yellow-500 font-mono" />
                            </div>
                            <ArrowRightLeft className="text-[var(--text-muted)]" size={16} />
                            <div className="flex-1 bg-[var(--bg-input)] border border-[var(--border-color)] rounded p-2 text-right font-mono text-yellow-400 font-bold flex justify-between items-center px-3">
                                <span className="text-[10px] text-slate-500">{calcDir==='J2T'?'TWD':'JPY'}</span>
                                <span>{calcAmount ? `‚âà ${Math.round(calcDir==='J2T' ? calcAmount * exchangeRate : calcAmount / exchangeRate).toLocaleString()}` : "0"}</span>
                            </div>
                        </div>
                    </div>

                    {/* Tickets Wallet */}
                    <div className="bg-[var(--bg-card)] border border-green-500 p-4 rounded">
                        <div className="flex justify-between mb-3"><h3 className="font-bold text-green-300 flex items-center gap-2"><Ticket size={16}/> Á•®Âà∏Â§æ (Wallet)</h3><button onClick={()=>setIsEditingTicket(true)} className="text-xs bg-slate-700 px-2 rounded"><PlusCircle size={14}/></button></div>
                        {isEditingTicket && <div className="mb-4 bg-slate-900 p-3 rounded"><input type="text" placeholder="Á•®Âà∏ÂêçÁ®± (Â¶Ç: ËôéËà™ÂéªÁ®ã)" value={newTicket.title} onChange={e=>setNewTicket({...newTicket,title:e.target.value})} className="w-full mb-2 bg-slate-800 border-slate-600 p-2 text-xs text-white"/><input type="file" onChange={handleTicketUpload} className="text-xs text-slate-400 mb-2"/><button onClick={saveTicket} className="w-full bg-green-600 text-white text-xs py-1 rounded">Êñ∞Â¢ûÁ•®Âà∏</button></div>}
                        <div className="grid grid-cols-2 gap-2">
                            {tickets.map(t=> (
                                <div key={t.id} onClick={()=>t.image && setViewingTicket(t)} className="bg-[var(--bg-input)] p-2 rounded border border-[var(--border-color)] relative cursor-pointer ticket-edge group hover:border-green-500/50 transition">
                                    <div className="text-xs font-bold mb-1">{t.title}</div>
                                    <div className="text-[10px] bg-[var(--bg-card)] px-1 rounded inline-block">{t.type}</div>
                                    {t.image && <div className="absolute top-2 right-2 text-green-500"><ImageIcon size={14}/></div>}
                                    <button onClick={(e)=>{e.stopPropagation();deleteTicket(t.id)}} className="absolute bottom-2 right-2 text-red-400 opacity-0 group-hover:opacity-100 transition"><Trash2 size={12}/></button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Ticket Lightbox */}
                    {viewingTicket && (
                        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-in fade-in zoom-in duration-200" onClick={() => setViewingTicket(null)}>
                            <div className="max-w-full max-h-full relative">
                                <img src={viewingTicket.image} className="max-w-full max-h-[80vh] rounded shadow-2xl object-contain" />
                                <div className="absolute -bottom-10 left-0 w-full text-center text-white font-bold">{viewingTicket.title}</div>
                                <button onClick={() => setViewingTicket(null)} className="absolute -top-12 right-0 text-white p-2 bg-slate-800/50 rounded-full"><X size={24}/></button>
                            </div>
                        </div>
                    )}

                    {/* Checklist */}
                    <div className="bg-[var(--bg-card)] border border-[var(--border-color)] p-4 rounded">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-[var(--text-main)] flex gap-2"><Shield size={16}/> Ë£ùÂÇôÊ™¢Êü•</h3>
                        </div>
                        <div className="space-y-1 mb-3">
                            {checklist.map(i => (
                                <div key={i.id} onClick={()=>setChecklist(checklist.map(x=>x.id===i.id?{...x,checked:!x.checked}:x))} className={`flex items-center gap-2 p-2 rounded border border-[var(--border-color)] group cursor-pointer ${i.checked?'opacity-50 line-through bg-slate-900':'bg-[var(--bg-card)]'}`}>
                                    <div className={`w-4 h-4 border ${i.checked?'bg-green-600':'border-slate-500'} rounded-sm flex items-center justify-center`}>{i.checked&&<Check size={12} className="text-white"/>}</div>
                                    <span className="text-xs flex-1">{i.text}</span>
                                    <button onClick={(e)=>{e.stopPropagation(); deleteChecklistItem(i.id)}} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100"><Trash2 size={12}/></button>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input type="text" placeholder="Êñ∞Â¢ûÁâ©ÂìÅ..." value={newItemText} onChange={e=>setNewItemText(e.target.value)} className="flex-1 bg-[var(--bg-input)] border border-[var(--border-color)] rounded p-2 text-xs text-[var(--text-main)]"/>
                            <button onClick={addChecklistItem} className="bg-slate-700 text-white px-3 rounded text-xs"><Plus size={14}/></button>
                        </div>
                    </div>

                    <button onClick={resetQuests} className="w-full bg-red-900/30 border border-red-900 text-red-400 py-3 rounded text-xs flex items-center justify-center gap-2 mt-8 hover:bg-red-900/50 transition"><RotateCcw size={14}/> ‚ö†Ô∏è ÈáçÁΩÆË°åÁ®ãË≥áÊñô (‰øÆÂæ©Áº∫Â§±)</button>
                </div>
            );
        }

        // --- App Provider ---
        const AppProvider = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('quest');
            const [activeLevel, setActiveLevel] = useState(0);
            const [tripId, setTripId] = useState(localStorage.getItem('tripId') || ''); 
            const [exchangeRate, setExchangeRate] = useState(0.22);
            const [countdown, setCountdown] = useState("");
            const [weatherForecast, setWeatherForecast] = useState({});
            const [weatherTemp, setWeatherTemp] = useState(15); 
            const [isLightMode, setIsLightMode] = useState(false); // Outdoor Mode

            useEffect(() => {
                const initAuth = async () => { 
                    // Check URL for tripId sharing
                    const urlParams = new URLSearchParams(window.location.search);
                    const sharedTripId = urlParams.get('tripId');
                    if (sharedTripId) {
                        setTripId(sharedTripId);
                        localStorage.setItem('tripId', sharedTripId);
                    }

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Custom token auth failed", e);
                            if (USE_REAL_GOOGLE_AUTH) await signInWithPopup(getAuth(app), new GoogleAuthProvider()).catch(console.error);
                            else await signInAnonymously(getAuth(app));
                        }
                    } else if (USE_REAL_GOOGLE_AUTH) {
                        await signInAnonymously(getAuth(app)); 
                    }
                };
                
                initAuth();

                onAuthStateChanged(getAuth(app), u => { 
                    setUser(u); setAuthLoading(false); 
                    if(u && !tripId) { const tid = u.uid.substring(0,6); setTripId(tid); localStorage.setItem('tripId', tid); }
                });
            }, []);

            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo').then(r=>r.json()).then(data=>{
                    const map = {}; data.daily.time.forEach((t, i) => { map[i] = { max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weathercode[i] }; });
                    setWeatherForecast(map);
                }).catch(console.error);
                fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r=>r.json()).then(d=>setExchangeRate(d.rates.TWD)).catch(console.error);
                // Real-time for InfoView
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&current_weather=true').then(r=>r.json()).then(d=>{ if(d?.current_weather?.temperature) setWeatherTemp(d.current_weather.temperature); }).catch(console.log);

                const targetDate = new Date('2026-03-02T16:45:00').getTime();
                const interval = setInterval(() => {
                    const now = new Date();
                    const d = targetDate - now.getTime();
                    if(d<0) setCountdown("ÈÄ≤Ë°å‰∏≠"); else setCountdown(`${Math.floor(d/(1000*60*60*24))}Â§©${Math.floor((d%(1000*60*60*24))/(1000*60*60))}ÊôÇ`);
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // Firestore Data (using tripId) with offline fallback
            const [checklist, setChecklist, checklistOffline] = useFirestoreData(user, tripId, 'checklist', INITIAL_CHECKLIST);
            const [expenses, setExpenses, expensesOffline] = useFirestoreData(user, tripId, 'expenses', INITIAL_EXPENSES);
            const [quests, setQuests, questsOffline] = useFirestoreData(user, tripId, 'quests', INITIAL_QUEST_DATA);
            const [shoppingList, setShoppingList, shoppingOffline] = useFirestoreData(user, tripId, 'shopping', []);
            const [tickets, setTickets, ticketsOffline] = useFirestoreData(user, tripId, 'tickets', []);
            const [settingsData, updateSettings, settingsOffline] = useFirestoreData(user, tripId, 'settings', { budget: 100000, cashBudget: 50000, icBudget: 3000 }, true);
            const [stamps, setStamps, stampsOffline] = useFirestoreData(user, tripId, 'guide_stamps', []);
            const [customSpells, setCustomSpells] = useFirestoreData(user, tripId, 'custom_spells', []);
            const [history, setHistory] = useFirestoreData(user, tripId, 'trans_history', []);
            
            const isOffline = checklistOffline || expensesOffline || questsOffline; // Global offline status

            const budget = settingsData?.budget || 100000;
            const setBudget = (val) => updateSettings({ ...settingsData, budget: val });
            
            // Dynamic Stats Calculation
            const stats = useMemo(() => {
                let completedCount = 0;
                let dayEvents = 0;
                let dayCompleted = 0;
                
                quests.forEach((q, i) => {
                    q.events.forEach(e => {
                        if(e.completed) completedCount++;
                        if(i === activeLevel) { dayEvents++; if(e.completed) dayCompleted++; }
                    });
                });

                const totalSpent = expenses.reduce((a,c)=>a+c.cost,0);
                
                return {
                    xp: completedCount * 150,
                    goldRemaining: budget - totalSpent,
                    fatigue: dayEvents > 0 ? Math.round((dayCompleted / dayEvents) * 100) : 0
                };
            }, [quests, expenses, budget, activeLevel]);

            // Fix: Re-define speakJapanese inside Context correctly to capture 'text'
            const speakJapaneseFixed = useCallback((text) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';
                u.rate = 0.7; // Ë®≠ÂÆöË™ûÈÄüÁÇ∫ 0.7
                
                // Ensure voices are loaded
                const setVoice = () => {
                    const voices = window.speechSynthesis.getVoices();
                    const jpVoice = voices.find(v => v.lang === 'ja-JP' || v.lang === 'ja_JP' || v.name.includes('Kyoko') || v.name.includes('Google Êó•Êú¨Ë™û') || v.name.includes('Microsoft Haruka'));
                    if (jpVoice) u.voice = jpVoice;
                    window.speechSynthesis.speak(u);
                };

                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = setVoice;
                } else {
                    setVoice();
                }
            }, []);

            // Re-create value object with fixed function
            const contextValueFixed = useMemo(() => ({
                 user, tripId, setTripId, checklist, setChecklist, expenses, setExpenses, quests, setQuests, budget, setBudget,
                 shoppingList, setShoppingList, tickets, setTickets, activeTab, setActiveTab, activeLevel, setActiveLevel, 
                 countdown, exchangeRate, weatherForecast, weatherTemp, speakJapanese: speakJapaneseFixed,
                 stats, isOffline, settingsData, updateSettings, stamps, setStamps, customSpells, setCustomSpells, history, setHistory,
                 isLightMode, setIsLightMode
            }), [user, tripId, checklist, expenses, quests, shoppingList, tickets, budget, activeTab, activeLevel, countdown, exchangeRate, weatherForecast, weatherTemp, speakJapaneseFixed, stats, isOffline, settingsData, updateSettings, stamps, customSpells, history, isLightMode]);


            if (authLoading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white"><Loader2 className="animate-spin text-yellow-500" size={40}/></div>;
            if (!user) return <LoginView onLogin={() => signInWithPopup(getAuth(app), new GoogleAuthProvider())} />;

            return (
                <div className={isLightMode ? "light-mode" : ""}>
                    <AppContext.Provider value={contextValueFixed}><MainLayout /></AppContext.Provider>
                </div>
            );
        };

        const MainLayout = () => {
            const { activeTab, setActiveTab, isLightMode, setIsLightMode } = useContext(AppContext);
            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto shadow-2xl border-x border-slate-800 relative bg-[var(--bg-main)] transition-colors duration-300">
                    <div className="w-full mb-6 border-b border-[var(--border-color)] pb-4 text-center sticky top-0 bg-[var(--bg-main)]/95 backdrop-blur z-20 pt-4 px-4 shadow-lg flex items-center justify-between">
                        <div className="w-8"></div> {/* Spacer */}
                        <h1 className="text-xl font-bold tracking-widest text-yellow-400 mb-2 flex justify-center gap-2"><MapPin/> ÂêçÂè§Â±ãÂÜíÈö™Êó•Ë™å</h1>
                        <button onClick={() => setIsLightMode(!isLightMode)} className="w-8 h-8 rounded-full flex items-center justify-center bg-[var(--bg-input)] text-[var(--text-main)] hover:text-yellow-400 transition">
                            {isLightMode ? <SunMoon size={16}/> : <Sun size={16}/>}
                        </button>
                    </div>
                    <div className="px-4">
                        {activeTab === 'quest' && <QuestView />}
                        {activeTab === 'inventory' && <InventoryView />}
                        {activeTab === 'grimoire' && <GrimoireView />}
                        {activeTab === 'guide' && <GuideView />}
                        {activeTab === 'info' && <InfoView />}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-[var(--bg-main)] border-t border-[var(--border-color)] p-2 z-30 pb-safe grid grid-cols-5 gap-1">
                        <button onClick={()=>setActiveTab('quest')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='quest'?'text-yellow-400':'text-[var(--text-muted)]'}`}><Scroll size={20}/><span className="text-[10px]">‰ªªÂãô</span></button>
                        <button onClick={()=>setActiveTab('inventory')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='inventory'?'text-yellow-400':'text-[var(--text-muted)]'}`}><Coins size={20}/><span className="text-[10px]">Ë°åÂõä</span></button>
                        <button onClick={()=>setActiveTab('grimoire')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='grimoire'?'text-yellow-400':'text-[var(--text-muted)]'}`}><BookOpen size={20}/><span className="text-[10px]">È≠îÂ∞éÊõ∏</span></button>
                        <button onClick={()=>setActiveTab('guide')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='guide'?'text-yellow-400':'text-[var(--text-muted)]'}`}><Compass size={20}/><span className="text-[10px]">Â∞éË¶Ω</span></button>
                        <button onClick={()=>setActiveTab('info')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='info'?'text-yellow-400':'text-[var(--text-muted)]'}`}><Info size={20}/><span className="text-[10px]">Ë≥áË®ä</span></button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AppProvider />);

    </script>
</body>
</html>