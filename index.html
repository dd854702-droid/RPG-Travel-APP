<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêçÂè§Â±ãÂÜíÈö™Êó•Ë™å | Nagoya Adventure Log</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5ZCN5Y+qk9aF6ZqquZzmXlSIsInNob3J0X25hbWUiOiLlgpLpmprljp8iLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tanRpZmYtY29tLnRpbnlwaXguY29tL3VwbG9hZHMvMjAyMy0xMS0wNy9jbHVlc19tYXBfMTI4eDEyOC5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    <meta name="theme-color" content="#0f172a">
    
    <!-- 1. Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { slate: { 850: '#151e32', 900: '#0f172a' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards', 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    
    <!-- 3. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- 4. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "canvas-confetti": "https://esm.sh/canvas-confetti@1.6.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <!-- 5. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --bg-dark: #0f172a; --text-main: #e2e8f0; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glow-text { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .ticket-edge { mask-image: radial-gradient(circle at center, transparent 10px, black 11px); mask-position: -10px 50%; mask-size: 100% 200%; mask-repeat: no-repeat; }
        /* Markdown-like link style */
        .desc-link { color: #60a5fa; text-decoration: underline; text-underline-offset: 2px; }
        .hp-bar-container { background: #334155; border-radius: 4px; height: 12px; overflow: hidden; border: 1px solid #475569; }
        .hp-bar-fill { height: 100%; transition: width 0.5s ease-out, background-color 0.3s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import confetti from 'canvas-confetti';
        import { 
            Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, 
            Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
            Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Thermometer,
            TrendingUp, Save, Clock, Map, PieChart, Volume2, Image as ImageIcon, Navigation, Timer, Bus, Car, Ticket,
            Compass, Search, ArrowRightLeft, Landmark, LogOut, User, Star, Check, FileText, CreditCard, Wallet, Users,
            CloudRain, CloudSun, Sun, Share2, Copy, RotateCcw, ScanLine, Calculator, Link as LinkIcon, WifiOff,
            Umbrella, Wind, Snowflake, Flame, Activity, Banknote, HelpCircle
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, enableIndexedDbPersistence } from 'firebase/firestore';

        // --- CONFIGURATION ---
        const USE_REAL_GOOGLE_AUTH = true; 
        const userFirebaseConfig = {
            apiKey: "AIzaSyDuVNALTfclUEXxhlDEolTLX_68mkyW59k",
            authDomain: "rpg-travel-app.firebaseapp.com",
            projectId: "rpg-travel-app",
            storageBucket: "rpg-travel-app.firebasestorage.app",
            messagingSenderId: "120243575408",
            appId: "1:120243575408:web:eb941d7a7af5cd65ecf2b5",
            measurementId: "G-0ZSW6HSN2S"
        };

        const systemConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = (systemConfig) ? systemConfig : userFirebaseConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error:", e); }

        const AppContext = createContext();

        // --- Constants & Helpers ---
        const ICON_MAP = { Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle, Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Save, Clock, Map, PieChart, Volume2, ImageIcon, Navigation, Timer, Bus, Car, Ticket, Compass, Search, ArrowRightLeft, Landmark, Star, CreditCard, Wallet, Users, CloudRain, CloudSun, Sun, RotateCcw };
        
        const EXPENSE_ICONS = {
            loot: Utensils,
            travel: Train,
            save: Home,
            trade: ShoppingBag,
            other: HelpCircle
        };

        const SPELL_DATA = [ { icon: "üßÖ", title: "È©ÖÈô§Ëî•Ëä±", jp: "„Éç„ÇÆÊäú„Åç„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ã‰∏çË¶ÅÂä†Ëî•", type: "defense" }, { icon: "üßä", title: "ÂéªÂÜ∞Âíí", jp: "Ê∞∑„Å™„Åó„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÂéªÂÜ∞", type: "support" }, { icon: "üíß", title: "Âè¨ÂñöÊ∞¥", jp: "„ÅäÊ∞¥„Åè„Å†„Åï„ÅÑ", zh: "Ë´ãÁµ¶ÊàëÊ∞¥", type: "support" }, { icon: "üöª", title: "Â∞ãÊâæÂØÜÂÆ§", jp: "„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", zh: "ÂªÅÊâÄÂú®Âì™Ë£°", type: "exploration" }, { icon: "üßæ", title: "ÁµêÁÆóÂç∑Ëª∏", jp: "„Åä‰ºöË®à„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÁµêÂ∏≥", type: "interaction" }, { icon: "üì∏", title: "ÊîùÈ≠ÇË°ì", jp: "ÂÜôÁúü„ÇíÊíÆ„Å£„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü", zh: "ÂèØ‰ª•ÊãçÁÖßÂóéÔºü", type: "interaction" }, { icon: "üôè", title: "Á•àÊ±ÇË°ì", jp: "„Åì„Çå„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "ÊàëË¶ÅÈÄôÂÄã (ÊåáËèúÂñÆ)", type: "interaction" }, { icon: "ü•°", title: "Â∏∂Ëµ∞Ë°ì", jp: "ÊåÅ„Å°Â∏∞„Çä„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", zh: "Ë´ãÂπ´ÊàëÂ§ñÂ∏∂", type: "support" } ];
        const GUIDE_DETAILS = [ { id: 'nagoya_castle', title: 'ÂêçÂè§Â±ãÂüé', subtitle: 'ÈáëÈØ±ÈñÉËÄÄÁöÑÂ∞æÂºµÂæ∑Â∑ùÂÆ∂Â±ÖÂüé', tags: ['Ê≠∑Âè≤', 'ÁôæÂ§ßÂêçÂüé'], image: 'üèØ', desc: 'Êó•Êú¨‰∏âÂêçÂüé‰πã‰∏Ä„ÄÇ', content: { history: 'Áî±Âæ∑Â∑ùÂÆ∂Â∫∑Êñº1612Âπ¥Âª∫ÈÄ†„ÄÇ', features: '„ÄêÊú¨‰∏∏Âæ°ÊÆø„ÄëÂÖßÈÉ®ÈáëÁ¢ßËºùÁÖå„ÄÇ', tips: 'Êé®Ëñ¶‰∫å‰πã‰∏∏Â∫≠ÂúíÊï£Ê≠•„ÄÇ', warning: 'Â§©ÂÆàÈñ£ÁõÆÂâçÈñâÈ§®‰∏≠„ÄÇ' } }, { id: 'inuyama', title: 'Áä¨Â±±Âüé', subtitle: 'ÂúãÂØ∂‰∫îÂüé‰πã‰∏Ä', tags: ['ÂúãÂØ∂', 'È¢®ÊôØ'], image: 'üè∞', desc: 'Êó•Êú¨ÁèæÂ≠òÊúÄÂè§ËÄÅÁöÑÊú®ÈÄ†Â§©ÂÆàÈñ£„ÄÇ', content: { history: 'ÁπîÁî∞‰ø°Â∫∑Êñº1537Âπ¥Âª∫ÈÄ†„ÄÇ', features: 'Ê®ìÊ¢ØÈùûÂ∏∏Èô°Â≥≠„ÄÇ', tips: 'Â±±‰∏ãÊúâÁ≤âÁ¥ÖÊÑõÂøÉÁπ™È¶¨„ÄÇ', warning: 'Âª∫Ë≠∞Á©øËëó‰æøÊñºÊ¥ªÂãïÁöÑÊúçË£ù„ÄÇ' } }, { id: 'osu', title: 'Â§ßÈ†àÂïÜÂ∫óË°ó', subtitle: 'Ê∑∑Êê≠ÊñáÂåñÁôºÊ∫êÂú∞', tags: ['ÈÄõË°ó', 'ÁæéÈ£ü'], image: 'üõçÔ∏è', desc: 'ËûçÂêàÂè§Ëëó„ÄÅÂãïÊº´ËàáÁæéÈ£üÁöÑÊ¥ªÂäõÂïÜÂ∫óË°ó„ÄÇ', content: { history: 'ÈñÄÂâçÁî∫ÁôºÂ±ïËÄå‰æÜ„ÄÇ', features: 'Ë∂ÖÈÅé1200ÂÆ∂Â∫óÈã™„ÄÇ', tips: 'ÂøÖÂêÉÁÇ∏ÈõûËàáÁ≥∞Â≠ê„ÄÇ', warning: 'ÁØÑÂúçÂ§ßÂÆπÊòìËø∑Ë∑Ø„ÄÇ' } }, { id: 'atsuta', title: 'ÁÜ±Áî∞Á•ûÂÆÆ', subtitle: 'ÂøÉÈùàÂØÑË®óÂçÉÂπ¥Âè§Ââé', tags: ['Á•ûÁ§æ', 'Á•ûË©±'], image: '‚õ©Ô∏è', desc: '‰æõÂ•âËçâËñôÂäçÔºåÂú∞‰ΩçÂ¥áÈ´ò„ÄÇ', content: { history: 'ËøëÂÖ©ÂçÉÂπ¥Ê≠∑Âè≤„ÄÇ', features: '‰ø°Èï∑Â£Å„ÄÇ', tips: 'ÂèÉÊãúÂÆåÂêÉËì¨ËêäËªíÈ∞ªÈ≠öÈ£Ø„ÄÇ', warning: 'ËöäËü≤ËºÉÂ§ö„ÄÇ' } }, { id: 'sakae', title: 'Ê¶Æ / Á∂†Ê¥≤21', subtitle: 'ÊôÇÂ∞ö‰∏≠ÂøÉËàáÂ§úÊôØ', tags: ['Â§úÊôØ', 'Ë≥ºÁâ©'], image: 'üåÉ', desc: 'Á∂†Ê¥≤21ÁöÑÊ∞¥‰πãÂÆáÂÆôËàπÊòØÂøÖÊãçÊôØÈªû„ÄÇ', content: { history: 'Áèæ‰ª£ÂåñË±°Âæµ„ÄÇ', features: 'Â±ãÈ†ÇÂèØÊï£Ê≠•„ÄÇ', tips: 'ÊóÅÈÇäÊúâÈõªË¶ñÂ°î„ÄÇ', warning: 'Êôö‰∏äÈ¢®Â§ß„ÄÇ' } } ];
        const INITIAL_CHECKLIST = [ { id: 1, text: "Ë≠∑ÁÖß", checked: false }, { id: 2, text: "Á∂≤Âç°/Êº´ÈÅä", checked: false }, { id: 3, text: "Êó•Âπ£ÁèæÈáë", checked: false }, { id: 4, text: "Ë°åÂãïÈõªÊ∫ê", checked: false }, { id: 5, text: "Â∏∏Áî®Ëó•ÂìÅ", checked: false }, { id: 6, text: "VJWÊà™Âúñ", checked: false } ];
        const INITIAL_EXPENSES = [ { id: 1, item: "Ê©üÁ•®È†ê‰ªò", cost: 12000, type: "travel", date: "2025-10-15", method: "card", payer: "me" }, { id: 2, item: "‰ΩèÂÆøÈ†êË®Ç", cost: 8000, type: "save", date: "2025-11-20", method: "card", payer: "me" } ];
        const INITIAL_QUEST_DATA = [
            {
                day: 0,
                title: "Â∫èÁ´†: ÈôçËêΩËàáÊΩõÂÖ•",
                date: "2026-03-02",
                events: [
                { id: 'e0', time: "16:45", icon: "Plane", title: "ÂïüÁ®ã: Ê°ÉÂúíÊ©üÂ†¥", desc: "Êê≠‰πòËôéËà™ IT778 (16:45-20:25)", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e1', time: "20:25", icon: "MapPin", title: "ÊäµÈÅîÊñ∞Âú∞Âúñ", desc: "‰∏≠ÈÉ®ÂúãÈöõÊ©üÂ†¥ T2", type: "checkpoint", transportTime: "3h 40m", transportCost: 0, transportMode: "Plane", completed: false },
                { id: 'e2', time: "21:15", icon: "Footprints", title: "Á©øË∂äÈÄöÈÅì", desc: "ÂâçÂæÄ‰∫§ÈÄöÂª£Â†¥", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e3', time: "21:37", icon: "Train", title: "Êê≠‰πòÂêçÈêµÁâπÊÄ•", desc: "ÂæÄÂêçÂè§Â±ã/Â≤êÈòúÊñπÂêë", type: "travel", transportTime: "10m", transportCost: 1250, transportMode: "Train", completed: false },
                { id: 'e4', time: "22:08", icon: "MapPin", title: "ÊäµÈÅîÈáëÂ±±Á´ô", desc: "ÈóúÈçµËΩâ‰πòÈªû", type: "checkpoint", transportTime: "31m", transportCost: 0, transportMode: "Train", completed: false },
                { id: 'e5', time: "22:23", icon: "Train", title: "ËΩâ‰πòÂú∞‰∏ãÈêµ", desc: "ÂêçÂüéÁ∑ö (Âè≥Áí∞)", type: "travel", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e6', time: "22:40", icon: "Home", title: "Â≠òÊ™îÈªû: Trip & Sleep", desc: "Ëæ¶ÁêÜÂÖ•‰Ωè", type: "save", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                ]
            },
            {
                day: 1,
                title: "Á¨¨‰∏ÄÁ´†: Â∏ÇÂ†¥ËàáÁ•ûÊÆø",
                date: "2026-03-03",
                events: [
                { id: 'e11', time: "08:00", icon: "Home", title: "ÂÜíÈö™ÈñãÂßã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e12', time: "08:45", icon: "Utensils", title: "Êü≥Ê©ã‰∏≠Â§ÆÂ∏ÇÂ†¥", desc: "Ë£úÁµ¶: ÁîüÈ≠öÁâá„ÄÅÊµ∑ÈÆÆÂ∑°Á¶Æ", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e13', time: "12:00", icon: "Utensils", title: "ÂçàÈ§ê: È≥•ÈñãÁ∑èÊú¨ÂÆ∂", desc: "Áç≤ÂæóÁâ©ÂìÅ: ÈáëË≥ûË¶™Â≠ê‰∏º", type: "loot", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e14', time: "13:30", icon: "ShoppingBag", title: "Â§ßÈ†àÂïÜÂ∫óË°ó", desc: "‰∫§ÊòìËàáÊé¢Á¥¢ (Á¥Ñ2Â∞èÊôÇ)", type: "action", transportTime: "20m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e15', time: "15:30", icon: "Coffee", title: "‰∏ãÂçàËå∂: Konparu", desc: "Ë£úÁµ¶: ÁÇ∏Ëù¶‰∏âÊòéÊ≤ª", type: "heal", transportTime: "5m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e16', time: "18:30", icon: "Utensils", title: "ÊôöÈ§ê: ÁÜ±Áî∞Ëì¨ËêäËªí", desc: "ÊåëÊà∞ÂÇ≥Ë™™ÁæéÈ£ü: È∞ªÈ≠öÈ£Ø‰∏âÂêÉ https://www.houraiken.com/", type: "boss", transportTime: "30m", transportCost: 270, transportMode: "Train", completed: false },
                { id: 'e17', time: "20:30", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "40m", transportCost: 270, transportMode: "Train", completed: false },
                ]
            },
            {
                day: 2,
                title: "Á¨¨‰∫åÁ´†: Âè§ÂüéËàáÂíñÂï°",
                date: "2026-03-04",
                events: [
                { id: 'e20', time: "07:45", icon: "Home", title: "Êó©ÂÆâÂêçÂè§Â±ã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e21', time: "08:00", icon: "Coffee", title: "Êó©È§ê: Bucyo Coffee", desc: "Ë£úÁµ¶: Â∞èÂÄâÁ¥ÖË±ÜÂêêÂè∏", type: "heal", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e22', time: "10:00", icon: "MapPin", title: "Áä¨Â±±ÂüéÊîªÁï•", desc: "ÂúãÂØ∂Â§©ÂÆàÈñ£ (ÈñÄÁ•® ¬•550)", type: "dungeon", transportTime: "50m", transportCost: 600, transportMode: "Train", completed: false },
                { id: 'e23', time: "12:30", icon: "Utensils", title: "ÂçàÈ§ê: Sakura Chaya", desc: "Áç≤ÂæóÁâ©ÂìÅ: Áî∞Ê®ÇÁÉ§Ë±ÜËÖê‰∏≤", type: "loot", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e24', time: "15:00", icon: "Coffee", title: "GOLPIE COFFEE", desc: "Â∑ùÂêçÂ±±ÂÜ†ËªçÂíñÂï°Â∑°Á¶Æ", type: "action", transportTime: "1h 20m", transportCost: 800, transportMode: "Train", completed: false },
                { id: 'e25', time: "18:00", icon: "Utensils", title: "Solo Pizza", desc: "Â§ßÈ†àÊú¨Â∫ó (‰∏ñÁïåÂÜ†ËªçÊä´Ëñ©)", type: "loot", transportTime: "30m", transportCost: 240, transportMode: "Train", completed: false },
                { id: 'e26', time: "20:00", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                ]
            },
            {
                day: 3,
                title: "Á¨¨‰∏âÁ´†: Â∞áËªçÁöÑÊ¶ÆËÄÄ",
                date: "2026-03-05",
                events: [
                { id: 'e30', time: "07:45", icon: "Home", title: "Êó©ÂÆâÂêçÂè§Â±ã", desc: "Âæû Trip & Sleep hostel Âá∫Áôº", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e31', time: "08:00", icon: "Coffee", title: "Êó©È§ê: Karasu", desc: "Â≠§Áç®ÁöÑÁæéÈ£üÂÆ∂ÂíñÂï°Âª≥", type: "heal", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e32', time: "09:30", icon: "MapPin", title: "ÂêçÂè§Â±ãÂüé", desc: "ÈáëÈØ±ËàáÊú¨‰∏∏Âæ°ÊÆø (ÈñÄÁ•® ¬•500)", type: "dungeon", transportTime: "20m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e33', time: "11:30", icon: "Camera", title: "Âæ∑Â∑ùÂúí", desc: "Êó•ÂºèÂ∫≠ÂúíÊï£Ê≠• (ÈñÄÁ•® ¬•300)", type: "action", transportTime: "30m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e34', time: "13:00", icon: "Utensils", title: "ÂçàÈ§ê: Yellow", desc: "ÂâáÊ≠¶Êñ∞Áî∫ ÊøÉÂéöÊ≠êÂßÜËõãÂåÖÈ£Ø", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Bus", completed: false },
                { id: 'e35', time: "15:00", icon: "ShoppingBag", title: "Ê¶Æ (Sakae)", desc: "LACHIC, ‰∏≠Êó•Â§ßÊ®ì Ë≥ºÁâ©", type: "trade", transportTime: "20m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e36', time: "18:00", icon: "Utensils", title: "ÊôöÈ§ê: Êµ∑ËÄÅ„Å©„Å¶", desc: "ÊåëÊà∞: 35cm ÁâπÂ§ßÁÇ∏Ëù¶", type: "boss", transportTime: "10m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e37', time: "20:00", icon: "Home", title: "ËøîÂõûÊìöÈªû", desc: "ÂõûÂà∞ Trip & Sleep hostel ‰ºëÊÅØ", type: "save", transportTime: "15m", transportCost: 210, transportMode: "Train", completed: false },
                ]
            },
            {
                day: 4,
                title: "ÁµÇÁ´†: Ê≠∏ÈÄî",
                date: "2026-03-06",
                events: [
                { id: 'e41', time: "09:40", icon: "Home", title: "ÊóÖÂ∫óÈÄÄÊàø", desc: "ÂëäÂà• Trip & Sleep hostelÔºåÂâçÂæÄÊ©üÂ†¥", type: "start", transportTime: "", transportCost: 0, transportMode: "", completed: false },
                { id: 'e42', time: "09:50", icon: "Train", title: "Âú∞‰∏ãÈêµÁßªÂãï", desc: "‰∏äÂâçÊ¥• (M03) -> ÈáëÂ±± (M01)", type: "travel", transportTime: "10m", transportCost: 210, transportMode: "Train", completed: false },
                { id: 'e43', time: "10:18", icon: "Train", title: "ÂêçÈêµÁâπÊÄ• Œº-SKY", desc: "ÈáëÂ±±Á´ô -> ‰∏≠ÈÉ®ÂúãÈöõÊ©üÂ†¥", type: "travel", transportTime: "28m", transportCost: 1250, transportMode: "Train", completed: false },
                { id: 'e44', time: "10:50", icon: "MapPin", title: "ÊäµÈÅîÊ©üÂ†¥ T1", desc: "ÂâçÂæÄ‰∫§ÈÄöÂª£Â†¥", type: "checkpoint", transportTime: "5m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e45', time: "11:05", icon: "Footprints", title: "Ê≠•Ë°åËá≥ T2", desc: "Èï∑Ë∑ùÈõ¢ÁßªÂãï (10-15ÂàÜ)", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints", completed: false },
                { id: 'e46', time: "11:05", icon: "Plane", title: "Â†±Âà∞ & Ë®óÈÅã", desc: "ËôéËà™Ê´ÉÊ™Ø IT779 (13:15 Ëµ∑È£õ)", type: "action", transportTime: "0m", transportCost: 0, transportMode: "", completed: false },
                { id: 'e47', time: "13:15", icon: "Plane", title: "ËøîËà™: IT779", desc: "È£õÂæÄÊ°ÉÂúíÊ©üÂ†¥ (13:15-15:25)", type: "travel", transportTime: "", transportCost: 0, transportMode: "Plane", completed: false },
                { id: 'e48', time: "15:25", icon: "Home", title: "Mission Complete", desc: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥Ôºå‰ªªÂãôÁµêÊùü", type: "end", transportTime: "3h 10m", transportCost: 0, transportMode: "Plane", completed: false },
                ]
            }
        ];

        // Helper: Linkify Text
        const LinkifyText = ({ text }) => {
            if (!text) return null;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);
            return (
                <span>
                    {parts.map((part, i) => 
                        part.match(urlRegex) ? (
                            <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="desc-link flex items-center inline-flex gap-1" onClick={e=>e.stopPropagation()}>
                                <ExternalLink size={10} />{part.length > 20 ? part.substring(0,20)+'...' : part}
                            </a>
                        ) : part
                    )}
                </span>
            );
        };

        // Helper: Call Gemini
        const callGeminiAPI = async (prompt, imageBase64 = null) => {
             const apiKey = ""; // Set API Key
             if (!apiKey) throw new Error("API Key Missing");
             
             const payload = {
                 contents: [{
                     parts: [
                         { text: prompt },
                         ...(imageBase64 ? [{ inline_data: { mime_type: "image/jpeg", data: imageBase64.split(',')[1] } }] : [])
                     ]
                 }]
             };

             const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             const data = await response.json();
             return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
        };

        // --- Hook with Offline Support & LocalStorage Backup ---
        function useFirestoreData(user, tripId, collectionName, initialData, isObject = false) {
            const [data, setData] = useState(() => {
                // Initial Load: Try LocalStorage first (Offline support)
                const cached = localStorage.getItem(`${tripId}_${collectionName}`);
                return cached ? JSON.parse(cached) : initialData;
            });
            const [isOffline, setIsOffline] = useState(false);

            useEffect(() => {
                if (!user || !tripId) return;

                let docRef;
                if (typeof __app_id !== 'undefined') {
                     docRef = doc(collection(db, 'artifacts', __app_id, 'public', 'data', 'trip_data'), `${tripId}_${collectionName}`);
                } else {
                     docRef = doc(collection(db, 'trip_data'), `${tripId}_${collectionName}`);
                }

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setIsOffline(docSnap.metadata.fromCache);
                    if (docSnap.exists()) {
                        const cloudData = isObject ? docSnap.data() : docSnap.data().items;
                        setData(cloudData);
                        localStorage.setItem(`${tripId}_${collectionName}`, JSON.stringify(cloudData)); // Backup to local
                    } else {
                        setDoc(docRef, isObject ? initialData : { items: initialData }).catch(e => console.error("Init data failed", e));
                    }
                }, (error) => {
                    console.error(`Offline or Error fetching ${collectionName}:`, error);
                    setIsOffline(true);
                });
                return () => unsubscribe();
            }, [user, tripId, collectionName]);

            const updateData = (newData) => {
                setData(newData);
                localStorage.setItem(`${tripId}_${collectionName}`, JSON.stringify(newData)); // Optimistic update local
                
                if (!user || !tripId) return;
                let docRef;
                if (typeof __app_id !== 'undefined') {
                     docRef = doc(collection(db, 'artifacts', __app_id, 'public', 'data', 'trip_data'), `${tripId}_${collectionName}`);
                } else {
                     docRef = doc(collection(db, 'trip_data'), `${tripId}_${collectionName}`);
                }
                
                setDoc(docRef, isObject ? newData : { items: newData }).catch(e => {
                    console.error("Cloud save failed, using local", e);
                });
            };
            return [data, updateData, isOffline];
        }

        // --- SUB-COMPONENTS ---
        const LoginView = ({ onLogin }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] animate-enter"><div className="bg-slate-800 border-2 border-yellow-500 p-8 rounded-lg shadow-2xl text-center max-w-xs w-full relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-yellow-500 to-red-500"></div><div className="mb-6"><div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto border-4 border-yellow-500 mb-4 shadow-[0_0_20px_rgba(234,179,8,0.5)]"><Shield size={40} className="text-yellow-500" /></div><h2 className="text-2xl font-bold text-yellow-400 mb-1">ÂÜíÈö™ËÄÖÁôªÂÖ•</h2><p className="text-xs text-slate-400 font-mono">ADVENTURER LOGIN</p></div><button onClick={onLogin} className="w-full bg-white hover:bg-slate-200 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-3 transition group"><User size={20} />{USE_REAL_GOOGLE_AUTH ? "‰ΩøÁî® Google Â∏≥Ëôü" : "‰ª•Ë®™ÂÆ¢Ë∫´‰ªΩÈÄ≤ÂÖ•"}</button></div></div>
        );

        const QuestView = () => {
            const { quests, setQuests, activeLevel, setActiveLevel, countdown, weatherForecast, stats, setExpenses, expenses, exchangeRate } = useContext(AppContext);
            const [isAddingEvent, setIsAddingEvent] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [newEventData, setNewEventData] = useState({ time: "10:00", title: "", desc: "", type: "action", locationQuery: "", transportTime: "", transportCost: "", transportMode: "Footprints", tags: "", completed: false });
            const fileInputRef = useRef(null); const [uploadingEventId, setUploadingEventId] = useState(null);
            
            const triggerImageUpload = (id) => { setUploadingEventId(id); fileInputRef.current.click(); };
            const handleImageUpload = (e) => {
                const file = e.target.files[0]; if (!file || !uploadingEventId) return;
                const reader = new FileReader(); reader.onload = (ev) => {
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 800/img.width; c.width=Math.min(img.width,800); c.height=img.height*s; ctx.drawImage(img,0,0,c.width,c.height);
                        const base64 = c.toDataURL('image/jpeg', 0.5);
                        const newQuests = [...quests]; const day = newQuests[activeLevel].events; const idx = day.findIndex(e=>e.id===uploadingEventId); if(idx>-1){ day[idx].image=base64; setQuests(newQuests); }
                    }; img.src = ev.target.result;
                }; reader.readAsDataURL(file); e.target.value='';
            };
            
            // Edit Event Logic
            const openEditModal = (ev) => {
                setNewEventData({
                    time: ev.time, title: ev.title, desc: ev.desc, type: ev.type || 'action', 
                    transportTime: ev.transportTime || "", transportCost: ev.transportCost || "", 
                    transportMode: ev.transportMode || "Footprints", tags: ev.tags ? ev.tags.join(" ") : "",
                    completed: ev.completed
                });
                setEditingId(ev.id);
                setIsEditing(true);
                setIsAddingEvent(true);
            };

            const saveEvent = () => {
                if(!newEventData.title) return alert("Ë´ãËº∏ÂÖ•Ê®ôÈ°å");
                let icon = "MapPin"; if(newEventData.type==='travel') icon="Train"; else if(newEventData.type==='loot') icon="Utensils"; else if(newEventData.type==='save') icon="Home";
                
                const eventPayload = { 
                    ...newEventData, 
                    icon, 
                    transportCost: parseInt(newEventData.transportCost)||0, 
                    tags: newEventData.tags.split(' ').filter(t=>t) 
                };

                const newQuests = [...quests];
                
                if (isEditing && editingId) {
                    const idx = newQuests[activeLevel].events.findIndex(e => e.id === editingId);
                    if (idx > -1) {
                        eventPayload.id = editingId;
                        eventPayload.image = newQuests[activeLevel].events[idx].image; // Preserve image
                        newQuests[activeLevel].events[idx] = eventPayload;
                    }
                } else {
                    eventPayload.id = Date.now().toString();
                    newQuests[activeLevel].events.push(eventPayload);
                }
                
                newQuests[activeLevel].events.sort((a,b)=>a.time.localeCompare(b.time));
                setQuests(newQuests); 
                setIsAddingEvent(false);
                setIsEditing(false);
                setEditingId(null);
            };

            const deleteEvent = (eventId) => {
                 if(!window.confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) return;
                 const newQuests = [...quests]; newQuests[activeLevel].events = newQuests[activeLevel].events.filter(e => e.id !== eventId); setQuests(newQuests);
            };
            
            const toggleComplete = (eventId) => {
                const newQuests = [...quests];
                const evt = newQuests[activeLevel].events.find(e => e.id === eventId);
                if(evt) {
                    evt.completed = !evt.completed;
                    if (evt.completed) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                }
                setQuests(newQuests);
            };
            const openMap = (title) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`, '_blank');
            };
            
            const syncToExpense = (ev) => {
                if (!ev.transportCost) return;
                const confirmSync = confirm(`Á¢∫ÂÆöÂ∞á„Äå${ev.title}„ÄçÁöÑË≤ªÁî® ¬•${ev.transportCost} Âä†ÂÖ•Ë®òÂ∏≥ÂóéÔºü`);
                if (confirmSync) {
                    const newExpense = {
                        id: Date.now(),
                        item: `${ev.title} (Ë°åÁ®ã)`,
                        cost: parseInt(ev.transportCost),
                        type: ev.type === 'loot' ? 'loot' : 'travel',
                        method: 'cash',
                        payer: 'me',
                        date: quests[activeLevel].date,
                        currency: 'JPY'
                    };
                    setExpenses([newExpense, ...expenses]);
                    alert("Â∑≤Âä†ÂÖ•Ë°åÂõäÔºÅ");
                }
            };

            const updateNote = (text) => { const newQuests=[...quests]; newQuests[activeLevel].note = text; setQuests(newQuests); };
            const weather = weatherForecast[activeLevel] || {};
            const WeatherIcon = weather.code < 3 ? Sun : (weather.code < 60 ? CloudSun : CloudRain);

            return (
                <div className="animate-enter w-full pb-20">
                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    
                    {/* Dynamic Stats Header */}
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        <div className="bg-slate-800 p-2 rounded border border-yellow-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-yellow-500 font-bold">LV. {Math.floor(stats.xp/1000)+1}</span>
                            <span className="text-lg font-bold text-white">{stats.xp} XP</span>
                        </div>
                         <div className="bg-slate-800 p-2 rounded border border-blue-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-blue-500 font-bold">FATIGUE</span>
                            <span className="text-lg font-bold text-white">{stats.fatigue}%</span>
                        </div>
                        <div className="bg-slate-800 p-2 rounded border border-green-600/50 flex flex-col items-center">
                            <span className="text-[10px] text-green-500 font-bold">GOLD</span>
                            <span className="text-lg font-bold text-white">¬•{stats.goldRemaining.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="flex w-full overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar px-1">{quests.map((q, i) => (<button key={i} onClick={() => setActiveLevel(i)} className={`flex-shrink-0 px-4 py-2 border-2 text-xs font-bold whitespace-nowrap rounded-sm ${activeLevel === i ? "bg-blue-600 border-blue-400 text-white" : "bg-slate-800 border-slate-600 text-slate-400"}`}>{i===0?"Â∫èÁ´†":i===4?"ÁµÇÁ´†":`Day ${i}`}</button>))}</div>
                    <div className="w-full bg-slate-800 border-2 border-slate-600 p-4 mb-6 rounded-sm relative overflow-hidden">
                        <div className="flex justify-between items-start"><h2 className="text-xl font-bold text-green-400 mb-1">{quests[activeLevel].title}</h2></div>
                        <div className="text-sm text-slate-400 mb-4 flex justify-between items-center"><span className="flex items-center gap-2"><Calendar size={12}/> {quests[activeLevel].date} {weather.max && <span className="flex items-center gap-1 text-yellow-300 ml-2"><WeatherIcon size={14}/> {weather.min}¬∞-{weather.max}¬∞</span>}</span><span className="text-blue-400 font-mono text-xs">T-{countdown}</span></div>
                    </div>
                    <div className="w-full relative pl-4">
                        <div className="absolute left-[27px] top-4 bottom-4 w-1 bg-slate-700 z-0"></div>
                        {quests[activeLevel].events.map((ev, idx) => {
                            const IconC = ICON_MAP[ev.icon] || MapPin; const ModeIcon = ICON_MAP[ev.transportMode] || Footprints;
                            return (
                                <div key={ev.id} className={`relative z-10 mb-6 group transition-all duration-300 ${ev.completed ? 'opacity-50 grayscale' : ''}`}>
                                    {(ev.transportTime || ev.transportCost > 0) && (
                                        <div className="flex items-center ml-[19px] mb-3 relative">
                                            <div className="w-2 h-2 bg-slate-600 rounded-full border-2 border-slate-900 z-20"></div>
                                            <div className="ml-4 flex items-center gap-2 text-[10px] text-slate-400 bg-slate-900/90 px-2 py-1 rounded border border-slate-700">
                                                <ModeIcon size={12}/> 
                                                {ev.transportTime} 
                                                {ev.transportCost > 0 && <span className="text-yellow-500 font-mono">¬•{ev.transportCost}</span>}
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex items-start">
                                        <div onClick={()=>toggleComplete(ev.id)} className={`cursor-pointer w-12 h-12 flex-shrink-0 rounded-lg border-2 flex items-center justify-center shadow-lg z-10 transition-colors ${ev.completed ? 'bg-green-900 border-green-500 text-green-300' : 'bg-slate-900 border-slate-500 text-slate-400'}`}>
                                            {ev.completed ? <Check size={20}/> : <IconC size={20}/>}
                                        </div>
                                        <div className="ml-4 flex-1 border-2 border-slate-600 bg-slate-800/50 p-3 rounded-lg relative hover:bg-slate-800 transition-colors">
                                            <div className="absolute top-4 -left-2 w-3 h-3 border-l-2 border-b-2 border-inherit bg-slate-900 transform rotate-45"></div>
                                            <div className="flex justify-between mb-1">
                                                <span className="font-bold text-sm">{ev.title}</span>
                                                <span className="text-xs font-mono opacity-50">{ev.time}</span>
                                            </div>
                                            <p className="text-xs opacity-70 mb-2 leading-relaxed"><LinkifyText text={ev.desc}/></p>
                                            {ev.tags && <div className="flex gap-1 mb-2">{ev.tags.map(t=><span key={t} className="text-[9px] bg-blue-900 text-blue-200 px-1 rounded">#{t}</span>)}</div>}
                                            {ev.image && <img src={ev.image} className="w-full h-32 object-cover rounded border border-slate-700 mb-2"/>}
                                            
                                            {/* Action Bar */}
                                            <div className="flex justify-between items-center mt-2 border-t border-slate-700/50 pt-2">
                                                <div className="flex gap-2">
                                                    {ev.transportCost > 0 && (
                                                        <button onClick={()=>syncToExpense(ev)} className="text-xs text-yellow-500 flex items-center gap-1 hover:text-yellow-300 bg-yellow-900/20 px-2 py-0.5 rounded border border-yellow-800" title="ËΩâÂÖ•Ë®òÂ∏≥">
                                                            <Coins size={10}/> ¬•{ev.transportCost}
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="flex gap-3">
                                                    <button onClick={()=>openMap(ev.title)} className="text-xs text-blue-400 flex items-center gap-1 hover:text-white"><MapPin size={12}/> Â∞éËà™</button>
                                                    <button onClick={()=>openEditModal(ev)} className="text-xs text-slate-400 flex items-center gap-1 hover:text-white"><Edit size={12}/> Á∑®ËºØ</button>
                                                    <button onClick={()=>triggerImageUpload(ev.id)} className="text-xs text-slate-400 flex items-center gap-1 hover:text-white"><ImageIcon size={12}/> ÁÖßÁâá</button>
                                                    <button onClick={()=>deleteEvent(ev.id)} className="text-xs text-red-400 flex items-center gap-1 hover:text-red-300"><Trash2 size={12}/> Âà™Èô§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                        <div className="relative z-10 mt-4 mb-10 pl-16"><button onClick={() => { setIsEditing(false); setIsAddingEvent(true); setNewEventData({ time: "10:00", title: "", desc: "", type: "action", locationQuery: "", transportTime: "", transportCost: "", transportMode: "Footprints", tags: "", completed: false }); }} className="w-full border-2 border-dashed border-slate-600 text-slate-500 rounded-lg p-3 hover:text-white"><PlusCircle className="inline mr-2"/>Êñ∞Â¢ûË°åÁ®ã</button></div>
                        <div className="ml-4 mt-8 bg-slate-900 border border-slate-700 p-3 rounded"><h4 className="text-xs text-blue-400 mb-2 font-bold flex items-center gap-2"><FileText size={12}/> ÂÜíÈö™Êó•Ë®ò (Journal)</h4><textarea className="w-full bg-transparent text-sm text-white outline-none resize-none h-24" placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºË∂£‰∫ã..." value={quests[activeLevel].note||""} onChange={(e)=>updateNote(e.target.value)}></textarea></div>
                    </div>
                    {isAddingEvent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-slate-900 border-2 border-yellow-600 w-full max-w-sm rounded p-5">
                                <h3 className="text-yellow-500 font-bold mb-4">{isEditing ? "Á∑®ËºØË°åÁ®ã" : "Êñ∞Â¢ûË°åÁ®ã"}</h3>
                                <div className="space-y-3">
                                    <input type="time" value={newEventData.time} onChange={e=>setNewEventData({...newEventData,time:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <div className="relative">
                                        <input type="text" placeholder="Âú∞ÈªûÂêçÁ®±" value={newEventData.title} onChange={e=>setNewEventData({...newEventData,title:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white pr-20"/>
                                        <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(newEventData.title || "")}`} target="_blank" className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-blue-400 flex items-center gap-1"><Search size={10}/> Âú∞ÂúñÊâæ</a>
                                    </div>
                                    <input type="text" placeholder="ÊèèËø∞ (ÂèØË≤ºÁ∂≤ÂùÄ)" value={newEventData.desc} onChange={e=>setNewEventData({...newEventData,desc:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="ÁßªÂãïÊôÇÈñì (15m)" value={newEventData.transportTime} onChange={e=>setNewEventData({...newEventData,transportTime:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                        <input type="number" placeholder="Ë≤ªÁî® (¬•)" value={newEventData.transportCost} onChange={e=>setNewEventData({...newEventData,transportCost:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto pb-1">
                                        {['Footprints','Train','Bus','Car','Plane'].map(m => {
                                            const MIcon = ICON_MAP[m];
                                            return <button key={m} onClick={()=>setNewEventData({...newEventData, transportMode: m})} className={`p-2 rounded border ${newEventData.transportMode === m ? 'bg-blue-600 border-blue-400 text-white' : 'bg-slate-800 border-slate-600 text-slate-400'}`}><MIcon size={16}/></button>
                                        })}
                                    </div>
                                    <input type="text" placeholder="#Ê®ôÁ±§ (‰ª•Á©∫ÁôΩÂàÜÈöî)" value={newEventData.tags} onChange={e=>setNewEventData({...newEventData,tags:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                                    <button onClick={saveEvent} className="w-full bg-yellow-600 text-black font-bold py-2 rounded">ÂÑ≤Â≠ò</button>
                                    <button onClick={()=>{setIsAddingEvent(false); setIsEditing(false);}} className="w-full text-slate-500 text-xs mt-2">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryView = () => {
            const { expenses, setExpenses, budget, setBudget, exchangeRate, shoppingList, setShoppingList, quests, activeLevel, settingsData, updateSettings } = useContext(AppContext);
            const [newExp, setNewExp] = useState({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });
            const [newShopItem, setNewShopItem] = useState("");
            const [isEditingBudget, setIsEditingBudget] = useState(false); 
            const [tempBudget, setTempBudget] = useState(budget);
            const [tempCashBudget, setTempCashBudget] = useState(settingsData?.cashBudget || 50000);
            const [isScanning, setIsScanning] = useState(false);
            const [isEditingExpense, setIsEditingExpense] = useState(false);
            const [editingExpId, setEditingExpId] = useState(null);
            
            const ocrInputRef = useRef(null);

            // Expense Category Configuration
            const EXPENSE_CATS = [
                { id: 'loot', label: 'ÁæéÈ£ü', icon: Utensils, activeClass: 'bg-yellow-600 border-yellow-500 text-white ring-2 ring-yellow-500/20' },
                { id: 'travel', label: '‰∫§ÈÄö', icon: Train, activeClass: 'bg-blue-600 border-blue-500 text-white ring-2 ring-blue-500/20' },
                { id: 'trade', label: 'Ë≥ºÁâ©', icon: ShoppingBag, activeClass: 'bg-pink-600 border-pink-500 text-white ring-2 ring-pink-500/20' },
                { id: 'save', label: '‰ΩèÂÆø', icon: Home, activeClass: 'bg-green-600 border-green-500 text-white ring-2 ring-green-500/20' },
                { id: 'other', label: 'ÂÖ∂‰ªñ', icon: HelpCircle, activeClass: 'bg-slate-600 border-slate-500 text-white ring-2 ring-slate-500/20' }
            ];

            const cashBudget = settingsData?.cashBudget || 50000;
            const setCashBudget = (val) => updateSettings({ ...settingsData, cashBudget: val });

            const addOrUpdateExpense = () => {
                if(!newExp.item || !newExp.cost) return;
                const finalCost = newExp.currency === 'TWD' ? Math.round(parseInt(newExp.cost)/exchangeRate) : parseInt(newExp.cost);
                const payload = { ...newExp, cost: finalCost };
                
                if (isEditingExpense && editingExpId) {
                    setExpenses(expenses.map(e => e.id === editingExpId ? { ...payload, id: editingExpId } : e));
                    setIsEditingExpense(false);
                    setEditingExpId(null);
                } else {
                    setExpenses([{ id: Date.now(), ...payload }, ...expenses]);
                    // Loot Effect
                    if (newExp.type === 'trade' || newExp.type === 'loot') {
                        confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#FFD700', '#FFA500'] });
                    }
                }
                setNewExp({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });
            };

            const editExpense = (exp) => {
                setNewExp({ ...exp, cost: exp.cost, currency: 'JPY' }); // Assume JPY for edit simplification or store currency in future
                setEditingExpId(exp.id);
                setIsEditingExpense(true);
            };

            const deleteExpense = (id) => { if(confirm("Âà™Èô§?")) setExpenses(expenses.filter(e=>e.id!==id)); };
            const addShopItem = () => { if(newShopItem){ setShoppingList([...shoppingList, {id: Date.now(), text: newShopItem, checked: false}]); setNewShopItem(""); }};
            const deleteShopItem = (id) => { if(confirm("Âà™Èô§?")) setShoppingList(shoppingList.filter(i=>i.id!==id)); };
            const toggleShop = (id) => setShoppingList(shoppingList.map(i=>i.id===id?{...i,checked:!i.checked}:i));
            
            const totalSpent = expenses.reduce((a,c)=>a+c.cost,0);
            const remainingBudget = budget - totalSpent;
            const budgetPercent = Math.max(0, (remainingBudget / budget) * 100);
            
            // Cash Tracker Logic
            const cashSpent = expenses.filter(e => e.method === 'cash').reduce((a,c) => a + c.cost, 0);
            const cashRemaining = cashBudget - cashSpent;

            // Daily Cap Logic
            const remainingDays = Math.max(1, quests.length - activeLevel);
            const dailyCap = Math.floor(remainingBudget / remainingDays);

            // Splitwise Logic
            const myCredits = expenses.filter(e => e.payer === 'partner').reduce((acc, curr) => acc + curr.cost, 0); 
            
            // OCR Logic
            const handleOCR = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                setIsScanning(true);
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const base64 = ev.target.result;
                        const result = await callGeminiAPI("Analyze this receipt. Return ONLY a JSON object with {item: string (summary), cost: number (integer), currency: 'JPY' or 'TWD'}. No markdown.", base64);
                        const cleanResult = result.replace(/```json|```/g, '').trim();
                        const parsed = JSON.parse(cleanResult);
                        setNewExp({ ...newExp, item: parsed.item || "ÊéÉÊèèÈ†ÖÁõÆ", cost: parsed.cost || 0, currency: parsed.currency || 'JPY' });
                    } catch (err) {
                        alert("Ëæ®Ë≠òÂ§±ÊïóÔºåË´ãÈáçË©¶");
                        console.error(err);
                    } finally { setIsScanning(false); }
                };
                reader.readAsDataURL(file);
            };

            return (
                <div className="w-full animate-enter pb-32">
                    {/* Budget Health Bar Card */}
                    <div className="bg-slate-800 border-2 border-yellow-600 p-4 mb-4 rounded relative overflow-hidden">
                        <div className="flex justify-between items-end mb-2 relative z-10">
                            <div>
                                <div className="text-xs text-yellow-600 font-bold mb-1 flex gap-2 items-center">
                                    Á∏ΩÈ†êÁÆó (TOTAL BUDGET) 
                                    {!isEditingBudget && <button onClick={()=>{setIsEditingBudget(true);setTempBudget(budget);setTempCashBudget(cashBudget)}}><Edit size={12}/></button>}
                                </div>
                                {isEditingBudget ? (
                                    <div className="flex flex-col gap-2 bg-slate-900 p-2 rounded border border-slate-600">
                                        <div className="flex gap-2 items-center">
                                            <span className="text-[10px] w-12">Á∏ΩÈ°ç:</span>
                                            <input type="number" value={tempBudget} onChange={e=>setTempBudget(e.target.value)} className="bg-slate-800 w-24 px-1 text-white border border-slate-600"/>
                                        </div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-[10px] w-12 text-green-300">ÁèæÈáë:</span>
                                            <input type="number" value={tempCashBudget} onChange={e=>setTempCashBudget(e.target.value)} className="bg-slate-800 w-24 px-1 text-white border border-slate-600"/>
                                        </div>
                                        <button onClick={()=>{setBudget(parseInt(tempBudget));setCashBudget(parseInt(tempCashBudget));setIsEditingBudget(false)}} className="text-xs bg-green-600 text-white py-1 rounded">Á¢∫Ë™ç</button>
                                    </div>
                                ) : (
                                    <div className="text-3xl text-yellow-400 font-bold tracking-tighter">¬•{remainingBudget.toLocaleString()}</div>
                                )}
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-slate-400">‰ªäÊó•Âª∫Ë≠∞‰∏äÈôê</div>
                                <div className="text-sm font-bold text-blue-300">¬•{dailyCap.toLocaleString()}</div>
                            </div>
                        </div>
                        {/* HP Bar */}
                        <div className="hp-bar-container w-full relative">
                            <div className={`hp-bar-fill ${budgetPercent > 50 ? 'bg-green-500' : budgetPercent > 20 ? 'bg-yellow-500' : 'bg-red-500 animate-pulse'}`} style={{width: `${budgetPercent}%`}}></div>
                        </div>
                        <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>Â∑≤ÊîØÂá∫: ¬•{totalSpent.toLocaleString()}</span>
                            <span>{Math.round(budgetPercent)}%</span>
                        </div>
                    </div>
                    
                    {/* Cash & Credit Dashboard */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className={`bg-slate-900 border p-3 rounded relative ${cashRemaining < 10000 ? 'border-red-500/50' : 'border-slate-700'}`}>
                            <div className="flex items-center gap-2 text-slate-400 mb-1"><Banknote size={14}/> <span className="text-xs font-bold">Èå¢ÂåÖÁèæÈáë</span></div>
                            <div className={`text-lg font-bold font-mono ${cashRemaining < 3000 ? 'text-red-500' : cashRemaining < 10000 ? 'text-yellow-500' : 'text-white'}`}>¬•{cashRemaining.toLocaleString()}</div>
                            {cashRemaining < 10000 && <div className="text-[9px] text-red-400 absolute top-2 right-2 flex items-center"><AlertTriangle size={10}/> Ë£úÊ∞¥!</div>}
                        </div>
                        <div className="bg-slate-900 border border-slate-700 p-3 rounded">
                            <div className="flex items-center gap-2 text-slate-400 mb-1"><Calculator size={14}/> <span className="text-xs font-bold">‰ª£Â¢äÁ∏ΩÈ°ç</span></div>
                            <div className="text-lg font-bold text-green-400">+¬•{myCredits.toLocaleString()}</div>
                        </div>
                    </div>

                    <div className={`bg-slate-800 border p-3 mb-4 rounded ${isEditingExpense ? 'border-blue-500' : 'border-slate-700'}`}>
                        <h3 className="font-bold text-slate-300 mb-2 flex justify-between items-center">
                            <span className="flex gap-2"><CreditCard size={16}/> {isEditingExpense ? "Á∑®ËºØÊîØÂá∫" : "Êñ∞Â¢ûÊîØÂá∫"}</span>
                            <div className="relative">
                                <button onClick={()=>ocrInputRef.current.click()} className="text-[10px] bg-blue-600 px-2 py-1 rounded text-white flex items-center gap-1">
                                    {isScanning ? <Loader2 size={10} className="animate-spin"/> : <ScanLine size={10}/>} AI ÊéÉÊèè
                                </button>
                                <input type="file" ref={ocrInputRef} onChange={handleOCR} accept="image/*" className="hidden"/>
                            </div>
                        </h3>
                        
                        {/* Optimized Category Selection */}
                        <div className="flex gap-2 mb-3 overflow-x-auto pb-1 no-scrollbar">
                            {EXPENSE_CATS.map(cat => {
                                const Icon = cat.icon;
                                const isActive = newExp.type === cat.id;
                                return (
                                    <button 
                                        key={cat.id} 
                                        onClick={()=>setNewExp({...newExp, type: cat.id})} 
                                        className={`flex items-center gap-1.5 px-3 py-2 rounded-lg border text-xs font-bold transition-all whitespace-nowrap ${isActive ? cat.activeClass : 'bg-slate-900/50 border-slate-700 text-slate-400 hover:bg-slate-800 hover:border-slate-600'}`}
                                    >
                                        <Icon size={14} />
                                        {cat.label}
                                    </button>
                                );
                            })}
                        </div>

                        <div className="flex flex-wrap gap-2 mb-2"><input type="text" placeholder="È†ÖÁõÆ" value={newExp.item} onChange={e=>setNewExp({...newExp,item:e.target.value})} className="flex-[2] min-w-[120px] bg-slate-900 border-slate-600 p-2 text-xs rounded text-white"/><div className="flex-[1] flex border border-slate-600 rounded min-w-[110px]"><input type="number" placeholder="ÈáëÈ°ç" value={newExp.cost} onChange={e=>setNewExp({...newExp,cost:e.target.value})} className="w-full bg-slate-900 p-2 text-xs text-white outline-none"/><button onClick={()=>setNewExp({...newExp,currency:newExp.currency==='JPY'?'TWD':'JPY'})} className="px-2 bg-slate-700 text-[10px] text-white shrink-0">{newExp.currency}</button></div></div>
                        <div className="flex justify-between items-center flex-wrap gap-2">
                            <div className="flex gap-2">
                                <select value={newExp.payer} onChange={e=>setNewExp({...newExp,payer:e.target.value})} className="bg-slate-700 text-xs rounded px-1 text-white"><option value="me">Ëá™Áî®</option><option value="partner">‰ª£Â¢ä</option></select>
                                <select value={newExp.method} onChange={e=>setNewExp({...newExp,method:e.target.value})} className="bg-slate-700 text-xs rounded px-1 text-white"><option value="cash">ÁèæÈáë</option><option value="card">Âà∑Âç°</option><option value="ic">ICÂç°</option></select>
                            </div>
                            <div>
                                {isEditingExpense && <button onClick={()=>{setIsEditingExpense(false); setNewExp({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });}} className="text-slate-500 text-xs mr-2">ÂèñÊ∂à</button>}
                                <button onClick={addOrUpdateExpense} className="bg-yellow-600 text-black px-4 py-1 rounded text-xs font-bold">{isEditingExpense ? "Êõ¥Êñ∞" : "Á¥ÄÈåÑ"}</button>
                            </div>
                        </div>
                        {newExp.cost && newExp.currency==='TWD' && <div className="text-[10px] text-right text-slate-500 mt-1">‚âà ¬•{Math.round(newExp.cost/exchangeRate).toLocaleString()}</div>}
                    </div>

                    <div className="bg-slate-800 border border-slate-700 p-3 mb-4 rounded">
                        <h3 className="font-bold text-pink-300 mb-2 flex gap-2"><ShoppingBag size={16}/> ÂøÖË≤∑Ê∏ÖÂñÆ (Shopping)</h3>
                        <div className="flex gap-2 mb-2"><input type="text" placeholder="Êñ∞Â¢ûÂïÜÂìÅ..." value={newShopItem} onChange={e=>setNewShopItem(e.target.value)} className="flex-1 bg-slate-900 border-slate-600 p-2 text-xs rounded text-white"/><button onClick={addShopItem}><PlusCircle size={20} className="text-pink-400"/></button></div>
                        <div className="space-y-1">{shoppingList.map(item=><div key={item.id} className={`flex items-center gap-2 p-2 rounded border border-slate-700 ${item.checked?'opacity-50 line-through bg-slate-900':'bg-slate-800'}`}><div onClick={()=>toggleShop(item.id)} className={`w-4 h-4 border ${item.checked?'bg-pink-500 border-pink-500':'border-slate-500'} rounded-sm flex items-center justify-center cursor-pointer`}>{item.checked&&<Check size={12} className="text-white"/>}</div><span className="flex-1 text-xs">{item.text}</span><button onClick={()=>deleteShopItem(item.id)} className="text-red-400"><Trash2 size={12}/></button></div>)}</div>
                    </div>

                    <div className="space-y-1">
                        {expenses.map(e => {
                            const TypeIcon = EXPENSE_ICONS[e.type] || HelpCircle;
                            return (
                                <div key={e.id} onClick={() => editExpense(e)} className="flex justify-between items-center p-2 border-b border-slate-800 bg-slate-800/50 hover:bg-slate-700/50 transition cursor-pointer">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${e.type==='trade'?'bg-pink-900 text-pink-300':e.type==='loot'?'bg-yellow-900 text-yellow-300':e.type==='travel'?'bg-blue-900 text-blue-300':e.type==='save'?'bg-green-900 text-green-300':'bg-slate-700 text-slate-300'}`}>
                                            <TypeIcon size={14} />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-xs font-bold">{e.item}</span>
                                            <span className="text-[9px] text-slate-500">{e.payer==='partner'?'(‰ª£Â¢ä)':'(Ëá™Áî®)'} ¬∑ {e.method}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-mono font-bold">¬•{e.cost.toLocaleString()}</span>
                                        <button onClick={(ev)=>{ev.stopPropagation();deleteExpense(e.id)}} className="text-slate-600 hover:text-red-400"><Trash2 size={12}/></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        // --- Guide View ---
        const GuideView = () => {
            const [expandedGuideId, setExpandedGuideId] = useState(null);
            return (
                <div className="w-full animate-enter pb-20"><div className="space-y-4">{GUIDE_DETAILS.map((place) => (<div key={place.id} className="bg-slate-800 border-2 border-slate-600 rounded-lg overflow-hidden transition-all duration-300"><div className="p-4 cursor-pointer hover:bg-slate-700/50 flex items-center gap-4" onClick={() => setExpandedGuideId(expandedGuideId === place.id ? null : place.id)}><div className="text-4xl">{place.image}</div><div className="flex-1"><h3 className="font-bold text-lg text-yellow-400">{place.title}</h3><p className="text-xs text-slate-400 mb-1">{place.subtitle}</p><div className="flex gap-1 flex-wrap">{place.tags.map(tag => (<span key={tag} className="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-blue-300 border border-slate-600">#{tag}</span>))}</div></div><div className={`transition-transform duration-300 ${expandedGuideId === place.id ? 'rotate-180' : ''}`}><ArrowDown size={16} className="text-slate-500" /></div></div>{expandedGuideId === place.id && (<div className="p-4 pt-0 border-t border-slate-700 bg-slate-900/50 animate-in slide-in-from-top-2"><div className="text-sm text-slate-300 mb-4 leading-relaxed mt-4">{place.desc}</div><div className="space-y-3 text-xs"><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-blue-400 mb-1 flex items-center gap-2"><Clock size={12}/> Ê≠∑Âè≤Â∞èÁü•Ë≠ò</h4><p className="text-slate-400">{place.content.history}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-yellow-400 mb-1 flex items-center gap-2"><Star size={12} /> ÁâπËâ≤ËàáÂøÖÁúã</h4><p className="text-slate-400">{place.content.features}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-green-400 mb-1 flex items-center gap-2"><MapPin size={12}/> ÊîªÁï• Tips</h4><p className="text-slate-400">{place.content.tips}</p></div><div className="bg-red-900/20 p-3 rounded border border-red-900/50"><h4 className="font-bold text-red-400 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> Ê≥®ÊÑè‰∫ãÈ†Ö</h4><p className="text-red-200/80">{place.content.warning}</p></div></div></div>)}</div>))}</div></div>
            );
        };

        // --- Grimoire View ---
        const GrimoireView = () => {
            const { speakJapanese } = useContext(AppContext);
            const [transInput, setTransInput] = useState("");
            const [transResult, setTransResult] = useState("");
            const [isTranslating, setIsTranslating] = useState(false);
            const [selectedSpell, setSelectedSpell] = useState(null);
            
            const handleTranslate = async () => {
                if (!transInput) return;
                setIsTranslating(true);
                setTransResult("");
                try {
                    const result = await callGeminiAPI(`Translate Traditional Chinese to Japanese (Polite/Travel). Output ONLY Japanese. Input: "${transInput}"`);
                    if (result) setTransResult(result.trim()); else setTransResult("Ë©†Âî±Â§±Êïó...");
                } catch (error) { setTransResult("È≠îÂäõ‰∏çË∂≥: " + error.message); } finally { setIsTranslating(false); }
            };

            return (
                <div className="w-full animate-enter pb-20">
                     <div className="bg-slate-800 border-2 border-blue-500 p-4 rounded-sm mb-6 relative overflow-hidden shadow-[0_0_15px_rgba(59,130,246,0.2)]"><div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">LIVE TRANSLATE</div><div className="flex items-center gap-2 mb-3"><Globe className="text-blue-400" size={20} /><h3 className="font-bold text-blue-300">ÈÄöÁî®Ë™ûÁøªË≠ØË°ì</h3></div><div className="flex gap-2"><input type="text" placeholder="Ëº∏ÂÖ•‰∏≠ÊñáÂííË™û..." value={transInput} onChange={(e) => setTransInput(e.target.value)} className="flex-1 min-w-0 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400 placeholder:text-slate-600"/><button onClick={handleTranslate} disabled={isTranslating} className="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:text-gray-400 text-white px-4 rounded font-bold text-xs transition flex items-center gap-1 whitespace-nowrap shrink-0">{isTranslating ? <Loader2 className="animate-spin" size={14} /> : "Ë©†Âî±"}</button></div>{transResult && (<div className="mt-3 p-3 bg-slate-900 border border-blue-500/50 rounded animate-enter flex justify-between items-start"><div><div className="text-[10px] text-blue-400 mb-1 font-bold font-mono">RESULT</div><div className="text-lg text-white font-bold leading-relaxed">{transResult}</div></div><button onClick={() => speakJapanese(transResult)} className="text-blue-400 hover:text-white p-2"><Volume2 size={20} /></button></div>)}</div>
                     <div className="grid grid-cols-2 gap-3">{SPELL_DATA.map((spell, idx) => (<div key={idx} onClick={() => setSelectedSpell(spell)} className="bg-slate-800 border border-slate-600 p-3 rounded hover:border-purple-500 transition group cursor-pointer relative overflow-hidden flex flex-col items-center text-center shadow-md active:scale-[0.98]"><div className="text-3xl mb-2 group-hover:scale-110 transition-transform">{spell.icon}</div><div className="font-bold text-purple-300 text-sm mb-1">{spell.title}</div><div className="text-[10px] text-slate-500">{spell.zh}</div><div className="absolute top-2 right-2 text-slate-500 hover:text-white" onClick={(e) => { e.stopPropagation(); speakJapanese(spell.jp); }}><Volume2 size={16} /></div></div>))}</div>
                     {selectedSpell && (<div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-enter" onClick={() => setSelectedSpell(null)}><div className="bg-slate-900 border-4 border-purple-500 p-6 rounded-lg max-w-sm w-full relative shadow-[0_0_50px_rgba(168,85,247,0.5)] flex flex-col items-center" onClick={e => e.stopPropagation()}><button onClick={() => setSelectedSpell(null)} className="absolute top-2 right-2 text-slate-400 hover:text-white p-2"><X size={24} /></button><div className="text-8xl mb-6 animate-bounce">{selectedSpell.icon}</div><div className="text-2xl font-bold text-purple-300 mb-6 border-b-2 border-purple-800 pb-2 w-full text-center">{selectedSpell.title}</div><div className="bg-white text-black p-6 rounded-lg mb-4 shadow-inner w-full flex justify-between items-center"><div className="text-2xl font-black leading-snug text-center flex-1">{selectedSpell.jp}</div><button onClick={() => speakJapanese(selectedSpell.jp)} className="ml-2 text-purple-600 p-2 bg-purple-100 rounded-full hover:bg-purple-200"><Volume2 size={24} /></button></div><div className="text-lg text-slate-400">{selectedSpell.zh}</div><div className="mt-8 text-[10px] text-purple-500 font-mono tracking-[0.2em] animate-pulse">SPELL CARD ACTIVE</div></div></div>)}
                </div>
            );
        };

        // --- Info View (Hub) ---
        const InfoView = () => {
            const { user, checklist, setChecklist, tickets, setTickets, tripId, setTripId, weatherTemp, setQuests, isOffline, exchangeRate } = useContext(AppContext);
            const [newTicket, setNewTicket] = useState({ title: "", type: "Flight", image: "" });
            const [isEditingTicket, setIsEditingTicket] = useState(false);
            const [tempTripId, setTempTripId] = useState(tripId);
            const ticketInputRef = useRef(null);
            
            // Currency Calculator State
            const [calcAmount, setCalcAmount] = useState("");
            
            // SOS Modal State
            const [sosModalContent, setSosModalContent] = useState(null);
            // Call Confirmation State
            const [confirmCall, setConfirmCall] = useState(null);

            const handleTicketUpload = (e) => {
                const file=e.target.files[0]; if(!file)return;
                const r=new FileReader(); r.onload=ev=>{ 
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 800/img.width; c.width=Math.min(img.width,800); c.height=img.height*s; ctx.drawImage(img,0,0,c.width,c.height);
                        setNewTicket({...newTicket, image: c.toDataURL('image/jpeg', 0.5)});
                    }; img.src = ev.target.result;
                }; r.readAsDataURL(file);
            };
            const saveTicket = () => { if(newTicket.title){ setTickets([...tickets, {id: Date.now(), ...newTicket}]); setIsEditingTicket(false); setNewTicket({title:"",type:"Flight",image:""}); }};
            const deleteTicket = (id) => { if(confirm("Âà™Èô§Á•®Âà∏Ôºü")) setTickets(tickets.filter(t=>t.id!==id)); };
            const joinTrip = () => { if(confirm("ÂàáÊèõÊóÖÁ®ãÂ∞áÊúÉÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÔºåÁ¢∫ÂÆöÂóéÔºü")) { setTripId(tempTripId); localStorage.setItem('tripId', tempTripId); window.location.reload(); }};
            const resetQuests = () => { if(confirm("‚ö†Ô∏è Ë≠¶ÂëäÔºöÈÄôÂ∞áÊúÉÊ∏ÖÈô§ÊâÄÊúâË°åÁ®ãËÆäÊõ¥‰∏¶ÊÅ¢Âæ©È†êË®≠ÂÄº„ÄÇÁ¢∫ÂÆöÂóéÔºü")) { setQuests(INITIAL_QUEST_DATA); alert("Â∑≤ÈáçÁΩÆË°åÁ®ãÔºÅ"); } };

            // Improved Weather/Outfit Logic
            const getWeatherDetails = (t) => {
                if (t <= 5) return { text: "Ê•µÂØí (Freezing)", icon: Snowflake, color: "text-blue-300", advice: "ÁôºÁÜ±Ë°£„ÄÅÁæΩÁµ®Â§ñÂ•ó„ÄÅÂúçÂ∑æ„ÄÅÊâãÂ•ó (Ê¥ãËî•ÂºèÁ©øÊê≠)" };
                if (t <= 12) return { text: "ÂØíÂÜ∑ (Cold)", icon: Wind, color: "text-cyan-300", advice: "ÂéöÂ§ßË°£„ÄÅÊØõË°£„ÄÅÈï∑Ë§≤ (Ê≥®ÊÑè‰øùÊöñ)" };
                if (t <= 20) return { text: "Ê∂ºÁàΩ (Cool)", icon: Cloud, color: "text-green-300", advice: "ËñÑÂ§ñÂ•ó„ÄÅÈï∑Ë¢ñ‰∏äË°£„ÄÅÁâõ‰ªîË§≤ (Êó©ÊôöÊ∫´Â∑ÆÂ§ß)" };
                if (t <= 28) return { text: "Ê∫´Êöñ (Warm)", icon: Sun, color: "text-orange-300", advice: "Áü≠Ë¢ñÊê≠ÈÖçËñÑË•ØË°´„ÄÅÈÄèÊ∞£Èï∑Ë§≤" };
                return { text: "ÁÇéÁÜ± (Hot)", icon: Flame, color: "text-red-400", advice: "Áü≠Ë¢ñ„ÄÅÁü≠Ë§≤„ÄÅÈò≤Êõ¨‰π≥„ÄÅÂ¢®Èè° (Â§öË£úÂÖÖÊ∞¥ÂàÜ)" };
            };
            const weatherInfo = getWeatherDetails(weatherTemp);
            const WeatherIcon = weatherInfo.icon;

            return (
                <div className="w-full animate-enter pb-32 space-y-4">
                    {/* Status Bar */}
                    <div className="flex gap-2">
                        <div className={`flex-1 p-3 rounded flex items-center gap-2 border ${isOffline ? 'bg-red-900/30 border-red-500' : 'bg-green-900/30 border-green-500'}`}>
                           {isOffline ? <WifiOff className="text-red-400" size={16}/> : <Zap className="text-green-400" size={16}/>}
                           <span className={`text-xs font-bold ${isOffline?'text-red-300':'text-green-300'}`}>{isOffline ? "Èõ¢Á∑öÊ®°Âºè" : "ÈÄ£Á∑öÊ≠£Â∏∏"}</span>
                        </div>
                        <div className="flex-1 bg-slate-900/50 border border-slate-700 p-3 rounded flex items-center justify-between">
                            <span className="text-[10px] text-slate-400">ÂåØÁéá (JPY‚ÜíTWD)</span>
                            <span className="text-xs font-mono font-bold text-yellow-500">{exchangeRate}</span>
                        </div>
                    </div>

                    {/* Weather & Outfit Card */}
                    <div className="bg-slate-800 border border-blue-400/50 p-4 rounded relative overflow-hidden">
                        <div className="flex items-start justify-between mb-3">
                            <div>
                                <div className="text-xs text-blue-400 font-bold mb-1 flex items-center gap-2"><MapPin size={12}/> ÂêçÂè§Â±ã (Nagoya)</div>
                                <div className="text-4xl font-bold text-white tracking-tighter">{weatherTemp}¬∞C</div>
                                <div className={`text-sm font-bold ${weatherInfo.color} flex items-center gap-1`}>
                                    <WeatherIcon size={14} /> {weatherInfo.text}
                                </div>
                            </div>
                            <Shirt className={`w-12 h-12 ${weatherInfo.color} opacity-80`} strokeWidth={1} />
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700/50">
                            <div className="text-[10px] text-slate-400 mb-1 uppercase tracking-wider">OUTFIT ADVICE</div>
                            <div className="text-xs text-slate-200 leading-relaxed">{weatherInfo.advice}</div>
                        </div>
                    </div>
                    
                    {/* Emergency Hub */}
                    <div className="grid grid-cols-3 gap-2">
                         <button onClick={() => setConfirmCall({num: '110', name: 'Ë≠¶ÂØü'})} className="bg-red-900/40 border border-red-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-red-900/60 transition">
                             <Siren className="text-red-500" size={24} />
                             <span className="text-xs font-bold text-red-200">Ë≠¶ÂØü 110</span>
                         </button>
                         <button onClick={() => setConfirmCall({num: '119', name: 'ÊïëË≠∑'})} className="bg-red-900/40 border border-red-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-red-900/60 transition">
                             <div className="relative"><Siren className="text-red-500" size={24} /><div className="absolute -top-1 -right-1 w-2 h-2 bg-white rounded-full animate-ping"></div></div>
                             <span className="text-xs font-bold text-red-200">ÊïëË≠∑ 119</span>
                         </button>
                         <button onClick={() => setSosModalContent('card')} className="bg-orange-900/40 border border-orange-600 p-3 rounded flex flex-col items-center justify-center gap-1 hover:bg-orange-900/60 transition">
                             <CreditCard className="text-orange-500" size={24} />
                             <span className="text-xs font-bold text-orange-200">Ê±ÇÂä©Â≠óÂç°</span>
                         </button>
                    </div>

                    {/* Call Confirmation Modal (Safeguard) */}
                    {confirmCall && (
                        <div className="fixed inset-0 z-[70] bg-black/90 flex flex-col items-center justify-center p-6 animate-in fade-in duration-200" onClick={() => setConfirmCall(null)}>
                            <div className="bg-slate-900 border-2 border-red-500 p-6 rounded-xl w-full max-w-sm text-center shadow-[0_0_50px_rgba(239,68,68,0.5)] relative overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent animate-pulse"></div>
                                <Siren className="w-16 h-16 text-red-500 mx-auto mb-4 animate-bounce" />
                                <h3 className="text-xl font-bold text-white mb-2">‚ö†Ô∏è Á∑äÊÄ•Êí•ËôüÁ¢∫Ë™ç</h3>
                                <p className="text-slate-400 mb-6 text-sm">Âç≥Â∞áÊí•Êâì <span className="text-red-400 font-bold text-lg mx-1">{confirmCall.name} ({confirmCall.num})</span></p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setConfirmCall(null)} className="py-3 rounded-lg border border-slate-600 text-slate-400 hover:bg-slate-800 transition">ÂèñÊ∂à</button>
                                    <button onClick={() => { window.open(`tel:${confirmCall.num}`); setConfirmCall(null); }} className="py-3 rounded-lg bg-red-600 text-white font-bold shadow-[0_0_15px_rgba(220,38,38,0.5)] hover:bg-red-500 transition flex items-center justify-center gap-2"><Phone size={16}/> Á¢∫Ë™çÊí•Êâì</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SOS Modal */}
                    {sosModalContent && (
                        <div className="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center p-6 animate-in fade-in duration-200" onClick={() => setSosModalContent(null)}>
                            <div className="text-center space-y-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <h3 className="text-red-500 font-bold text-xl mb-4 border-b border-red-900 pb-2">EMERGENCY CARD</h3>
                                <div className="space-y-4">
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">Ë´ãÂπ´ÊàëÂè´ÊïëË≠∑Ëªä</p>
                                        <p className="text-3xl font-black">ÊïëÊÄ•Ëªä„ÇíÂëº„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                                    </div>
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">ÊàëËø∑Ë∑Ø‰∫Ü</p>
                                        <p className="text-3xl font-black">ÈÅì„Å´Ëø∑„ÅÑ„Åæ„Åó„Åü</p>
                                    </div>
                                    <div className="bg-white text-black p-6 rounded-xl shadow-2xl">
                                        <p className="text-sm text-gray-500 mb-1">ÊàëÊòØÂè∞ÁÅ£‰∫∫</p>
                                        <p className="text-3xl font-black">ÁßÅ„ÅØÂè∞Êπæ‰∫∫„Åß„Åô</p>
                                    </div>
                                </div>
                                <button onClick={() => setSosModalContent(null)} className="mt-8 text-slate-500 text-sm border border-slate-700 px-6 py-2 rounded-full">ÈóúÈñâ (Close)</button>
                            </div>
                        </div>
                    )}

                    {/* Currency Converter Widget */}
                    <div className="bg-slate-800 border border-slate-700 p-4 rounded">
                        <h3 className="font-bold text-slate-300 mb-3 flex items-center gap-2"><Calculator size={16}/> Âø´ÈÄüÂåØÁéáÊèõÁÆó</h3>
                        <div className="flex items-center gap-2">
                            <div className="flex-1 relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">JPY</span>
                                <input type="number" placeholder="Êó•Âπ£ÈáëÈ°ç" value={calcAmount} onChange={(e) => setCalcAmount(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded pl-10 p-2 text-white outline-none focus:border-yellow-500 font-mono" />
                            </div>
                            <ArrowRightLeft className="text-slate-500" size={16} />
                            <div className="flex-1 bg-slate-900/50 border border-slate-700 rounded p-2 text-right font-mono text-yellow-400 font-bold">
                                {calcAmount ? `‚âà $${Math.round(calcAmount * exchangeRate).toLocaleString()}` : "$0"}
                            </div>
                        </div>
                    </div>

                    <div className="bg-slate-800 border border-blue-500 p-4 rounded relative overflow-hidden">
                        <div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 text-white font-bold">TRIP ID</div>
                        <h3 className="font-bold text-blue-300 mb-2 flex items-center gap-2"><Users size={16}/> Âçî‰ΩúÊóÖÁ®ã</h3>
                        <div className="flex gap-2"><input type="text" value={tempTripId} onChange={e=>setTempTripId(e.target.value)} className="flex-1 bg-slate-900 border-slate-600 p-2 text-xs rounded text-white font-mono"/><button onClick={joinTrip} className="bg-blue-600 px-3 text-xs rounded text-white">Âä†ÂÖ•/ÂàáÊèõ</button></div>
                        <div className="text-[10px] text-slate-500 mt-1">Â∞áÊ≠§ ID ÂàÜ‰∫´Áµ¶ÊúãÂèãÂç≥ÂèØÂÖ±ÂêåÁ∑®ËºØ„ÄÇ</div>
                    </div>

                    <div className="bg-slate-800 border border-green-500 p-4 rounded">
                        <div className="flex justify-between mb-3"><h3 className="font-bold text-green-300 flex items-center gap-2"><Ticket size={16}/> Á•®Âà∏Â§æ (Wallet)</h3><button onClick={()=>setIsEditingTicket(true)} className="text-xs bg-slate-700 px-2 rounded"><PlusCircle size={14}/></button></div>
                        {isEditingTicket && <div className="mb-4 bg-slate-900 p-3 rounded"><input type="text" placeholder="Á•®Âà∏ÂêçÁ®± (Â¶Ç: ËôéËà™ÂéªÁ®ã)" value={newTicket.title} onChange={e=>setNewTicket({...newTicket,title:e.target.value})} className="w-full mb-2 bg-slate-800 border-slate-600 p-2 text-xs text-white"/><input type="file" onChange={handleTicketUpload} className="text-xs text-slate-400 mb-2"/><button onClick={saveTicket} className="w-full bg-green-600 text-white text-xs py-1 rounded">Êñ∞Â¢ûÁ•®Âà∏</button></div>}
                        <div className="grid grid-cols-2 gap-2">{tickets.map(t=><div key={t.id} onClick={()=>t.image && window.open(t.image)} className="bg-slate-900 p-2 rounded border border-slate-700 relative cursor-pointer ticket-edge"><div className="text-xs font-bold mb-1">{t.title}</div><div className="text-[10px] bg-slate-800 px-1 rounded inline-block">{t.type}</div>{t.image && <div className="absolute top-2 right-2 text-green-500"><ImageIcon size={14}/></div>}<button onClick={(e)=>{e.stopPropagation();deleteTicket(t.id)}} className="absolute bottom-2 right-2 text-red-400"><Trash2 size={12}/></button></div>)}</div>
                    </div>

                    <div className="bg-slate-800 border border-slate-600 p-4 rounded">
                        <h3 className="font-bold text-slate-300 mb-3 flex gap-2"><Shield size={16}/> Ë£ùÂÇôÊ™¢Êü•</h3>
                        <div className="space-y-1">{checklist.map(i=><div key={i.id} onClick={()=>setChecklist(checklist.map(x=>x.id===i.id?{...x,checked:!x.checked}:x))} className={`flex items-center gap-2 p-2 rounded border border-slate-700 ${i.checked?'opacity-50 line-through bg-slate-900':'bg-slate-800'}`}><div className={`w-4 h-4 border ${i.checked?'bg-green-600':'border-slate-500'} rounded-sm flex items-center justify-center`}>{i.checked&&<Check size={12} className="text-white"/>}</div><span className="text-xs">{i.text}</span></div>)}</div>
                    </div>

                    <button onClick={resetQuests} className="w-full bg-red-900/30 border border-red-900 text-red-400 py-3 rounded text-xs flex items-center justify-center gap-2 mt-8 hover:bg-red-900/50 transition"><RotateCcw size={14}/> ‚ö†Ô∏è ÈáçÁΩÆË°åÁ®ãË≥áÊñô (‰øÆÂæ©Áº∫Â§±)</button>
                </div>
            );
        }

        // --- App Provider ---
        const AppProvider = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('quest');
            const [activeLevel, setActiveLevel] = useState(0);
            const [tripId, setTripId] = useState(localStorage.getItem('tripId') || ''); 
            const [exchangeRate, setExchangeRate] = useState(0.22);
            const [countdown, setCountdown] = useState("");
            const [weatherForecast, setWeatherForecast] = useState({});
            const [weatherTemp, setWeatherTemp] = useState(15); 

            useEffect(() => {
                const initAuth = async () => { 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Custom token auth failed", e);
                            if (USE_REAL_GOOGLE_AUTH) await signInWithPopup(getAuth(app), new GoogleAuthProvider()).catch(console.error);
                            else await signInAnonymously(getAuth(app));
                        }
                    } else if (USE_REAL_GOOGLE_AUTH) {
                        // In preview environment, popup might be blocked. 
                        // If user hasn't clicked login, this might fail or do nothing.
                        // We do nothing here and let the LoginView handle it via button click.
                    } else {
                        await signInAnonymously(getAuth(app)); 
                    }
                };
                
                initAuth();

                onAuthStateChanged(getAuth(app), u => { 
                    setUser(u); setAuthLoading(false); 
                    if(u && !tripId) { const tid = u.uid.substring(0,6); setTripId(tid); localStorage.setItem('tripId', tid); }
                });
            }, []);

            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo').then(r=>r.json()).then(data=>{
                    const map = {}; data.daily.time.forEach((t, i) => { map[i] = { max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weathercode[i] }; });
                    setWeatherForecast(map);
                }).catch(console.error);
                fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r=>r.json()).then(d=>setExchangeRate(d.rates.TWD)).catch(console.error);
                // Real-time for InfoView
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&current_weather=true').then(r=>r.json()).then(d=>{ if(d?.current_weather?.temperature) setWeatherTemp(d.current_weather.temperature); }).catch(console.log);

                const targetDate = new Date('2026-03-02T16:45:00').getTime();
                const interval = setInterval(() => {
                    const now = new Date();
                    const d = targetDate - now.getTime();
                    if(d<0) setCountdown("ÈÄ≤Ë°å‰∏≠"); else setCountdown(`${Math.floor(d/(1000*60*60*24))}Â§©${Math.floor((d%(1000*60*60*24))/(1000*60*60))}ÊôÇ`);
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // Firestore Data (using tripId) with offline fallback
            const [checklist, setChecklist, checklistOffline] = useFirestoreData(user, tripId, 'checklist', INITIAL_CHECKLIST);
            const [expenses, setExpenses, expensesOffline] = useFirestoreData(user, tripId, 'expenses', INITIAL_EXPENSES);
            const [quests, setQuests, questsOffline] = useFirestoreData(user, tripId, 'quests', INITIAL_QUEST_DATA);
            const [shoppingList, setShoppingList, shoppingOffline] = useFirestoreData(user, tripId, 'shopping', []);
            const [tickets, setTickets, ticketsOffline] = useFirestoreData(user, tripId, 'tickets', []);
            const [settingsData, updateSettings, settingsOffline] = useFirestoreData(user, tripId, 'settings', { budget: 100000, cashBudget: 50000 }, true);
            
            const isOffline = checklistOffline || expensesOffline || questsOffline; // Global offline status

            const budget = settingsData?.budget || 100000;
            const setBudget = (val) => updateSettings({ ...settingsData, budget: val });
            
            // Dynamic Stats Calculation
            const stats = useMemo(() => {
                let completedCount = 0;
                let dayEvents = 0;
                let dayCompleted = 0;
                
                quests.forEach((q, i) => {
                    q.events.forEach(e => {
                        if(e.completed) completedCount++;
                        if(i === activeLevel) { dayEvents++; if(e.completed) dayCompleted++; }
                    });
                });

                const totalSpent = expenses.reduce((a,c)=>a+c.cost,0);
                
                return {
                    xp: completedCount * 150,
                    goldRemaining: budget - totalSpent,
                    fatigue: dayEvents > 0 ? Math.round((dayCompleted / dayEvents) * 100) : 0
                };
            }, [quests, expenses, budget, activeLevel]);

            // Fix: Re-define speakJapanese inside Context correctly to capture 'text'
            const speakJapaneseFixed = useCallback((text) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';
                u.rate = 0.7; // Ë®≠ÂÆöË™ûÈÄüÁÇ∫ 0.7
                const voices = window.speechSynthesis.getVoices();
                const jpVoice = voices.find(v => v.lang === 'ja-JP' || v.lang === 'ja_JP' || v.name.includes('Kyoko') || v.name.includes('Google Êó•Êú¨Ë™û') || v.name.includes('Microsoft Haruka'));
                if (jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }, []);

            // Re-create value object with fixed function
            const contextValueFixed = useMemo(() => ({
                 user, tripId, setTripId, checklist, setChecklist, expenses, setExpenses, quests, setQuests, budget, setBudget,
                 shoppingList, setShoppingList, tickets, setTickets, activeTab, setActiveTab, activeLevel, setActiveLevel, 
                 countdown, exchangeRate, weatherForecast, weatherTemp, speakJapanese: speakJapaneseFixed,
                 stats, isOffline, settingsData, updateSettings
            }), [user, tripId, checklist, expenses, quests, shoppingList, tickets, budget, activeTab, activeLevel, countdown, exchangeRate, weatherForecast, weatherTemp, speakJapaneseFixed, stats, isOffline, settingsData, updateSettings]);


            if (authLoading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white"><Loader2 className="animate-spin text-yellow-500" size={40}/></div>;
            if (!user) return <LoginView onLogin={() => signInWithPopup(getAuth(app), new GoogleAuthProvider())} />;

            return <AppContext.Provider value={contextValueFixed}><MainLayout /></AppContext.Provider>;
        };

        const MainLayout = () => {
            const { activeTab, setActiveTab } = useContext(AppContext);
            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto shadow-2xl border-x border-slate-800 bg-slate-900 relative">
                    <div className="w-full mb-6 border-b border-slate-800 pb-4 text-center sticky top-0 bg-slate-900/95 backdrop-blur z-20 pt-4 px-4 shadow-lg"><h1 className="text-xl font-bold tracking-widest text-yellow-400 mb-2 flex justify-center gap-2"><MapPin/> ÂêçÂè§Â±ãÂÜíÈö™Êó•Ë™å</h1></div>
                    <div className="px-4">
                        {activeTab === 'quest' && <QuestView />}
                        {activeTab === 'inventory' && <InventoryView />}
                        {activeTab === 'grimoire' && <GrimoireView />}
                        {activeTab === 'guide' && <GuideView />}
                        {activeTab === 'info' && <InfoView />}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900 border-t border-slate-700 p-2 z-30 pb-safe grid grid-cols-5 gap-1">
                        <button onClick={()=>setActiveTab('quest')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='quest'?'text-yellow-400':'text-slate-500'}`}><Scroll size={20}/><span className="text-[10px]">‰ªªÂãô</span></button>
                        <button onClick={()=>setActiveTab('inventory')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='inventory'?'text-yellow-400':'text-slate-500'}`}><Coins size={20}/><span className="text-[10px]">Ë°åÂõä</span></button>
                        <button onClick={()=>setActiveTab('grimoire')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='grimoire'?'text-yellow-400':'text-slate-500'}`}><BookOpen size={20}/><span className="text-[10px]">È≠îÂ∞éÊõ∏</span></button>
                        <button onClick={()=>setActiveTab('guide')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='guide'?'text-yellow-400':'text-slate-500'}`}><Compass size={20}/><span className="text-[10px]">Â∞éË¶Ω</span></button>
                        <button onClick={()=>setActiveTab('info')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='info'?'text-yellow-400':'text-slate-500'}`}><Info size={20}/><span className="text-[10px]">Ë≥áË®ä</span></button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AppProvider />);

    </script>
</body>
</html>