<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹å†’éšªæ—¥èªŒ | Nagoya Adventure Log</title>
    
    <!-- 1. Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { slate: { 850: '#151e32', 900: '#0f172a' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
    
    <!-- 3. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- 4. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <!-- 5. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --bg-dark: #0f172a; --text-main: #e2e8f0; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glow-text { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .pie-chart { width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(var(--pie-gradient)); position: relative; flex-shrink: 0; }
        .pie-chart::after { content: ""; position: absolute; inset: 35px; background: #1e293b; border-radius: 50%; }
        .ticket-edge { mask-image: radial-gradient(circle at center, transparent 10px, black 11px); mask-position: -10px 50%; mask-size: 100% 200%; mask-repeat: no-repeat; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, 
            Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
            Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Thermometer,
            TrendingUp, Save, Clock, Map, PieChart, Volume2, Image as ImageIcon, Navigation, Timer, Bus, Car, Ticket,
            Compass, Search, ArrowRightLeft, Landmark, LogOut, User, Star, Check, FileText, CreditCard, Wallet, Users,
            CloudRain, CloudSun, Sun, Share2, Copy
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, enableIndexedDbPersistence } from 'firebase/firestore';

        // --- CONFIGURATION ---
        const USE_REAL_GOOGLE_AUTH = true; 
        const userFirebaseConfig = {
            apiKey: "AIzaSyDuVNALTfclUEXxhlDEolTLX_68mkyW59k",
            authDomain: "rpg-travel-app.firebaseapp.com",
            projectId: "rpg-travel-app",
            storageBucket: "rpg-travel-app.firebasestorage.app",
            messagingSenderId: "120243575408",
            appId: "1:120243575408:web:eb941d7a7af5cd65ecf2b5",
            measurementId: "G-0ZSW6HSN2S"
        };

        const systemConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = (systemConfig) ? systemConfig : userFirebaseConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            enableIndexedDbPersistence(db).catch((err) => console.log('Persistence:', err.code));
        } catch (e) { console.error("Firebase Init Error:", e); }

        const AppContext = createContext();

        // --- Constants ---
        const ICON_MAP = { Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle, Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Save, Clock, Map, PieChart, Volume2, ImageIcon, Navigation, Timer, Bus, Car, Ticket, Compass, Search, ArrowRightLeft, Landmark, Star, CreditCard, Wallet, Users, CloudRain, CloudSun, Sun };
        
        const SPELL_DATA = [ { icon: "ğŸ§…", title: "é©…é™¤è”¥èŠ±", jp: "ãƒã‚®æŠœãã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹ä¸è¦åŠ è”¥", type: "defense" }, { icon: "ğŸ§Š", title: "å»å†°å’’", jp: "æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹å»å†°", type: "support" }, { icon: "ğŸ’§", title: "å¬å–šæ°´", jp: "ãŠæ°´ãã ã•ã„", zh: "è«‹çµ¦æˆ‘æ°´", type: "support" }, { icon: "ğŸš»", title: "å°‹æ‰¾å¯†å®¤", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", zh: "å»æ‰€åœ¨å“ªè£¡", type: "exploration" }, { icon: "ğŸ§¾", title: "çµç®—å·è»¸", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹çµå¸³", type: "interaction" }, { icon: "ğŸ“¸", title: "æ”é­‚è¡“", jp: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ", zh: "å¯ä»¥æ‹ç…§å—ï¼Ÿ", type: "interaction" }, { icon: "ğŸ™", title: "ç¥ˆæ±‚è¡“", jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", zh: "æˆ‘è¦é€™å€‹ (æŒ‡èœå–®)", type: "interaction" }, { icon: "ğŸ¥¡", title: "å¸¶èµ°è¡“", jp: "æŒã¡å¸°ã‚Šã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹å¹«æˆ‘å¤–å¸¶", type: "support" } ];
        const GUIDE_DETAILS = [ { id: 'nagoya_castle', title: 'åå¤å±‹åŸ', subtitle: 'é‡‘é¯±é–ƒè€€çš„å°¾å¼µå¾·å·å®¶å±…åŸ', tags: ['æ­·å²', 'ç™¾å¤§ååŸ'], image: 'ğŸ¯', desc: 'æ—¥æœ¬ä¸‰ååŸä¹‹ä¸€ã€‚', content: { history: 'ç”±å¾·å·å®¶åº·æ–¼1612å¹´å»ºé€ ã€‚', features: 'ã€æœ¬ä¸¸å¾¡æ®¿ã€‘å…§éƒ¨é‡‘ç¢§è¼ç…Œã€‚', tips: 'æ¨è–¦äºŒä¹‹ä¸¸åº­åœ’æ•£æ­¥ã€‚', warning: 'å¤©å®ˆé–£ç›®å‰é–‰é¤¨ä¸­ã€‚' } }, { id: 'inuyama', title: 'çŠ¬å±±åŸ', subtitle: 'åœ‹å¯¶äº”åŸä¹‹ä¸€', tags: ['åœ‹å¯¶', 'é¢¨æ™¯'], image: 'ğŸ°', desc: 'æ—¥æœ¬ç¾å­˜æœ€å¤è€çš„æœ¨é€ å¤©å®ˆé–£ã€‚', content: { history: 'ç¹”ç”°ä¿¡åº·æ–¼1537å¹´å»ºé€ ã€‚', features: 'æ¨“æ¢¯éå¸¸é™¡å³­ã€‚', tips: 'å±±ä¸‹æœ‰ç²‰ç´…æ„›å¿ƒç¹ªé¦¬ã€‚', warning: 'å»ºè­°ç©¿è‘—ä¾¿æ–¼æ´»å‹•çš„æœè£ã€‚' } }, { id: 'osu', title: 'å¤§é ˆå•†åº—è¡—', subtitle: 'æ··æ­æ–‡åŒ–ç™¼æºåœ°', tags: ['é€›è¡—', 'ç¾é£Ÿ'], image: 'ğŸ›ï¸', desc: 'èåˆå¤è‘—ã€å‹•æ¼«èˆ‡ç¾é£Ÿçš„æ´»åŠ›å•†åº—è¡—ã€‚', content: { history: 'é–€å‰ç”ºç™¼å±•è€Œä¾†ã€‚', features: 'è¶…é1200å®¶åº—é‹ªã€‚', tips: 'å¿…åƒç‚¸é›èˆ‡ç³°å­ã€‚', warning: 'ç¯„åœå¤§å®¹æ˜“è¿·è·¯ã€‚' } }, { id: 'atsuta', title: 'ç†±ç”°ç¥å®®', subtitle: 'å¿ƒéˆå¯„è¨—åƒå¹´å¤å‰', tags: ['ç¥ç¤¾', 'ç¥è©±'], image: 'â›©ï¸', desc: 'ä¾›å¥‰è‰è–™åŠï¼Œåœ°ä½å´‡é«˜ã€‚', content: { history: 'è¿‘å…©åƒå¹´æ­·å²ã€‚', features: 'ä¿¡é•·å£ã€‚', tips: 'åƒæ‹œå®Œåƒè“¬èŠè»’é°»é­šé£¯ã€‚', warning: 'èšŠèŸ²è¼ƒå¤šã€‚' } }, { id: 'sakae', title: 'æ¦® / ç¶ æ´²21', subtitle: 'æ™‚å°šä¸­å¿ƒèˆ‡å¤œæ™¯', tags: ['å¤œæ™¯', 'è³¼ç‰©'], image: 'ğŸŒƒ', desc: 'ç¶ æ´²21çš„æ°´ä¹‹å®‡å®™èˆ¹æ˜¯å¿…æ‹æ™¯é»ã€‚', content: { history: 'ç¾ä»£åŒ–è±¡å¾µã€‚', features: 'å±‹é ‚å¯æ•£æ­¥ã€‚', tips: 'æ—é‚Šæœ‰é›»è¦–å¡”ã€‚', warning: 'æ™šä¸Šé¢¨å¤§ã€‚' } } ];
        const INITIAL_CHECKLIST = [ { id: 1, text: "è­·ç…§", checked: false }, { id: 2, text: "ç¶²å¡/æ¼«éŠ", checked: false }, { id: 3, text: "æ—¥å¹£ç¾é‡‘", checked: false }, { id: 4, text: "è¡Œå‹•é›»æº", checked: false }, { id: 5, text: "å¸¸ç”¨è—¥å“", checked: false }, { id: 6, text: "VJWæˆªåœ–", checked: false } ];
        const INITIAL_EXPENSES = [ { id: 1, item: "æ©Ÿç¥¨é ä»˜", cost: 12000, type: "travel", date: "2025-10-15", method: "card", payer: "me" }, { id: 2, item: "ä½å®¿é è¨‚", cost: 8000, type: "save", date: "2025-11-20", method: "card", payer: "me" } ];
        const INITIAL_QUEST_DATA = [
            { day: 0, title: "åºç« : é™è½èˆ‡æ½›å…¥", date: "2026-03-02", stats: { xp: "500 XP", gold: 0, fatigue: "30%" }, events: [{ id: 'e0', time: "16:45", icon: "Plane", title: "å•Ÿç¨‹: æ¡ƒåœ’æ©Ÿå ´", desc: "æ­ä¹˜è™èˆª IT778", type: "start", transportTime: "", transportCost: 0, transportMode: "" }, { id: 'e1', time: "20:25", icon: "MapPin", title: "æŠµé”æ–°åœ°åœ–", desc: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ T2", type: "checkpoint", transportTime: "3h 40m", transportCost: 0, transportMode: "Plane" }, { id: 'e6', time: "22:40", icon: "Home", title: "å­˜æª”é»: Trip & Sleep", desc: "è¾¦ç†å…¥ä½", type: "save", transportTime: "1h", transportCost: 1250, transportMode: "Train" }] },
            { day: 1, title: "ç¬¬ä¸€ç« : å¸‚å ´èˆ‡ç¥æ®¿", date: "2026-03-03", stats: { xp: "1200 XP", gold: 0, fatigue: "60%" }, events: [{ id: 'e11', time: "08:00", icon: "Home", title: "å†’éšªé–‹å§‹", desc: "å¾ Hostel å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" }, { id: 'e12', time: "08:45", icon: "Utensils", title: "æŸ³æ©‹ä¸­å¤®å¸‚å ´", desc: "æµ·é®®å·¡ç¦®", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Train" }, { id: 'e13', time: "12:00", icon: "Utensils", title: "åˆé¤: é³¥é–‹ç·æœ¬å®¶", desc: "è¦ªå­ä¸¼", type: "loot", transportTime: "15m", transportCost: 0, transportMode: "Footprints" }, { id: 'e14', time: "13:30", icon: "ShoppingBag", title: "å¤§é ˆå•†åº—è¡—", desc: "äº¤æ˜“èˆ‡æ¢ç´¢", type: "action", transportTime: "20m", transportCost: 210, transportMode: "Train" }, { id: 'e15', time: "15:30", icon: "Coffee", title: "ä¸‹åˆèŒ¶: Konparu", desc: "ç‚¸è¦ä¸‰æ˜æ²»", type: "heal", transportTime: "5m", transportCost: 0, transportMode: "Footprints" }, { id: 'e16', time: "18:30", icon: "Utensils", title: "æ™šé¤: ç†±ç”°è“¬èŠè»’", desc: "é°»é­šé£¯ä¸‰åƒ", type: "boss", transportTime: "30m", transportCost: 270, transportMode: "Train" }, { id: 'e17', time: "20:30", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "40m", transportCost: 270, transportMode: "Train" }] },
            { day: 2, title: "ç¬¬äºŒç« : å¤åŸèˆ‡å’–å•¡", date: "2026-03-04", stats: { xp: "1500 XP", gold: 0, fatigue: "75%" }, events: [{ id: 'e20', time: "07:45", icon: "Home", title: "æ—©å®‰åå¤å±‹", desc: "å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" }, { id: 'e21', time: "08:00", icon: "Coffee", title: "æ—©é¤: Bucyo Coffee", desc: "å°å€‰ç´…è±†åå¸", type: "heal", transportTime: "15m", transportCost: 0, transportMode: "Footprints" }, { id: 'e22', time: "10:00", icon: "MapPin", title: "çŠ¬å±±åŸ", desc: "åœ‹å¯¶å¤©å®ˆé–£", type: "dungeon", transportTime: "50m", transportCost: 600, transportMode: "Train" }, { id: 'e23', time: "12:30", icon: "Utensils", title: "åˆé¤: Sakura Chaya", desc: "ç”°æ¨‚çƒ¤è±†è…", type: "loot", transportTime: "10m", transportCost: 0, transportMode: "Footprints" }, { id: 'e24', time: "15:00", icon: "Coffee", title: "GOLPIE COFFEE", desc: "å† è»å’–å•¡", type: "action", transportTime: "1h 20m", transportCost: 800, transportMode: "Train" }, { id: 'e25', time: "18:00", icon: "Utensils", title: "Solo Pizza", desc: "å† è»æŠ«è–©", type: "loot", transportTime: "30m", transportCost: 240, transportMode: "Train" }, { id: 'e26', time: "20:00", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "15m", transportCost: 0, transportMode: "Footprints" }] },
            { day: 3, title: "ç¬¬ä¸‰ç« : å°‡è»çš„æ¦®è€€", date: "2026-03-05", stats: { xp: "1800 XP", gold: 0, fatigue: "85%" }, events: [{ id: 'e30', time: "07:45", icon: "Home", title: "æ—©å®‰åå¤å±‹", desc: "å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" }, { id: 'e31', time: "08:00", icon: "Coffee", title: "æ—©é¤: Karasu", desc: "è€æ´¾å’–å•¡å»³", type: "heal", transportTime: "15m", transportCost: 210, transportMode: "Train" }, { id: 'e32', time: "09:30", icon: "MapPin", title: "åå¤å±‹åŸ", desc: "é‡‘é¯±èˆ‡æœ¬ä¸¸å¾¡æ®¿", type: "dungeon", transportTime: "20m", transportCost: 210, transportMode: "Bus" }, { id: 'e33', time: "11:30", icon: "Camera", title: "å¾·å·åœ’", desc: "æ—¥å¼åº­åœ’", type: "action", transportTime: "30m", transportCost: 210, transportMode: "Bus" }, { id: 'e34', time: "13:00", icon: "Utensils", title: "åˆé¤: Yellow", desc: "æ­å§†è›‹åŒ…é£¯", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Bus" }, { id: 'e35', time: "15:00", icon: "ShoppingBag", title: "æ¦® (Sakae)", desc: "è³¼ç‰©", type: "trade", transportTime: "20m", transportCost: 210, transportMode: "Train" }, { id: 'e36', time: "18:00", icon: "Utensils", title: "æ™šé¤: æµ·è€ã©ã¦", desc: "ç‰¹å¤§ç‚¸è¦", type: "boss", transportTime: "10m", transportCost: 0, transportMode: "Footprints" }, { id: 'e37', time: "20:00", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "15m", transportCost: 210, transportMode: "Train" }] },
            { day: 4, title: "çµ‚ç« : æ­¸é€”", date: "2026-03-06", stats: { xp: "2000 XP", gold: 0, fatigue: "99%" }, events: [{ id: 'e41', time: "09:40", icon: "Home", title: "é€€æˆ¿", desc: "å‰å¾€æ©Ÿå ´", type: "start", transportTime: "", transportCost: 0, transportMode: "" }, { id: 'e42', time: "09:50", icon: "Train", title: "åœ°ä¸‹éµç§»å‹•", desc: "ä¸Šå‰æ´¥ -> é‡‘å±±", type: "travel", transportTime: "10m", transportCost: 210, transportMode: "Train" }, { id: 'e43', time: "10:18", icon: "Train", title: "åéµç‰¹æ€¥ Î¼-SKY", desc: "é‡‘å±± -> æ©Ÿå ´", type: "travel", transportTime: "28m", transportCost: 1250, transportMode: "Train" }, { id: 'e44', time: "10:50", icon: "MapPin", title: "æŠµé”æ©Ÿå ´ T1", desc: "å‰å¾€äº¤é€šå»£å ´", type: "checkpoint", transportTime: "5m", transportCost: 0, transportMode: "Footprints" }, { id: 'e45', time: "11:05", icon: "Footprints", title: "æ­¥è¡Œè‡³ T2", desc: "é•·è·é›¢ç§»å‹•", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints" }, { id: 'e46', time: "11:05", icon: "Plane", title: "å ±åˆ° & è¨—é‹", desc: "IT779 (13:15)", type: "action", transportTime: "0m", transportCost: 0, transportMode: "" }, { id: 'e47', time: "13:15", icon: "Plane", title: "è¿”èˆª: IT779", desc: "é£›å¾€æ¡ƒåœ’", type: "travel", transportTime: "", transportCost: 0, transportMode: "Plane" }, { id: 'e48', time: "15:25", icon: "Home", title: "Mission Complete", desc: "ä»»å‹™çµæŸ", type: "end", transportTime: "3h 10m", transportCost: 0, transportMode: "Plane" }] }
        ];

        const EXPENSE_TYPES = [ { id: 'loot', label: 'ç¾é£Ÿ', color: 'bg-yellow-600 text-yellow-100', border: 'border-yellow-500' }, { id: 'travel', label: 'äº¤é€š', color: 'bg-blue-600 text-blue-100', border: 'border-blue-500' }, { id: 'save', label: 'ä½å®¿', color: 'bg-green-600 text-green-100', border: 'border-green-500' }, { id: 'trade', label: 'è³¼ç‰©', color: 'bg-pink-300 text-pink-900', border: 'border-pink-300' }, { id: 'other', label: 'å…¶ä»–', color: 'bg-slate-600 text-slate-100', border: 'border-slate-500' } ];
        const TRANSPORT_MODES = [ { id: 'Footprints', icon: Footprints, label: 'æ­¥è¡Œ' }, { id: 'Train', icon: Train, label: 'é›»è»Š' }, { id: 'Bus', icon: Bus, label: 'å…¬è»Š' }, { id: 'Car', icon: Car, label: 'é–‹è»Š' }, { id: 'Plane', icon: Plane, label: 'é£›æ©Ÿ' } ];

        // --- Hook with Trip ID Support ---
        function useFirestoreData(tripId, collectionName, initialData, isObject = false) {
            const [data, setData] = useState(initialData);
            useEffect(() => {
                if (!tripId) return;
                let collectionRef;
                if (typeof __app_id !== 'undefined') collectionRef = collection(db, 'artifacts', __app_id, 'trips', tripId, collectionName);
                else collectionRef = collection(db, 'trips', tripId, collectionName);

                const docRef = doc(collectionRef, 'main'); 
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) setData(isObject ? docSnap.data() : docSnap.data().items);
                    else { setDoc(docRef, isObject ? initialData : { items: initialData }); setData(initialData); }
                });
                return () => unsubscribe();
            }, [tripId, collectionName]);

            const updateData = (newData) => {
                setData(newData);
                if (!tripId) return;
                let collectionRef;
                if (typeof __app_id !== 'undefined') collectionRef = collection(db, 'artifacts', __app_id, 'trips', tripId, collectionName);
                else collectionRef = collection(db, 'trips', tripId, collectionName);
                const docRef = doc(collectionRef, 'main');
                setDoc(docRef, isObject ? newData : { items: newData }).catch(e => {
                    if (e.code === 'resource-exhausted') alert("âš ï¸ é›²ç«¯ç©ºé–“ä¸è¶³ï¼Œè«‹åˆªé™¤éƒ¨åˆ†ç…§ç‰‡ã€‚");
                });
            };
            return [data, updateData];
        }

        // --- SUB-COMPONENTS ---
        const LoginView = ({ onLogin }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] animate-enter"><div className="bg-slate-800 border-2 border-yellow-500 p-8 rounded-lg shadow-2xl text-center max-w-xs w-full relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-yellow-500 to-red-500"></div><div className="mb-6"><div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto border-4 border-yellow-500 mb-4 shadow-[0_0_20px_rgba(234,179,8,0.5)]"><Shield size={40} className="text-yellow-500" /></div><h2 className="text-2xl font-bold text-yellow-400 mb-1">å†’éšªè€…ç™»å…¥</h2><p className="text-xs text-slate-400 font-mono">ADVENTURER LOGIN</p></div><button onClick={onLogin} className="w-full bg-white hover:bg-slate-200 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-3 transition group"><User size={20} />{USE_REAL_GOOGLE_AUTH ? "ä½¿ç”¨ Google å¸³è™Ÿ" : "ä»¥è¨ªå®¢èº«ä»½é€²å…¥"}</button></div></div>
        );

        const QuestView = () => {
            const { quests, setQuests, activeLevel, setActiveLevel, countdown, weatherForecast } = useContext(AppContext);
            const [isAddingEvent, setIsAddingEvent] = useState(false);
            const [newEventData, setNewEventData] = useState({ time: "10:00", title: "", desc: "", type: "action", locationQuery: "", transportTime: "", transportCost: "", transportMode: "Footprints", tags: "" });
            const fileInputRef = useRef(null); const [uploadingEventId, setUploadingEventId] = useState(null);
            
            const triggerImageUpload = (id) => { setUploadingEventId(id); fileInputRef.current.click(); };
            const handleImageUpload = (e) => {
                const file = e.target.files[0]; if (!file || !uploadingEventId) return;
                const reader = new FileReader(); reader.onload = (ev) => {
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 800/img.width; c.width=Math.min(img.width,800); c.height=img.height*s; ctx.drawImage(img,0,0,c.width,c.height);
                        const base64 = c.toDataURL('image/jpeg', 0.5);
                        const newQuests = [...quests]; const day = newQuests[activeLevel].events; const idx = day.findIndex(e=>e.id===uploadingEventId); if(idx>-1){ day[idx].image=base64; setQuests(newQuests); }
                    }; img.src = ev.target.result;
                }; reader.readAsDataURL(file); e.target.value='';
            };
            const saveNewEvent = () => {
                if(!newEventData.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
                let icon = "MapPin"; if(newEventData.type==='travel') icon="Train"; else if(newEventData.type==='loot') icon="Utensils"; else if(newEventData.type==='save') icon="Home";
                const event = { ...newEventData, id: Date.now().toString(), icon, transportCost: parseInt(newEventData.transportCost)||0, tags: newEventData.tags.split(' ').filter(t=>t) };
                const newQuests = [...quests]; newQuests[activeLevel].events.push(event); newQuests[activeLevel].events.sort((a,b)=>a.time.localeCompare(b.time));
                setQuests(newQuests); setIsAddingEvent(false);
            };
            const deleteEvent = (eventId) => {
                 if(!window.confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                 const newQuests = [...quests]; newQuests[activeLevel].events = newQuests[activeLevel].events.filter(e => e.id !== eventId); setQuests(newQuests);
            };
            const updateNote = (text) => { const newQuests=[...quests]; newQuests[activeLevel].note = text; setQuests(newQuests); };
            const weather = weatherForecast[activeLevel] || {};
            const WeatherIcon = weather.code < 3 ? Sun : (weather.code < 60 ? CloudSun : CloudRain);

            return (
                <div className="animate-enter w-full pb-20">
                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    <div className="flex w-full overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar px-1">{quests.map((q, i) => (<button key={i} onClick={() => setActiveLevel(i)} className={`flex-shrink-0 px-4 py-2 border-2 text-xs font-bold whitespace-nowrap rounded-sm ${activeLevel === i ? "bg-blue-600 border-blue-400 text-white" : "bg-slate-800 border-slate-600 text-slate-400"}`}>{i===0?"åºç« ":i===4?"çµ‚ç« ":`Day ${i}`}</button>))}</div>
                    <div className="w-full bg-slate-800 border-2 border-slate-600 p-4 mb-6 rounded-sm relative overflow-hidden">
                        <div className="flex justify-between items-start"><h2 className="text-xl font-bold text-green-400 mb-1">{quests[activeLevel].title}</h2></div>
                        <div className="text-sm text-slate-400 mb-4 flex justify-between items-center"><span className="flex items-center gap-2"><Calendar size={12}/> {quests[activeLevel].date} {weather.max && <span className="flex items-center gap-1 text-yellow-300 ml-2"><WeatherIcon size={14}/> {weather.min}Â°-{weather.max}Â°</span>}</span><span className="text-blue-400 font-mono text-xs">T-{countdown}</span></div>
                    </div>
                    <div className="w-full relative pl-4">
                        <div className="absolute left-[27px] top-4 bottom-4 w-1 bg-slate-700 z-0"></div>
                        {quests[activeLevel].events.map((ev, idx) => {
                            const IconC = ICON_MAP[ev.icon] || MapPin; const ModeIcon = ICON_MAP[ev.transportMode] || Footprints;
                            return (
                                <div key={ev.id} className="relative z-10 mb-6 group">
                                    {(ev.transportTime || ev.transportCost > 0) && (<div className="flex items-center ml-[19px] mb-3 relative"><div className="w-2 h-2 bg-slate-600 rounded-full border-2 border-slate-900 z-20"></div><div className="ml-4 flex items-center gap-2 text-[10px] text-slate-400 bg-slate-900/90 px-2 py-1 rounded border border-slate-700"><ModeIcon size={12}/> {ev.transportTime} {ev.transportCost > 0 && <span className="text-yellow-500">Â¥{ev.transportCost}</span>}</div></div>)}
                                    <div className="flex items-start"><div className={`w-12 h-12 flex-shrink-0 rounded-lg border-2 flex items-center justify-center bg-slate-900 shadow-lg z-10 border-slate-500 text-slate-400`}><IconC size={20}/></div><div className="ml-4 flex-1 border-2 border-slate-600 bg-slate-800/50 p-3 rounded-lg relative"><div className="absolute top-4 -left-2 w-3 h-3 border-l-2 border-b-2 border-inherit bg-slate-900 transform rotate-45"></div>
                                    <div className="flex justify-between mb-1"><span className="font-bold text-sm">{ev.title}</span><span className="text-xs font-mono opacity-50">{ev.time}</span></div><p className="text-xs opacity-70 mb-2">{ev.desc}</p>
                                    {ev.tags && <div className="flex gap-1 mb-2">{ev.tags.map(t=><span key={t} className="text-[9px] bg-blue-900 text-blue-200 px-1 rounded">#{t}</span>)}</div>}
                                    {ev.image && <img src={ev.image} className="w-full h-32 object-cover rounded border border-slate-700 mb-2"/>}
                                    <div className="flex justify-end gap-2 opacity-50 group-hover:opacity-100"><button onClick={()=>triggerImageUpload(ev.id)}><ImageIcon size={14}/></button><button onClick={()=>deleteEvent(ev.id)} className="text-red-400"><Trash2 size={14}/></button></div>
                                    </div></div>
                                </div>
                            )
                        })}
                        <div className="relative z-10 mt-4 mb-10 pl-16"><button onClick={() => setIsAddingEvent(true)} className="w-full border-2 border-dashed border-slate-600 text-slate-500 rounded-lg p-3 hover:text-white"><PlusCircle className="inline mr-2"/>æ–°å¢è¡Œç¨‹</button></div>
                        <div className="ml-4 mt-8 bg-slate-900 border border-slate-700 p-3 rounded"><h4 className="text-xs text-blue-400 mb-2 font-bold flex items-center gap-2"><FileText size={12}/> å†’éšªæ—¥è¨˜ (Journal)</h4><textarea className="w-full bg-transparent text-sm text-white outline-none resize-none h-24" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼è¶£äº‹..." value={quests[activeLevel].note||""} onChange={(e)=>updateNote(e.target.value)}></textarea></div>
                    </div>
                    {isAddingEvent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"><div className="bg-slate-900 border-2 border-yellow-600 w-full max-w-sm rounded p-5"><h3 className="text-yellow-500 font-bold mb-4">æ–°å¢è¡Œç¨‹</h3>
                        <div className="space-y-3">
                            <input type="time" value={newEventData.time} onChange={e=>setNewEventData({...newEventData,time:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                            <input type="text" placeholder="åœ°é»" value={newEventData.title} onChange={e=>setNewEventData({...newEventData,title:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                            <input type="text" placeholder="æè¿°" value={newEventData.desc} onChange={e=>setNewEventData({...newEventData,desc:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                            <div className="flex gap-2"><input type="text" placeholder="ç§»å‹•æ™‚é–“ (15m)" value={newEventData.transportTime} onChange={e=>setNewEventData({...newEventData,transportTime:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/><input type="number" placeholder="è²»ç”¨ (Â¥)" value={newEventData.transportCost} onChange={e=>setNewEventData({...newEventData,transportCost:e.target.value})} className="w-1/2 bg-slate-800 border-slate-600 rounded p-2 text-white"/></div>
                            <input type="text" placeholder="#æ¨™ç±¤ (ä»¥ç©ºç™½åˆ†éš”)" value={newEventData.tags} onChange={e=>setNewEventData({...newEventData,tags:e.target.value})} className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"/>
                            <button onClick={saveNewEvent} className="w-full bg-yellow-600 text-black font-bold py-2 rounded">å„²å­˜</button><button onClick={()=>setIsAddingEvent(false)} className="w-full text-slate-500 text-xs mt-2">å–æ¶ˆ</button>
                        </div></div></div>
                    )}
                </div>
            );
        };

        const InventoryView = () => {
            const { expenses, setExpenses, budget, setBudget, exchangeRate, shoppingList, setShoppingList } = useContext(AppContext);
            const [newExp, setNewExp] = useState({ item: "", cost: "", type: "loot", method: "cash", payer: "me", date: new Date().toISOString().split('T')[0], currency: "JPY" });
            const [newShopItem, setNewShopItem] = useState("");
            const [isEditingBudget, setIsEditingBudget] = useState(false); const [tempBudget, setTempBudget] = useState(budget);

            const addExpense = () => {
                if(!newExp.item || !newExp.cost) return;
                const finalCost = newExp.currency === 'TWD' ? Math.round(parseInt(newExp.cost)/exchangeRate) : parseInt(newExp.cost);
                setExpenses([{ id: Date.now(), ...newExp, cost: finalCost }, ...expenses]);
                setNewExp({ ...newExp, item: "", cost: "" });
            };
            const deleteExpense = (id) => { if(confirm("åˆªé™¤?")) setExpenses(expenses.filter(e=>e.id!==id)); };
            const addShopItem = () => { if(newShopItem){ setShoppingList([...shoppingList, {id: Date.now(), text: newShopItem, checked: false}]); setNewShopItem(""); }};
            const deleteShopItem = (id) => { if(confirm("åˆªé™¤?")) setShoppingList(shoppingList.filter(i=>i.id!==id)); };
            const toggleShop = (id) => setShoppingList(shoppingList.map(i=>i.id===id?{...i,checked:!i.checked}:i));
            
            const totalSpent = expenses.reduce((a,c)=>a+c.cost,0);
            const stats = { loot:0, travel:0, save:0, trade:0, other:0 }; expenses.forEach(e => { if(stats[e.type]!==undefined) stats[e.type]+=e.cost; else stats.other+=e.cost; });
            const p = (k) => (stats[k]/totalSpent)*100 || 0;
            const gradient = `#eab308 0% ${p('loot')}%, #3b82f6 ${p('loot')}% ${p('loot')+p('travel')}%, #22c55e ${p('loot')+p('travel')}% ${p('loot')+p('travel')+p('save')}%, #f9a8d4 ${p('loot')+p('travel')+p('save')}% ${p('loot')+p('travel')+p('save')+p('trade')}%, #64748b ${p('loot')+p('travel')+p('save')+p('trade')}% 100%`;

            return (
                <div className="w-full animate-enter pb-32">
                    <div className="bg-slate-800 border-2 border-yellow-600 p-4 mb-4 rounded flex justify-between items-center">
                        <div><div className="text-xs text-yellow-600 font-bold mb-1 flex gap-2">REMAINING {!isEditingBudget&&<button onClick={()=>{setIsEditingBudget(true);setTempBudget(budget)}}><Edit size={12}/></button>}</div>
                        {isEditingBudget?<div className="flex gap-2"><input type="number" value={tempBudget} onChange={e=>setTempBudget(e.target.value)} className="bg-slate-900 w-24 px-1 text-white"/><button onClick={()=>{setBudget(parseInt(tempBudget));setIsEditingBudget(false)}}><Check size={16}/></button></div>:<div className="text-3xl text-yellow-400 font-bold">Â¥{(budget-totalSpent).toLocaleString()}</div>}
                        </div><div className="pie-chart" style={{'--pie-gradient': gradient}}></div>
                    </div>
                    
                    <div className="bg-slate-800 border border-slate-700 p-3 mb-4 rounded">
                        <h3 className="font-bold text-slate-300 mb-2 flex gap-2"><CreditCard size={16}/> æ–°å¢æ”¯å‡º</h3>
                        <div className="flex gap-2 mb-2 overflow-x-auto">{['loot','travel','save','trade','other'].map(t=><button key={t} onClick={()=>setNewExp({...newExp,type:t})} className={`px-2 py-1 text-xs rounded border ${newExp.type===t? (t==='trade'?'bg-pink-300 text-pink-900 border-pink-300':'bg-blue-600 border-blue-500 text-white') : 'border-slate-600 text-slate-400'}`}>{t}</button>)}</div>
                        <div className="flex flex-wrap gap-2 mb-2"><input type="text" placeholder="é …ç›®" value={newExp.item} onChange={e=>setNewExp({...newExp,item:e.target.value})} className="flex-[2] min-w-[120px] bg-slate-900 border-slate-600 p-2 text-xs rounded text-white"/><div className="flex-[1] flex border border-slate-600 rounded min-w-[110px]"><input type="number" placeholder="é‡‘é¡" value={newExp.cost} onChange={e=>setNewExp({...newExp,cost:e.target.value})} className="w-full bg-slate-900 p-2 text-xs text-white outline-none"/><button onClick={()=>setNewExp({...newExp,currency:newExp.currency==='JPY'?'TWD':'JPY'})} className="px-2 bg-slate-700 text-[10px] text-white shrink-0">{newExp.currency}</button></div></div>
                        <div className="flex justify-between items-center flex-wrap gap-2">
                            <div className="flex gap-2">
                                <select value={newExp.payer} onChange={e=>setNewExp({...newExp,payer:e.target.value})} className="bg-slate-700 text-xs rounded px-1 text-white"><option value="me">æˆ‘å…ˆå¢Š</option><option value="partner">æ—…ä¼´å¢Š</option></select>
                                <select value={newExp.method} onChange={e=>setNewExp({...newExp,method:e.target.value})} className="bg-slate-700 text-xs rounded px-1 text-white"><option value="cash">ç¾é‡‘</option><option value="card">åˆ·å¡</option><option value="ic">ICå¡</option></select>
                            </div>
                            <button onClick={addExpense} className="bg-yellow-600 text-black px-4 py-1 rounded text-xs font-bold">ç´€éŒ„</button>
                        </div>
                        {newExp.cost && newExp.currency==='TWD' && <div className="text-[10px] text-right text-slate-500 mt-1">â‰ˆ Â¥{Math.round(newExp.cost/exchangeRate).toLocaleString()}</div>}
                    </div>

                    <div className="bg-slate-800 border border-slate-700 p-3 mb-4 rounded">
                        <h3 className="font-bold text-pink-300 mb-2 flex gap-2"><ShoppingBag size={16}/> å¿…è²·æ¸…å–® (Shopping)</h3>
                        <div className="flex gap-2 mb-2"><input type="text" placeholder="æ–°å¢å•†å“..." value={newShopItem} onChange={e=>setNewShopItem(e.target.value)} className="flex-1 bg-slate-900 border-slate-600 p-2 text-xs rounded text-white"/><button onClick={addShopItem}><PlusCircle size={20} className="text-pink-400"/></button></div>
                        <div className="space-y-1">{shoppingList.map(item=><div key={item.id} className={`flex items-center gap-2 p-2 rounded border border-slate-700 ${item.checked?'opacity-50 line-through bg-slate-900':'bg-slate-800'}`}><div onClick={()=>toggleShop(item.id)} className={`w-4 h-4 border ${item.checked?'bg-pink-500 border-pink-500':'border-slate-500'} rounded-sm flex items-center justify-center cursor-pointer`}>{item.checked&&<Check size={12} className="text-white"/>}</div><span className="flex-1 text-xs">{item.text}</span><button onClick={()=>deleteShopItem(item.id)} className="text-red-400"><Trash2 size={12}/></button></div>)}</div>
                    </div>

                    <div className="space-y-1">{expenses.map(e=><div key={e.id} className="flex justify-between items-center p-2 border-b border-slate-800 bg-slate-800/50"><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${e.type==='trade'?'bg-pink-300':e.type==='loot'?'bg-yellow-500':'bg-blue-500'}`}></div><div className="flex flex-col"><span className="text-xs">{e.item}</span><span className="text-[9px] text-slate-500">{e.payer==='partner'?'(æ—…ä¼´å¢Š)':'(æˆ‘å¢Š)'} Â· {e.method}</span></div></div><div className="flex items-center gap-2"><span className="text-xs font-mono">Â¥{e.cost.toLocaleString()}</span><button onClick={()=>deleteExpense(e.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={12}/></button></div></div>)}</div>
                </div>
            );
        };
        
        // --- Guide View ---
        const GuideView = () => {
            const [expandedGuideId, setExpandedGuideId] = useState(null);
            return (
                <div className="w-full animate-enter pb-20"><div className="space-y-4">{GUIDE_DETAILS.map((place) => (<div key={place.id} className="bg-slate-800 border-2 border-slate-600 rounded-lg overflow-hidden transition-all duration-300"><div className="p-4 cursor-pointer hover:bg-slate-700/50 flex items-center gap-4" onClick={() => setExpandedGuideId(expandedGuideId === place.id ? null : place.id)}><div className="text-4xl">{place.image}</div><div className="flex-1"><h3 className="font-bold text-lg text-yellow-400">{place.title}</h3><p className="text-xs text-slate-400 mb-1">{place.subtitle}</p><div className="flex gap-1 flex-wrap">{place.tags.map(tag => (<span key={tag} className="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-blue-300 border border-slate-600">#{tag}</span>))}</div></div><div className={`transition-transform duration-300 ${expandedGuideId === place.id ? 'rotate-180' : ''}`}><ArrowDown size={16} className="text-slate-500" /></div></div>{expandedGuideId === place.id && (<div className="p-4 pt-0 border-t border-slate-700 bg-slate-900/50 animate-in slide-in-from-top-2"><div className="text-sm text-slate-300 mb-4 leading-relaxed mt-4">{place.desc}</div><div className="space-y-3 text-xs"><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-blue-400 mb-1 flex items-center gap-2"><Clock size={12}/> æ­·å²å°çŸ¥è­˜</h4><p className="text-slate-400">{place.content.history}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-yellow-400 mb-1 flex items-center gap-2"><Star size={12} /> ç‰¹è‰²èˆ‡å¿…çœ‹</h4><p className="text-slate-400">{place.content.features}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-green-400 mb-1 flex items-center gap-2"><MapPin size={12}/> æ”»ç•¥ Tips</h4><p className="text-slate-400">{place.content.tips}</p></div><div className="bg-red-900/20 p-3 rounded border border-red-900/50"><h4 className="font-bold text-red-400 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> æ³¨æ„äº‹é …</h4><p className="text-red-200/80">{place.content.warning}</p></div></div></div>)}</div>))}</div></div>
            );
        };

        // --- Grimoire View ---
        const GrimoireView = () => {
            const { speakJapanese } = useContext(AppContext);
            const [transInput, setTransInput] = useState("");
            const [transResult, setTransResult] = useState("");
            const [isTranslating, setIsTranslating] = useState(false);
            const [selectedSpell, setSelectedSpell] = useState(null);
            
            const handleTranslate = async () => {
                if (!transInput) return;
                setIsTranslating(true);
                setTransResult("");
                try {
                    const apiKey = ""; 
                    if (!apiKey) { setTransResult("éŒ¯èª¤ï¼šè«‹è¨­å®š API Key"); setIsTranslating(false); return; }
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Translate Traditional Chinese to Japanese (Polite/Travel). Output ONLY Japanese. Input: "${transInput}"` }] }] }) });
                    const data = await response.json();
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (resultText) setTransResult(resultText.trim()); else setTransResult("è© å”±å¤±æ•—...");
                } catch (error) { setTransResult("é­”åŠ›ä¸è¶³"); } finally { setIsTranslating(false); }
            };

            return (
                <div className="w-full animate-enter pb-20">
                     <div className="bg-slate-800 border-2 border-blue-500 p-4 rounded-sm mb-6 relative overflow-hidden shadow-[0_0_15px_rgba(59,130,246,0.2)]"><div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">LIVE TRANSLATE</div><div className="flex items-center gap-2 mb-3"><Globe className="text-blue-400" size={20} /><h3 className="font-bold text-blue-300">é€šç”¨èªç¿»è­¯è¡“</h3></div><div className="flex gap-2"><input type="text" placeholder="è¼¸å…¥ä¸­æ–‡å’’èª..." value={transInput} onChange={(e) => setTransInput(e.target.value)} className="flex-1 min-w-0 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400 placeholder:text-slate-600"/><button onClick={handleTranslate} disabled={isTranslating} className="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:text-gray-400 text-white px-4 rounded font-bold text-xs transition flex items-center gap-1 whitespace-nowrap shrink-0">{isTranslating ? <Loader2 className="animate-spin" size={14} /> : "è© å”±"}</button></div>{transResult && (<div className="mt-3 p-3 bg-slate-900 border border-blue-500/50 rounded animate-enter flex justify-between items-start"><div><div className="text-[10px] text-blue-400 mb-1 font-bold font-mono">RESULT</div><div className="text-lg text-white font-bold leading-relaxed">{transResult}</div></div><button onClick={() => speakJapanese(transResult)} className="text-blue-400 hover:text-white p-2"><Volume2 size={20} /></button></div>)}</div>
                     <div className="grid grid-cols-2 gap-3">{SPELL_DATA.map((spell, idx) => (<div key={idx} onClick={() => setSelectedSpell(spell)} className="bg-slate-800 border border-slate-600 p-3 rounded hover:border-purple-500 transition group cursor-pointer relative overflow-hidden flex flex-col items-center text-center shadow-md active:scale-[0.98]"><div className="text-3xl mb-2 group-hover:scale-110 transition-transform">{spell.icon}</div><div className="font-bold text-purple-300 text-sm mb-1">{spell.title}</div><div className="text-[10px] text-slate-500">{spell.zh}</div><div className="absolute top-2 right-2 text-slate-500 hover:text-white" onClick={(e) => { e.stopPropagation(); speakJapanese(spell.jp); }}><Volume2 size={16} /></div></div>))}</div>
                     {selectedSpell && (<div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-enter" onClick={() => setSelectedSpell(null)}><div className="bg-slate-900 border-4 border-purple-500 p-6 rounded-lg max-w-sm w-full relative shadow-[0_0_50px_rgba(168,85,247,0.5)] flex flex-col items-center" onClick={e => e.stopPropagation()}><button onClick={() => setSelectedSpell(null)} className="absolute top-2 right-2 text-slate-400 hover:text-white p-2"><X size={24} /></button><div className="text-8xl mb-6 animate-bounce">{selectedSpell.icon}</div><div className="text-2xl font-bold text-purple-300 mb-6 border-b-2 border-purple-800 pb-2 w-full text-center">{selectedSpell.title}</div><div className="bg-white text-black p-6 rounded-lg mb-4 shadow-inner w-full flex justify-between items-center"><div className="text-2xl font-black leading-snug text-center flex-1">{selectedSpell.jp}</div><button onClick={() => speakJapanese(selectedSpell.jp)} className="ml-2 text-purple-600 p-2 bg-purple-100 rounded-full hover:bg-purple-200"><Volume2 size={24} /></button></div><div className="text-lg text-slate-400">{selectedSpell.zh}</div><div className="mt-8 text-[10px] text-purple-500 font-mono tracking-[0.2em] animate-pulse">SPELL CARD ACTIVE</div></div></div>)}
                </div>
            );
        };

        // --- App Provider ---
        const AppProvider = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('quest');
            const [activeLevel, setActiveLevel] = useState(0);
            const [tripId, setTripId] = useState(localStorage.getItem('tripId') || ''); 
            const [exchangeRate, setExchangeRate] = useState(0.22);
            const [countdown, setCountdown] = useState("");
            const [weatherForecast, setWeatherForecast] = useState({});
            const [weatherTemp, setWeatherTemp] = useState(15); 

            useEffect(() => {
                const initAuth = async () => { if (USE_REAL_GOOGLE_AUTH) await signInWithPopup(getAuth(app), new GoogleAuthProvider()).catch(console.error); else await signInAnonymously(getAuth(app)); };
                onAuthStateChanged(getAuth(app), u => { 
                    setUser(u); setAuthLoading(false); 
                    if(u && !tripId) { const tid = u.uid.substring(0,6); setTripId(tid); localStorage.setItem('tripId', tid); }
                });
            }, []);

            // 7-Day Weather Fetch
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo').then(r=>r.json()).then(data=>{
                    const map = {}; data.daily.time.forEach((t, i) => { map[i] = { max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weathercode[i] }; });
                    setWeatherForecast(map);
                }).catch(console.error);
                fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r=>r.json()).then(d=>setExchangeRate(d.rates.TWD)).catch(console.error);
                // Real-time for InfoView
                fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&current_weather=true').then(r=>r.json()).then(d=>{ if(d?.current_weather?.temperature) setWeatherTemp(d.current_weather.temperature); }).catch(console.log);

                const targetDate = new Date('2026-03-02T16:45:00').getTime();
                const interval = setInterval(() => {
                    const now = new Date();
                    const d = targetDate - now.getTime();
                    if(d<0) setCountdown("é€²è¡Œä¸­"); else setCountdown(`${Math.floor(d/(1000*60*60*24))}å¤©${Math.floor((d%(1000*60*60*24))/(1000*60*60))}æ™‚`);
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // Firestore Data (using tripId)
            const [checklist, setChecklist] = useFirestoreData(tripId, 'checklist', INITIAL_CHECKLIST);
            const [expenses, setExpenses] = useFirestoreData(tripId, 'expenses', INITIAL_EXPENSES);
            const [quests, setQuests] = useFirestoreData(tripId, 'quests', INITIAL_QUEST_DATA);
            const [shoppingList, setShoppingList] = useFirestoreData(tripId, 'shopping', []);
            const [tickets, setTickets] = useFirestoreData(tripId, 'tickets', []);
            const [settingsData, updateSettings] = useFirestoreData(tripId, 'settings', { budget: 100000 }, true);
            
            const budget = settingsData?.budget || 100000;
            const setBudget = (val) => updateSettings({ ...settingsData, budget: val });

            const value = useMemo(() => ({
                user, tripId, setTripId, checklist, setChecklist, expenses, setExpenses, quests, setQuests, budget, setBudget,
                shoppingList, setShoppingList, tickets, setTickets, activeTab, setActiveTab, activeLevel, setActiveLevel, 
                countdown, exchangeRate, weatherForecast, weatherTemp, 
                speakJapanese: (t)=>{const u=new SpeechSynthesisUtterance(t);u.lang='ja-JP';u.rate=0.65;window.speechSynthesis.speak(u);}
            }), [user, tripId, checklist, expenses, quests, shoppingList, tickets, budget, activeTab, activeLevel, countdown, exchangeRate, weatherForecast, weatherTemp]);

            if (authLoading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white"><Loader2 className="animate-spin text-yellow-500" size={40}/></div>;
            if (!user) return <LoginView onLogin={() => signInWithPopup(getAuth(app), new GoogleAuthProvider())} />;

            return <AppContext.Provider value={value}><MainLayout /></AppContext.Provider>;
        };

        const MainLayout = () => {
            const { activeTab, setActiveTab } = useContext(AppContext);
            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto shadow-2xl border-x border-slate-800 bg-slate-900 relative">
                    <div className="w-full mb-6 border-b border-slate-800 pb-4 text-center sticky top-0 bg-slate-900/95 backdrop-blur z-20 pt-4 px-4 shadow-lg"><h1 className="text-xl font-bold tracking-widest text-yellow-400 mb-2 flex justify-center gap-2"><MapPin/> åå¤å±‹å†’éšªæ—¥èªŒ</h1></div>
                    <div className="px-4">
                        {activeTab === 'quest' && <QuestView />}
                        {activeTab === 'inventory' && <InventoryView />}
                        {activeTab === 'grimoire' && <GrimoireView />}
                        {activeTab === 'guide' && <GuideView />}
                        {activeTab === 'info' && <InfoView />}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900 border-t border-slate-700 p-2 z-30 pb-safe grid grid-cols-5 gap-1">
                        <button onClick={()=>setActiveTab('quest')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='quest'?'text-yellow-400':'text-slate-500'}`}><Scroll size={20}/><span className="text-[10px]">ä»»å‹™</span></button>
                        <button onClick={()=>setActiveTab('inventory')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='inventory'?'text-yellow-400':'text-slate-500'}`}><Coins size={20}/><span className="text-[10px]">è¡Œå›Š</span></button>
                        <button onClick={()=>setActiveTab('grimoire')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='grimoire'?'text-yellow-400':'text-slate-500'}`}><BookOpen size={20}/><span className="text-[10px]">é­”å°æ›¸</span></button>
                        <button onClick={()=>setActiveTab('guide')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='guide'?'text-yellow-400':'text-slate-500'}`}><Compass size={20}/><span className="text-[10px]">å°è¦½</span></button>
                        <button onClick={()=>setActiveTab('info')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab==='info'?'text-yellow-400':'text-slate-500'}`}><Info size={20}/><span className="text-[10px]">è³‡è¨Š</span></button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AppProvider />);

    </script>
</body>
</html>