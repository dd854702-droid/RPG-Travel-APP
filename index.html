import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, 
  Coins, BookOpen, Scroll, Settings, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
  Edit, Trash2, Globe, Shirt, RefreshCw, Loader2
} from 'lucide-react';

// --- Static Data ---

const SPELL_DATA = [
  { icon: "ğŸ§…", title: "é©…é™¤è”¥èŠ±", jp: "ãƒã‚®æŠœãã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹ä¸è¦åŠ è”¥", type: "defense" },
  { icon: "ğŸ§Š", title: "å»å†°å’’", jp: "æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹å»å†°", type: "support" },
  { icon: "ğŸ’§", title: "å¬å–šæ°´", jp: "ãŠæ°´ãã ã•ã„", zh: "è«‹çµ¦æˆ‘æ°´", type: "support" },
  { icon: "ğŸš»", title: "å°‹æ‰¾å¯†å®¤", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", zh: "å»æ‰€åœ¨å“ªè£¡", type: "exploration" },
  { icon: "ğŸ§¾", title: "çµç®—å·è»¸", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹çµå¸³", type: "interaction" },
  { icon: "ğŸ“¸", title: "æ”é­‚è¡“", jp: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ", zh: "å¯ä»¥æ‹ç…§å—ï¼Ÿ", type: "interaction" },
];

const INITIAL_CHECKLIST = [
  { id: 1, text: "è­·ç…§ (é€šè¡Œè­‰)", checked: false },
  { id: 2, text: "ç¶²å¡ (é€šè¨Šæ°´æ™¶)", checked: false },
  { id: 3, text: "æ—¥å¹£ (é‡‘å¹£)", checked: false },
  { id: 4, text: "è¡Œå‹•é›»æº (é­”åŠ›æº)", checked: false },
  { id: 5, text: "å¸¸ç”¨è—¥å“ (å›å¾©è—¥)", checked: false },
];

const QUEST_DATA = [
  {
    day: 0,
    title: "åºç« : é™è½èˆ‡æ½›å…¥",
    date: "2026-03-02",
    stats: { xp: "500 XP", gold: 0, fatigue: "30%" }, // gold is now dynamic
    events: [
      { time: "20:25", icon: <Plane className="w-5 h-5" />, title: "æŠµé”æ–°åœ°åœ–", desc: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ (NGO) T2 é™è½", type: "checkpoint" },
      { time: "21:15", icon: <Footprints className="w-5 h-5" />, title: "ç©¿è¶Šé€šé“", desc: "æ­¥è¡Œè‡³äº¤é€šå»£å ´ (T1æ–¹å‘)", type: "move" },
      { time: "21:37", icon: <Train className="w-5 h-5" />, title: "æ­ä¹˜åéµç‰¹æ€¥", desc: "å¾€åå¤å±‹/å²é˜œæ–¹å‘ (Î¼-SKYéœ€èª²é‡‘)", type: "travel" },
      { time: "22:08", icon: <MapPin className="w-5 h-5" />, title: "æŠµé”é‡‘å±±ç«™", desc: "é—œéµè½‰ä¹˜é» (å‹¿éç«™)", type: "checkpoint" },
      { time: "22:23", icon: <Train className="w-5 h-5" />, title: "è½‰ä¹˜åœ°ä¸‹éµ", desc: "ååŸç·š (å³ç’°) å¾€æ¦®æ–¹å‘", type: "travel" },
      { time: "22:40", icon: <Home className="w-5 h-5" />, title: "å­˜æª”é»: Hostel", desc: "è¾¦ç†å…¥ä½ï¼Œä¼‘æ¯å›è¡€", type: "save" },
    ]
  },
  {
    day: 1,
    title: "ç¬¬ä¸€ç« : å¸‚å ´èˆ‡ç¥æ®¿",
    date: "2026-03-03",
    stats: { xp: "1200 XP", gold: 0, fatigue: "60%" },
    events: [
      { time: "08:00", icon: <Home className="w-5 h-5" />, title: "å†’éšªé–‹å§‹", desc: "Hostel é›†åˆå‡ºç™¼", type: "start" },
      { time: "08:45", icon: <Utensils className="w-5 h-5" />, title: "æŸ³æ©‹ä¸­å¤®å¸‚å ´", desc: "è£œçµ¦: ç”Ÿé­šç‰‡ã€æµ·é®®å·¡ç¦®", type: "loot" },
      { time: "12:00", icon: <Utensils className="w-5 h-5" />, title: "åˆé¤: é³¥é–‹ç·æœ¬å®¶", desc: "ç²å¾—ç‰©å“: é‡‘è³è¦ªå­ä¸¼", type: "loot" },
      { time: "13:30", icon: <ShoppingBag className="w-5 h-5" />, title: "å¤§é ˆå•†åº—è¡—", desc: "äº¤æ˜“èˆ‡æ¢ç´¢ (ç´„2å°æ™‚)", type: "action" },
      { time: "15:30", icon: <Coffee className="w-5 h-5" />, title: "ä¸‹åˆèŒ¶: Konparu", desc: "è£œçµ¦: ç‚¸è¦ä¸‰æ˜æ²»", type: "heal" },
      { time: "18:30", icon: <Utensils className="w-5 h-5" />, title: "æ™šé¤: ç†±ç”°è“¬èŠè»’", desc: "æŒ‘æˆ°å‚³èªªç¾é£Ÿ: é°»é­šé£¯ä¸‰åƒ", type: "boss" },
    ]
  },
  {
    day: 2,
    title: "ç¬¬äºŒç« : å¤åŸèˆ‡å’–å•¡",
    date: "2026-03-04",
    stats: { xp: "1500 XP", gold: 0, fatigue: "75%" },
    events: [
      { time: "08:00", icon: <Coffee className="w-5 h-5" />, title: "æ—©é¤: Bucyo Coffee", desc: "è£œçµ¦: å°å€‰ç´…è±†åå¸", type: "heal" },
      { time: "10:00", icon: <MapPin className="w-5 h-5" />, title: "çŠ¬å±±åŸæ”»ç•¥", desc: "åœ‹å¯¶å¤©å®ˆé–£ (é–€ç¥¨ Â¥550)", type: "dungeon" },
      { time: "12:30", icon: <Utensils className="w-5 h-5" />, title: "åˆé¤: Sakura Chaya", desc: "ç²å¾—ç‰©å“: ç”°æ¨‚çƒ¤è±†è…ä¸²", type: "loot" },
      { time: "15:00", icon: <Coffee className="w-5 h-5" />, title: "GOLPIE COFFEE", desc: "å·åå±±å† è»å’–å•¡å·¡ç¦®", type: "action" },
      { time: "18:00", icon: <Utensils className="w-5 h-5" />, title: "Solo Pizza", desc: "å¤§é ˆæœ¬åº— (ä¸–ç•Œå† è»æŠ«è–©)", type: "loot" },
    ]
  },
  {
    day: 3,
    title: "ç¬¬ä¸‰ç« : å°‡è»çš„æ¦®è€€",
    date: "2026-03-05",
    stats: { xp: "1800 XP", gold: 0, fatigue: "85%" },
    events: [
      { time: "08:00", icon: <Coffee className="w-5 h-5" />, title: "æ—©é¤: Karasu", desc: "å­¤ç¨çš„ç¾é£Ÿå®¶å’–å•¡å»³", type: "heal" },
      { time: "09:30", icon: <MapPin className="w-5 h-5" />, title: "åå¤å±‹åŸ", desc: "é‡‘é¯±èˆ‡æœ¬ä¸¸å¾¡æ®¿ (é–€ç¥¨ Â¥500)", type: "dungeon" },
      { time: "11:30", icon: <Camera className="w-5 h-5" />, title: "å¾·å·åœ’", desc: "æ—¥å¼åº­åœ’æ•£æ­¥ (é–€ç¥¨ Â¥300)", type: "action" },
      { time: "13:00", icon: <Utensils className="w-5 h-5" />, title: "åˆé¤: Yellow", desc: "å‰‡æ­¦æ–°ç”º æ¿ƒåšæ­å§†è›‹åŒ…é£¯", type: "loot" },
      { time: "15:00", icon: <ShoppingBag className="w-5 h-5" />, title: "æ¦® (Sakae)", desc: "LACHIC, ä¸­æ—¥å¤§æ¨“ è³¼ç‰©", type: "trade" },
      { time: "18:00", icon: <Utensils className="w-5 h-5" />, title: "æ™šé¤: æµ·è€ã©ã¦", desc: "æŒ‘æˆ°: 35cm ç‰¹å¤§ç‚¸è¦", type: "boss" },
    ]
  },
  {
    day: 4,
    title: "çµ‚ç« : æ­¸é€”",
    date: "2026-03-06",
    stats: { xp: "2000 XP", gold: 0, fatigue: "99%" },
    events: [
      { time: "09:40", icon: <Home className="w-5 h-5" />, title: "æ—…åº—é€€æˆ¿", desc: "å¾ Hostel å‡ºç™¼å‰å¾€ä¸Šå‰æ´¥ç«™", type: "start" },
      { time: "09:50", icon: <Train className="w-5 h-5" />, title: "åœ°ä¸‹éµç§»å‹•", desc: "ä¸Šå‰æ´¥ (M03) -> é‡‘å±± (M01)", type: "travel" },
      { time: "10:18", icon: <Train className="w-5 h-5" />, title: "åéµç‰¹æ€¥ Î¼-SKY", desc: "é‡‘å±±ç«™ -> ä¸­éƒ¨åœ‹éš›æ©Ÿå ´", type: "travel" },
      { time: "10:50", icon: <MapPin className="w-5 h-5" />, title: "æŠµé”æ©Ÿå ´ T1", desc: "å‰å¾€äº¤é€šå»£å ´", type: "checkpoint" },
      { time: "11:05", icon: <Footprints className="w-5 h-5" />, title: "æ­¥è¡Œè‡³ T2", desc: "é•·è·é›¢ç§»å‹• (10-15åˆ†)", type: "move" },
      { time: "11:05", icon: <Plane className="w-5 h-5" />, title: "å ±åˆ° & è¨—é‹", desc: "è™èˆªæ«ƒæª¯ (12:30 é—œæ«ƒ)", type: "action" },
      { time: "13:15", icon: <Plane className="w-5 h-5" />, title: "Mission Complete", desc: "é£›é›¢æ—¥æœ¬", type: "end" },
    ]
  }
];

// --- Main Component ---

const App = () => {
  const [activeTab, setActiveTab] = useState('quest'); 
  const [activeLevel, setActiveLevel] = useState(0); 
  const EXCHANGE_RATE = 0.22; // TWD = JPY * 0.22
  
  // --- Inventory State ---
  const [budget, setBudget] = useState(100000); 
  const [expenses, setExpenses] = useState([
    { id: 1, item: "æ©Ÿç¥¨é ä»˜", cost: 12000, type: "travel", date: "2025-10-15" },
    { id: 2, item: "ä½å®¿é è¨‚", cost: 8000, type: "save", date: "2025-11-20" }
  ]);
  
  // Inventory Editing State
  const [editingId, setEditingId] = useState(null);
  const [newExpenseName, setNewExpenseName] = useState("");
  const [newExpenseCost, setNewExpenseCost] = useState("");
  const [newExpenseDate, setNewExpenseDate] = useState(new Date().toISOString().split('T')[0]);

  // --- Translation State ---
  const [transInput, setTransInput] = useState("");
  const [transResult, setTransResult] = useState("");
  const [isTranslating, setIsTranslating] = useState(false);

  // --- Checklist State ---
  const [checklist, setChecklist] = useState(INITIAL_CHECKLIST);

  // --- Grimoire Zoom State ---
  const [selectedSpell, setSelectedSpell] = useState(null);

  // --- Countdown Logic ---
  const [countdown, setCountdown] = useState("");
  
  // --- System/Weather State ---
  const [weatherTemp, setWeatherTemp] = useState(12);

  useEffect(() => {
    const targetDate = new Date('2026-03-02T16:45:00').getTime();
    const interval = setInterval(() => {
      const now = new Date().getTime();
      const distance = targetDate - now;
      if (distance < 0) {
        setCountdown("ä»»å‹™é–‹å§‹");
      } else {
        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        setCountdown(`å‚³é€å€’æ•¸: ${d}å¤© ${h}æ™‚`);
      }
    }, 1000);
    return () => clearInterval(interval);
  }, []);

  // --- Helper Functions ---

  // 3. Dynamic Quest Gold Logic
  const getCurrentDayGold = useMemo(() => {
    const targetDate = QUEST_DATA[activeLevel].date;
    const dailyExpenses = expenses.filter(e => e.date === targetDate);
    const total = dailyExpenses.reduce((acc, curr) => acc + curr.cost, 0);
    return total;
  }, [expenses, activeLevel]);

  // Outfit Logic (5. ç©¿æ­å»ºè­°)
  const getOutfitAdvice = (temp) => {
    if (temp <= 5) return "æ¥µå¯’ï¼šç™¼ç†±è¡£ + ç¾½çµ¨è¡£ + åœå·¾æ‰‹å¥—";
    if (temp <= 12) return "å¯’å†·ï¼šå¤§è¡£ + æ¯›è¡£ + åœå·¾ (å»ºè­°æ´‹è”¥å¼)";
    if (temp <= 20) return "æ¶¼çˆ½ï¼šè–„å¤–å¥— + é•·è¢–Tæ¤";
    return "æº«æš–ï¼šçŸ­è¢– + è–„è¥¯è¡«";
  };

  const handleEdit = (expense) => {
    setEditingId(expense.id);
    setNewExpenseName(expense.item);
    setNewExpenseCost(expense.cost);
    setNewExpenseDate(expense.date || new Date().toISOString().split('T')[0]);
  };

  const handleCancelEdit = () => {
    setEditingId(null);
    setNewExpenseName("");
    setNewExpenseCost("");
    setNewExpenseDate(new Date().toISOString().split('T')[0]);
  };

  const handleDelete = (id) => {
    if(window.confirm("ç¢ºå®šè¦éŠ·æ¯€é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
      setExpenses(expenses.filter(e => e.id !== id));
    }
  };

  const addOrUpdateExpense = () => {
    if (!newExpenseName || !newExpenseCost || !newExpenseDate) return;

    if (editingId) {
      // Update existing
      setExpenses(expenses.map(e => 
        e.id === editingId 
          ? { ...e, item: newExpenseName, cost: parseInt(newExpenseCost), date: newExpenseDate } 
          : e
      ));
      handleCancelEdit();
    } else {
      // Add new
      setExpenses([
        { id: Date.now(), item: newExpenseName, cost: parseInt(newExpenseCost), type: "loot", date: newExpenseDate }, 
        ...expenses
      ]);
      setNewExpenseName("");
      setNewExpenseCost("");
    }
  };

  // --- NEW: In-app Translation Logic ---
  const handleTranslate = async () => {
    if (!transInput) return;
    setIsTranslating(true);
    setTransResult(""); // Clear previous result
    
    try {
      const apiKey = ""; // Runtime Environment will provide this key
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ 
              parts: [{ 
                text: `Translate the following Traditional Chinese text to Japanese. The output should be natural, polite, and suitable for a tourist in Japan. Only output the Japanese text. Text: "${transInput}"` 
              }] 
            }]
          })
        }
      );

      const data = await response.json();
      const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (resultText) {
        setTransResult(resultText.trim());
      } else {
        setTransResult("è© å”±å¤±æ•—... (è«‹æª¢æŸ¥ç¶²è·¯)");
      }
    } catch (error) {
      console.error("Translation error:", error);
      setTransResult("é­”åŠ›ä¸è¶³ (API Error)");
    } finally {
      setIsTranslating(false);
    }
  };

  const toggleCheck = (id) => {
    setChecklist(checklist.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
  };

  // Stats for Inventory (2. åŒ¯ç‡ç¸½å’Œ)
  const totalSpentJPY = useMemo(() => expenses.reduce((acc, curr) => acc + curr.cost, 0), [expenses]);
  const totalSpentTWD = Math.round(totalSpentJPY * EXCHANGE_RATE);
  const remainingGold = budget - totalSpentJPY;

  const getEventStyle = (type) => {
    switch (type) {
      case 'boss': return "border-red-500 bg-red-900/20 text-red-200";
      case 'loot': return "border-yellow-500 bg-yellow-900/20 text-yellow-200";
      case 'dungeon': return "border-purple-500 bg-purple-900/20 text-purple-200";
      case 'save': return "border-green-500 bg-green-900/20 text-green-200";
      case 'travel': return "border-blue-500 bg-blue-900/20 text-blue-200";
      default: return "border-slate-600 bg-slate-800/50 text-slate-300";
    }
  };

  // --- Sub-Views ---

  const QuestView = () => (
    <>
      <div className="flex w-full overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar">
        {QUEST_DATA.map((quest, index) => (
          <button
            key={index}
            onClick={() => setActiveLevel(index)}
            className={`flex-shrink-0 px-4 py-2 border-2 text-xs font-bold transition-all duration-200 ${
              activeLevel === index
                ? "bg-blue-600 border-blue-400 text-white translate-y-1 shadow-[0_0_10px_rgba(37,99,235,0.5)]"
                : "bg-slate-800 border-slate-600 text-slate-400 hover:bg-slate-700"
            }`}
          >
            {index === 0 ? "åºç« " : index === 4 ? "çµ‚ç« " : `ç¬¬ ${index} ç« `}
          </button>
        ))}
      </div>

      <div className="w-full bg-slate-800 border-2 border-slate-600 p-4 mb-6 rounded-sm relative overflow-hidden animate-in fade-in duration-300">
        <div className="absolute top-0 right-0 p-1 bg-yellow-600 text-[10px] text-black font-bold">ç•¶å‰ä»»å‹™</div>
        <h2 className="text-lg font-bold text-green-400 mb-1">{QUEST_DATA[activeLevel].title}</h2>
        <div className="text-sm text-slate-400 mb-4 flex justify-between">
          <span>å†’éšªä¹‹æ—¥: {QUEST_DATA[activeLevel].date}</span>
          <span className="text-blue-400 font-mono text-xs">{countdown}</span>
        </div>
        
        <div className="grid grid-cols-3 gap-2 text-xs border-t border-slate-700 pt-3 mb-2">
          <div className="text-center">
            <div className="text-slate-500 mb-1">ç²å¾—ç¶“é©—</div>
            <div className="text-purple-400">{QUEST_DATA[activeLevel].stats.xp}</div>
          </div>
          <div className="text-center border-l border-slate-700">
            {/* 3. Dynamic Gold Display */}
            <div className="text-slate-500 mb-1">æœ¬ç« æ”¯å‡º</div>
            <div className="text-yellow-400 font-mono">
              {getCurrentDayGold > 0 ? `-Â¥${getCurrentDayGold.toLocaleString()}` : "Â¥0"}
            </div>
          </div>
          <div className="text-center border-l border-slate-700">
            <div className="text-slate-500 mb-1">ç–²å‹åº¦</div>
            <div className="text-red-400">{QUEST_DATA[activeLevel].stats.fatigue}</div>
          </div>
        </div>
      </div>

      <div className="w-full flex-1 relative pl-4 pb-20">
        <div className="absolute left-[27px] top-4 bottom-4 w-1 bg-slate-700 z-0"></div>
        {QUEST_DATA[activeLevel].events.map((event, idx) => (
          <div key={idx} className="relative z-10 mb-6 group animate-in slide-in-from-bottom-2 duration-500" style={{animationDelay: `${idx * 50}ms`}}>
            <div className="flex items-start">
              <div className={`w-12 h-12 flex-shrink-0 rounded-lg border-2 flex items-center justify-center bg-slate-900 shadow-lg ${
                event.type === 'boss' ? 'border-red-500 text-red-500' : 
                event.type === 'travel' ? 'border-blue-500 text-blue-500' :
                'border-slate-500 text-slate-400'
              }`}>
                {event.icon}
              </div>
              <div className={`ml-4 flex-1 border-2 p-3 rounded-lg relative ${getEventStyle(event.type)}`}>
                <div className={`absolute top-4 -left-2 w-3 h-3 border-l-2 border-b-2 bg-inherit transform rotate-45 ${
                   event.type === 'boss' ? 'border-red-500 bg-slate-900' : 'border-inherit bg-slate-900'
                }`}></div>
                <div className="flex justify-between items-start mb-1">
                  <span className="font-bold text-sm tracking-wide">{event.title}</span>
                  <span className="text-xs font-mono bg-black/30 px-1 rounded">{event.time}</span>
                </div>
                <p className="text-xs opacity-80 leading-relaxed">{event.desc}</p>
              </div>
            </div>
            {idx !== QUEST_DATA[activeLevel].events.length - 1 && (
              <div className="absolute left-[22px] -bottom-4 text-slate-600"><ArrowDown size={12} /></div>
            )}
          </div>
        ))}
        <div className="flex items-center mt-8 mb-8 opacity-50">
          <div className="w-3 h-3 bg-slate-600 rounded-full mx-auto relative right-2"></div>
          <div className="text-xs text-slate-500 ml-4 font-mono">// æ—¥èªŒçµ‚æ­¢</div>
        </div>
      </div>
    </>
  );

  const InventoryView = () => (
    <div className="w-full animate-in fade-in duration-300 pb-20 relative min-h-[500px]">
      <div className="bg-slate-800 border-2 border-yellow-600 p-4 mb-6 rounded-sm text-center">
        <div className="text-xs text-yellow-600 font-bold mb-1">æŒæœ‰é‡‘å¹£ (å‰©é¤˜é ç®—)</div>
        <div className="text-3xl text-yellow-400 font-mono font-bold">Â¥{remainingGold.toLocaleString()}</div>
        <div className="w-full bg-slate-900 h-2 mt-2 rounded-full overflow-hidden">
          <div 
            className="bg-yellow-600 h-full transition-all duration-500" 
            style={{width: `${Math.min((remainingGold/budget)*100, 100)}%`}}
          ></div>
        </div>
      </div>

      <div className={`bg-slate-800 border-2 ${editingId ? 'border-green-500' : 'border-slate-700'} p-3 mb-6 rounded-sm transition-colors duration-300`}>
        <div className="flex justify-between items-center mb-2">
            <h3 className={`text-xs font-bold ${editingId ? 'text-green-400' : 'text-slate-400'} uppercase`}>
                {editingId ? "ä¿®æ”¹äº¤æ˜“ç´€éŒ„" : "æ–°å¢äº¤æ˜“ç´€éŒ„"}
            </h3>
            {editingId && (
                <button onClick={handleCancelEdit} className="text-[10px] text-red-400 hover:underline">
                    å–æ¶ˆä¿®æ”¹
                </button>
            )}
        </div>
        
        <div className="flex items-center gap-2 mb-2 bg-slate-900 border border-slate-600 rounded p-2">
            <Calendar className="w-4 h-4 text-slate-400" />
            <input 
                type="date" 
                value={newExpenseDate} 
                onChange={(e) => setNewExpenseDate(e.target.value)}
                className="bg-transparent text-xs text-white outline-none w-full font-mono uppercase"
            />
        </div>

        <div className="flex gap-2 mb-2">
          <input 
            type="text" placeholder="é“å…·åç¨±" 
            value={newExpenseName} onChange={(e) => setNewExpenseName(e.target.value)}
            className="flex-1 bg-slate-900 border border-slate-600 p-2 text-xs text-white rounded focus:border-yellow-500 outline-none"
          />
          <input 
            type="number" placeholder="èŠ±è²»" 
            value={newExpenseCost} onChange={(e) => setNewExpenseCost(e.target.value)}
            className="w-20 bg-slate-900 border border-slate-600 p-2 text-xs text-white rounded focus:border-yellow-500 outline-none"
          />
        </div>
        
        <button 
            onClick={addOrUpdateExpense} 
            className={`w-full ${editingId ? 'bg-green-900/50 border-green-600 text-green-500 hover:bg-green-900' : 'bg-yellow-900/50 border-yellow-600 text-yellow-500 hover:bg-yellow-900'} border py-2 text-xs font-bold transition flex items-center justify-center gap-2`}
        >
          {editingId ? <RefreshCw size={14} /> : <PlusCircle size={14} />} 
          {editingId ? "æ›´æ–°ç´€éŒ„" : "ç¢ºèªäº¤æ˜“"}
        </button>
      </div>

      <div className="space-y-2 mb-32">
        {expenses.map((exp) => (
          <div key={exp.id} className={`flex flex-col p-3 bg-slate-800/50 border-b ${editingId === exp.id ? 'border-green-500 bg-green-900/10' : 'border-slate-700'}`}>
            <div className="flex justify-between items-center mb-1">
                <span className="text-sm font-bold">{exp.item}</span>
                <div className="flex items-center gap-2">
                    <span className={`text-sm font-mono ${exp.cost > 0 ? 'text-red-300' : 'text-green-300'}`}>
                        {exp.cost > 0 ? '-' : '+'}Â¥{Math.abs(exp.cost).toLocaleString()}
                    </span>
                    <button onClick={() => handleEdit(exp)} className="text-slate-500 hover:text-green-400"><Edit size={12} /></button>
                    <button onClick={() => handleDelete(exp.id)} className="text-slate-500 hover:text-red-400"><Trash2 size={12} /></button>
                </div>
            </div>
            <div className="text-[10px] text-slate-500 flex items-center gap-1">
                <Calendar size={10} /> {exp.date}
            </div>
          </div>
        ))}
      </div>

      {/* 2. Total Exchange Rate Footer */}
      <div className="absolute bottom-20 left-0 right-0 bg-slate-900 border-t-2 border-slate-700 p-4 shadow-lg z-10">
        <div className="flex justify-between items-center text-xs text-slate-400 mb-1">
            <span>TOTAL SPENT</span>
            <span>EXCHANGE RATE: {EXCHANGE_RATE}</span>
        </div>
        <div className="flex justify-between items-end">
            <div className="text-2xl font-mono text-red-400 font-bold">Â¥{totalSpentJPY.toLocaleString()}</div>
            <div className="text-lg font-mono text-slate-300">â‰ˆ NT${totalSpentTWD.toLocaleString()}</div>
        </div>
      </div>
    </div>
  );

  const GrimoireView = () => (
    <div className="w-full animate-in fade-in duration-300 pb-20">
      
      {/* 4. Real-time Translation Input */}
      <div className="bg-slate-800 border-2 border-blue-500 p-4 rounded-sm mb-6 relative overflow-hidden">
        <div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold">LIVE TRANSLATE</div>
        <div className="flex items-center gap-2 mb-3">
            <Globe className="text-blue-400" size={20} />
            <h3 className="font-bold text-blue-300">é€šç”¨èªç¿»è­¯è¡“</h3>
        </div>
        <div className="flex gap-2">
            <input 
                type="text" 
                placeholder="è¼¸å…¥ä¸­æ–‡å’’èª..." 
                value={transInput}
                onChange={(e) => setTransInput(e.target.value)}
                className="flex-1 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400"
            />
            <button 
              onClick={handleTranslate} 
              disabled={isTranslating}
              className="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:text-gray-400 text-white px-4 rounded font-bold text-xs transition flex items-center gap-1"
            >
                {isTranslating ? <Loader2 className="animate-spin" size={14} /> : "è© å”±"}
            </button>
        </div>
        
        {/* Translation Result Display */}
        {transResult && (
          <div className="mt-3 p-3 bg-slate-900 border border-blue-500/50 rounded animate-in fade-in duration-300">
            <div className="text-[10px] text-blue-400 mb-1 font-bold">RESULT</div>
            <div className="text-lg text-white font-bold leading-relaxed">{transResult}</div>
          </div>
        )}
      </div>

      <div className="text-center mb-4">
        <h2 className="text-lg font-bold text-purple-400">å¸¸ç”¨æºé€šå’’èª</h2>
        <p className="text-xs text-slate-500">é»æ“Šå¡ç‰‡å¯æ”¾å¤§çµ¦å°æ–¹è§€çœ‹</p>
      </div>
      <div className="grid gap-4">
        {SPELL_DATA.map((spell, idx) => (
          <div 
            key={idx} 
            onClick={() => setSelectedSpell(spell)}
            className="bg-slate-800 border-2 border-purple-500/30 p-4 rounded-sm hover:border-purple-500 transition group cursor-pointer relative overflow-hidden"
          >
            <div className="absolute -right-4 -bottom-4 text-6xl opacity-10 group-hover:opacity-20 transition-opacity select-none grayscale">{spell.icon}</div>
            <div className="flex items-center gap-3 mb-2">
              <div className="text-2xl">{spell.icon}</div>
              <div className="font-bold text-purple-300 flex-1">{spell.title}</div>
              <ZoomIn className="w-4 h-4 text-slate-500 opacity-50 group-hover:opacity-100" />
            </div>
            <div className="bg-slate-900 p-2 rounded border border-slate-700 mb-1 pointer-events-none">
              <div className="text-lg font-bold text-white text-center">{spell.jp}</div>
            </div>
            <div className="text-xs text-center text-slate-500">{spell.zh}</div>
          </div>
        ))}
      </div>

      {selectedSpell && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setSelectedSpell(null)}>
            <div className="bg-slate-900 border-4 border-purple-500 p-6 rounded-lg max-w-sm w-full relative shadow-[0_0_30px_rgba(168,85,247,0.5)]" onClick={e => e.stopPropagation()}>
                <button onClick={() => setSelectedSpell(null)} className="absolute top-2 right-2 text-slate-400 hover:text-white">
                    <X size={24} />
                </button>
                <div className="text-center">
                    <div className="text-6xl mb-4 animate-bounce">{selectedSpell.icon}</div>
                    <div className="text-2xl font-bold text-purple-300 mb-6 border-b border-purple-800 pb-2">{selectedSpell.title}</div>
                    <div className="bg-white text-black p-6 rounded-lg mb-4 shadow-inner">
                        <div className="text-3xl font-black leading-normal">{selectedSpell.jp}</div>
                    </div>
                    <div className="text-lg text-slate-400">{selectedSpell.zh}</div>
                    <div className="mt-6 text-xs text-slate-600 uppercase tracking-widest">è© å”±æ¨¡å¼ ACTIVE</div>
                </div>
            </div>
        </div>
      )}
    </div>
  );

  const SystemView = () => (
    <div className="w-full animate-in fade-in duration-300 pb-20">
      <div className="bg-slate-800 border-2 border-blue-500/30 p-4 mb-4 rounded-sm">
        <h3 className="font-bold text-blue-300 mb-3 flex items-center gap-2">
          <Shield className="w-4 h-4" /> è£å‚™æª¢æŸ¥
        </h3>
        <div className="space-y-2">
          {checklist.map((item) => (
            <div 
              key={item.id} 
              onClick={() => toggleCheck(item.id)}
              className={`flex items-center gap-3 p-2 rounded cursor-pointer border border-transparent hover:bg-slate-700 transition ${item.checked ? 'opacity-50' : ''}`}
            >
              <div className={`w-5 h-5 border-2 flex items-center justify-center rounded-sm ${item.checked ? 'bg-green-600 border-green-600' : 'border-slate-500'}`}>
                {item.checked && <CheckSquare className="w-3 h-3 text-white" />}
              </div>
              <span className={`text-sm ${item.checked ? 'line-through text-slate-500' : 'text-slate-200'}`}>{item.text}</span>
            </div>
          ))}
        </div>
      </div>
      
      <div className="bg-slate-800 border-2 border-slate-700 p-4 rounded-sm">
        <h3 className="font-bold text-slate-400 mb-2 flex items-center gap-2">
          <Cloud className="w-4 h-4" /> ç’°å¢ƒç‹€æ…‹
        </h3>
        <div className="flex justify-between items-center bg-slate-900 p-3 rounded mb-3">
          <div>
            <div className="text-2xl font-bold text-white">{weatherTemp}Â°C</div>
            <div className="text-xs text-slate-400">æ—¥æœ¬åå¤å±‹</div>
          </div>
          <Cloud className="w-8 h-8 text-slate-500" />
        </div>
        
        {/* 5. Outfit Advice */}
        <div className="bg-slate-900/50 border border-slate-700 p-3 rounded flex items-start gap-3">
            <Shirt className="w-5 h-5 text-blue-400 mt-1 flex-shrink-0" />
            <div>
                <div className="text-xs text-blue-400 font-bold mb-1">ç©¿æ­å»ºè­° (OUTFIT ADVICE)</div>
                <div className="text-sm text-slate-300">{getOutfitAdvice(weatherTemp)}</div>
            </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-900 text-white font-mono p-4 flex flex-col items-center max-w-md mx-auto shadow-2xl border-x-4 border-slate-800">
      <div className="w-full mb-6 border-b-4 border-slate-700 pb-4 text-center sticky top-0 bg-slate-900/95 backdrop-blur z-20 pt-2">
        <h1 className="text-xl font-bold tracking-widest text-yellow-400 mb-2 uppercase drop-shadow-md">
          åå¤å±‹å†’éšªæ—¥èªŒ
        </h1>
        <div className="text-[10px] text-slate-400 flex justify-center gap-4 uppercase tracking-wider">
          <span className="flex items-center gap-1"><Shield className="w-3 h-3" /> ç­‰ç´š: 5</span>
          <span className="flex items-center gap-1 text-blue-400"><Calendar className="w-3 h-3" /> {countdown}</span>
        </div>
      </div>

      {activeTab === 'quest' && <QuestView />}
      {activeTab === 'inventory' && <InventoryView />}
      {activeTab === 'grimoire' && <GrimoireView />}
      {activeTab === 'system' && <SystemView />}

      <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900 border-t-4 border-slate-700 p-2 z-30">
        <div className="grid grid-cols-4 gap-1">
          <button onClick={() => setActiveTab('quest')} className={`flex flex-col items-center justify-center p-2 rounded transition-all ${activeTab === 'quest' ? 'text-yellow-400 bg-slate-800 border-b-2 border-yellow-400' : 'text-slate-500 hover:text-slate-300'}`}>
            <Scroll className="w-5 h-5 mb-1" /><span className="text-[10px] font-bold">ä»»å‹™</span>
          </button>
          <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center justify-center p-2 rounded transition-all ${activeTab === 'inventory' ? 'text-yellow-400 bg-slate-800 border-b-2 border-yellow-400' : 'text-slate-500 hover:text-slate-300'}`}>
            <Coins className="w-5 h-5 mb-1" /><span className="text-[10px] font-bold">è¡Œå›Š</span>
          </button>
          <button onClick={() => setActiveTab('grimoire')} className={`flex flex-col items-center justify-center p-2 rounded transition-all ${activeTab === 'grimoire' ? 'text-yellow-400 bg-slate-800 border-b-2 border-yellow-400' : 'text-slate-500 hover:text-slate-300'}`}>
            <BookOpen className="w-5 h-5 mb-1" /><span className="text-[10px] font-bold">é­”å°æ›¸</span>
          </button>
          <button onClick={() => setActiveTab('system')} className={`flex flex-col items-center justify-center p-2 rounded transition-all ${activeTab === 'system' ? 'text-yellow-400 bg-slate-800 border-b-2 border-yellow-400' : 'text-slate-500 hover:text-slate-300'}`}>
            <Settings className="w-5 h-5 mb-1" /><span className="text-[10px] font-bold">ç³»çµ±</span>
          </button>
        </div>
      </div>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      `}</style>
    </div>
  );
};

export default App;