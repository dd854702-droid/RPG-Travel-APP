<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹å†’éšªæ—¥èªŒ | Nagoya Adventure Log</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- 3. è¨­å®š Import Map (åŒ…å« Firebase) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <!-- 4. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* é¢¨æ ¼è¨­å®š */
        :root {
            --bg-dark: #0f172a;
            --text-main: #e2e8f0;
            --accent-gold: #fbbf24;
            --accent-blue: #60a5fa;
            --accent-red: #f87171;
        }
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
        
        /* éœ“è™¹å…‰æšˆæ•ˆæœ */
        .glow-text { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .glow-border { box-shadow: 0 0 8px rgba(96, 165, 250, 0.6); }

        /* åœ“é¤…åœ–æ¨£å¼ */
        .pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--pie-gradient));
            position: relative;
        }
        .pie-chart::after {
            content: "";
            position: absolute;
            inset: 40px; /* ç”œç”œåœˆå¤§å° */
            background: #1e293b; /* bg-slate-800 */
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown, 
            Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
            Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink, Thermometer,
            TrendingUp, Save, Clock, Map, PieChart, Volume2, Image as ImageIcon, Navigation, Timer, Bus, Car, Ticket,
            Compass, Search, ArrowRightLeft, Landmark, LogOut, User, Star
        } from 'lucide-react';
        
        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signInAnonymously, 
            onAuthStateChanged, 
            signOut,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot,
            collection 
        } from 'firebase/firestore';

        // --- CONFIGURATION START ---
        // 1. è‹¥è¦å•Ÿç”¨çœŸæ­£çš„ Gmail ç™»å…¥ï¼Œè«‹å°‡ä¸‹æ–¹æ”¹ç‚º true
        const USE_REAL_GOOGLE_AUTH = true; 

        // 2. è«‹å°‡æ‚¨çš„ Firebase Config è²¼åœ¨ä¸‹æ–¹ (è‹¥ USE_REAL_GOOGLE_AUTH ç‚º true)
        const userFirebaseConfig = {
            apiKey: "AIzaSyDuVNALTfclUEXxhlDEolTLX_68mkyW59k",
            authDomain: "rpg-travel-app.firebaseapp.com",
            projectId: "rpg-travel-app",
            storageBucket: "rpg-travel-app.firebasestorage.app",
            messagingSenderId: "120243575408",
            appId: "1:120243575408:web:eb941d7a7af5cd65ecf2b5",
            measurementId: "G-0ZSW6HSN2S"
        };
        // --- CONFIGURATION END ---

        // --- Firebase Initialization Logic ---
        const systemConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = (systemConfig) ? systemConfig : userFirebaseConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- Icon Map for Dynamic Rendering ---
        const ICON_MAP = {
            Plane, Train, MapPin, Coffee, Utensils, ShoppingBag, Home, Footprints, Camera, ArrowDown,
            Coins, BookOpen, Scroll, Info, Shield, Zap, Cloud, Calendar, CheckSquare, X, ZoomIn, PlusCircle,
            Edit, Trash2, Globe, Shirt, RefreshCw, Loader2, Phone, Siren, AlertTriangle, ExternalLink,
            Save, Clock, Map, PieChart, Volume2, ImageIcon, Navigation, Timer, Bus, Car, Ticket,
            Compass, Search, ArrowRightLeft, Landmark, Star
        };

        // --- GLOBAL CONSTANTS (Defined before App to avoid ReferenceError) ---

        const SPELL_DATA = [
            { icon: "ğŸ§…", title: "é©…é™¤è”¥èŠ±", jp: "ãƒã‚®æŠœãã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹ä¸è¦åŠ è”¥", type: "defense" },
            { icon: "ğŸ§Š", title: "å»å†°å’’", jp: "æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹å»å†°", type: "support" },
            { icon: "ğŸ’§", title: "å¬å–šæ°´", jp: "ãŠæ°´ãã ã•ã„", zh: "è«‹çµ¦æˆ‘æ°´", type: "support" },
            { icon: "ğŸš»", title: "å°‹æ‰¾å¯†å®¤", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", zh: "å»æ‰€åœ¨å“ªè£¡", type: "exploration" },
            { icon: "ğŸ§¾", title: "çµç®—å·è»¸", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹çµå¸³", type: "interaction" },
            { icon: "ğŸ“¸", title: "æ”é­‚è¡“", jp: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ", zh: "å¯ä»¥æ‹ç…§å—ï¼Ÿ", type: "interaction" },
            { icon: "ğŸ™", title: "ç¥ˆæ±‚è¡“", jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", zh: "æˆ‘è¦é€™å€‹ (æŒ‡èœå–®)", type: "interaction" },
            { icon: "ğŸ¥¡", title: "å¸¶èµ°è¡“", jp: "æŒã¡å¸°ã‚Šã§ãŠé¡˜ã„ã—ã¾ã™", zh: "è«‹å¹«æˆ‘å¤–å¸¶", type: "support" },
        ];

        const GUIDE_DETAILS = [
            { id: 'nagoya_castle', title: 'åå¤å±‹åŸ', subtitle: 'é‡‘é¯±é–ƒè€€çš„å°¾å¼µå¾·å·å®¶å±…åŸ', tags: ['æ­·å²', 'ç™¾å¤§ååŸ'], image: 'ğŸ¯', desc: 'æ—¥æœ¬ä¸‰ååŸä¹‹ä¸€ï¼Œå±‹é ‚ä¸Šçš„é‡‘é¯±æ˜¯åå¤å±‹çš„è±¡å¾µã€‚', content: { history: 'ç”±å¾·å·å®¶åº·æ–¼1612å¹´å»ºé€ ã€‚', features: 'ã€æœ¬ä¸¸å¾¡æ®¿ã€‘å…§éƒ¨é‡‘ç¢§è¼ç…Œã€‚', tips: 'æ¨è–¦äºŒä¹‹ä¸¸åº­åœ’æ•£æ­¥ã€‚', warning: 'å¤©å®ˆé–£ç›®å‰é–‰é¤¨ä¸­ã€‚' } },
            { id: 'inuyama', title: 'çŠ¬å±±åŸ', subtitle: 'åœ‹å¯¶äº”åŸä¹‹ä¸€', tags: ['åœ‹å¯¶', 'é¢¨æ™¯'], image: 'ğŸ°', desc: 'æ—¥æœ¬ç¾å­˜æœ€å¤è€çš„æœ¨é€ å¤©å®ˆé–£ã€‚', content: { history: 'ç¹”ç”°ä¿¡åº·æ–¼1537å¹´å»ºé€ ã€‚', features: 'æ¨“æ¢¯éå¸¸é™¡å³­ã€‚', tips: 'å±±ä¸‹æœ‰ç²‰ç´…æ„›å¿ƒç¹ªé¦¬ã€‚', warning: 'å»ºè­°ç©¿è‘—ä¾¿æ–¼æ´»å‹•çš„æœè£ã€‚' } },
            { id: 'osu', title: 'å¤§é ˆå•†åº—è¡—', subtitle: 'æ··æ­æ–‡åŒ–ç™¼æºåœ°', tags: ['é€›è¡—', 'ç¾é£Ÿ'], image: 'ğŸ›ï¸', desc: 'èåˆå¤è‘—ã€å‹•æ¼«èˆ‡ç¾é£Ÿçš„æ´»åŠ›å•†åº—è¡—ã€‚', content: { history: 'é–€å‰ç”ºç™¼å±•è€Œä¾†ã€‚', features: 'è¶…é1200å®¶åº—é‹ªã€‚', tips: 'å¿…åƒç‚¸é›èˆ‡ç³°å­ã€‚', warning: 'ç¯„åœå¤§å®¹æ˜“è¿·è·¯ã€‚' } },
            { id: 'atsuta', title: 'ç†±ç”°ç¥å®®', subtitle: 'å¿ƒéˆå¯„è¨—åƒå¹´å¤å‰', tags: ['ç¥ç¤¾', 'ç¥è©±'], image: 'â›©ï¸', desc: 'ä¾›å¥‰è‰è–™åŠï¼Œåœ°ä½å´‡é«˜ã€‚', content: { history: 'è¿‘å…©åƒå¹´æ­·å²ã€‚', features: 'ä¿¡é•·å£ã€‚', tips: 'åƒæ‹œå®Œåƒè“¬èŠè»’é°»é­šé£¯ã€‚', warning: 'èšŠèŸ²è¼ƒå¤šã€‚' } },
            { id: 'sakae', title: 'æ¦® / ç¶ æ´²21', subtitle: 'æ™‚å°šä¸­å¿ƒèˆ‡å¤œæ™¯', tags: ['å¤œæ™¯', 'è³¼ç‰©'], image: 'ğŸŒƒ', desc: 'ç¶ æ´²21çš„æ°´ä¹‹å®‡å®™èˆ¹æ˜¯å¿…æ‹æ™¯é»ã€‚', content: { history: 'ç¾ä»£åŒ–è±¡å¾µã€‚', features: 'å±‹é ‚å¯æ•£æ­¥ã€‚', tips: 'æ—é‚Šæœ‰é›»è¦–å¡”ã€‚', warning: 'æ™šä¸Šé¢¨å¤§ã€‚' } }
        ];

        const INITIAL_CHECKLIST = [
            { id: 1, text: "è­·ç…§ (é€šè¡Œè­‰)", checked: false },
            { id: 2, text: "ç¶²å¡/æ¼«éŠ (é€šè¨Šæ°´æ™¶)", checked: false },
            { id: 3, text: "æ—¥å¹£ç¾é‡‘ (é‡‘å¹£)", checked: false },
            { id: 4, text: "è¡Œå‹•é›»æº (é­”åŠ›æº)", checked: false },
            { id: 5, text: "å¸¸ç”¨è—¥å“ (å›å¾©è—¥)", checked: false },
            { id: 6, text: "Visit Japan Webæˆªåœ–", checked: false },
        ];

        const INITIAL_EXPENSES = [
            { id: 1, item: "æ©Ÿç¥¨é ä»˜", cost: 12000, type: "travel", date: "2025-10-15" },
            { id: 2, item: "ä½å®¿é è¨‚", cost: 8000, type: "save", date: "2025-11-20" }
        ];

        const INITIAL_QUEST_DATA = [
            {
                day: 0, title: "åºç« : é™è½èˆ‡æ½›å…¥", date: "2026-03-02", stats: { xp: "500 XP", gold: 0, fatigue: "30%" }, 
                events: [
                { id: 'e0', time: "16:45", icon: "Plane", title: "å•Ÿç¨‹: æ¡ƒåœ’æ©Ÿå ´", desc: "æ­ä¹˜è™èˆª IT778 (16:45-20:25)", type: "start", transportTime: "", transportCost: 0, transportMode: "" },
                { id: 'e1', time: "20:25", icon: "MapPin", title: "æŠµé”æ–°åœ°åœ–", desc: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ T2", type: "checkpoint", transportTime: "3h 40m", transportCost: 0, transportMode: "Plane" },
                { id: 'e2', time: "21:15", icon: "Footprints", title: "ç©¿è¶Šé€šé“", desc: "å‰å¾€äº¤é€šå»£å ´", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e3', time: "21:37", icon: "Train", title: "æ­ä¹˜åéµç‰¹æ€¥", desc: "å¾€åå¤å±‹/å²é˜œæ–¹å‘", type: "travel", transportTime: "10m", transportCost: 1250, transportMode: "Train" },
                { id: 'e4', time: "22:08", icon: "MapPin", title: "æŠµé”é‡‘å±±ç«™", desc: "é—œéµè½‰ä¹˜é»", type: "checkpoint", transportTime: "31m", transportCost: 0, transportMode: "Train" },
                { id: 'e5', time: "22:23", icon: "Train", title: "è½‰ä¹˜åœ°ä¸‹éµ", desc: "ååŸç·š (å³ç’°)", type: "travel", transportTime: "15m", transportCost: 210, transportMode: "Train" },
                { id: 'e6', time: "22:40", icon: "Home", title: "å­˜æª”é»: Trip & Sleep", desc: "è¾¦ç†å…¥ä½", type: "save", transportTime: "10m", transportCost: 0, transportMode: "Footprints" },
                ]
            },
            {
                day: 1, title: "ç¬¬ä¸€ç« : å¸‚å ´èˆ‡ç¥æ®¿", date: "2026-03-03", stats: { xp: "1200 XP", gold: 0, fatigue: "60%" },
                events: [
                { id: 'e11', time: "08:00", icon: "Home", title: "å†’éšªé–‹å§‹", desc: "å¾ Hostel å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" },
                { id: 'e12', time: "08:45", icon: "Utensils", title: "æŸ³æ©‹ä¸­å¤®å¸‚å ´", desc: "æµ·é®®å·¡ç¦®", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Train" },
                { id: 'e13', time: "12:00", icon: "Utensils", title: "åˆé¤: é³¥é–‹ç·æœ¬å®¶", desc: "è¦ªå­ä¸¼", type: "loot", transportTime: "15m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e14', time: "13:30", icon: "ShoppingBag", title: "å¤§é ˆå•†åº—è¡—", desc: "äº¤æ˜“èˆ‡æ¢ç´¢", type: "action", transportTime: "20m", transportCost: 210, transportMode: "Train" },
                { id: 'e15', time: "15:30", icon: "Coffee", title: "ä¸‹åˆèŒ¶: Konparu", desc: "ç‚¸è¦ä¸‰æ˜æ²»", type: "heal", transportTime: "5m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e16', time: "18:30", icon: "Utensils", title: "æ™šé¤: ç†±ç”°è“¬èŠè»’", desc: "é°»é­šé£¯ä¸‰åƒ", type: "boss", transportTime: "30m", transportCost: 270, transportMode: "Train" },
                { id: 'e17', time: "20:30", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "40m", transportCost: 270, transportMode: "Train" },
                ]
            },
            {
                day: 2, title: "ç¬¬äºŒç« : å¤åŸèˆ‡å’–å•¡", date: "2026-03-04", stats: { xp: "1500 XP", gold: 0, fatigue: "75%" },
                events: [
                { id: 'e20', time: "07:45", icon: "Home", title: "æ—©å®‰åå¤å±‹", desc: "å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" },
                { id: 'e21', time: "08:00", icon: "Coffee", title: "æ—©é¤: Bucyo Coffee", desc: "å°å€‰ç´…è±†åå¸", type: "heal", transportTime: "15m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e22', time: "10:00", icon: "MapPin", title: "çŠ¬å±±åŸ", desc: "åœ‹å¯¶å¤©å®ˆé–£", type: "dungeon", transportTime: "50m", transportCost: 600, transportMode: "Train" },
                { id: 'e23', time: "12:30", icon: "Utensils", title: "åˆé¤: Sakura Chaya", desc: "ç”°æ¨‚çƒ¤è±†è…", type: "loot", transportTime: "10m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e24', time: "15:00", icon: "Coffee", title: "GOLPIE COFFEE", desc: "å† è»å’–å•¡", type: "action", transportTime: "1h 20m", transportCost: 800, transportMode: "Train" },
                { id: 'e25', time: "18:00", icon: "Utensils", title: "Solo Pizza", desc: "å† è»æŠ«è–©", type: "loot", transportTime: "30m", transportCost: 240, transportMode: "Train" },
                { id: 'e26', time: "20:00", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "15m", transportCost: 0, transportMode: "Footprints" },
                ]
            },
            {
                day: 3, title: "ç¬¬ä¸‰ç« : å°‡è»çš„æ¦®è€€", date: "2026-03-05", stats: { xp: "1800 XP", gold: 0, fatigue: "85%" },
                events: [
                { id: 'e30', time: "07:45", icon: "Home", title: "æ—©å®‰åå¤å±‹", desc: "å‡ºç™¼", type: "start", transportTime: "", transportCost: 0, transportMode: "" },
                { id: 'e31', time: "08:00", icon: "Coffee", title: "æ—©é¤: Karasu", desc: "è€æ´¾å’–å•¡å»³", type: "heal", transportTime: "15m", transportCost: 210, transportMode: "Train" },
                { id: 'e32', time: "09:30", icon: "MapPin", title: "åå¤å±‹åŸ", desc: "é‡‘é¯±èˆ‡æœ¬ä¸¸å¾¡æ®¿", type: "dungeon", transportTime: "20m", transportCost: 210, transportMode: "Bus" },
                { id: 'e33', time: "11:30", icon: "Camera", title: "å¾·å·åœ’", desc: "æ—¥å¼åº­åœ’", type: "action", transportTime: "30m", transportCost: 210, transportMode: "Bus" },
                { id: 'e34', time: "13:00", icon: "Utensils", title: "åˆé¤: Yellow", desc: "æ­å§†è›‹åŒ…é£¯", type: "loot", transportTime: "30m", transportCost: 210, transportMode: "Bus" },
                { id: 'e35', time: "15:00", icon: "ShoppingBag", title: "æ¦® (Sakae)", desc: "è³¼ç‰©", type: "trade", transportTime: "20m", transportCost: 210, transportMode: "Train" },
                { id: 'e36', time: "18:00", icon: "Utensils", title: "æ™šé¤: æµ·è€ã©ã¦", desc: "ç‰¹å¤§ç‚¸è¦", type: "boss", transportTime: "10m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e37', time: "20:00", icon: "Home", title: "è¿”å›æ“šé»", desc: "ä¼‘æ¯", type: "save", transportTime: "15m", transportCost: 210, transportMode: "Train" },
                ]
            },
            {
                day: 4, title: "çµ‚ç« : æ­¸é€”", date: "2026-03-06", stats: { xp: "2000 XP", gold: 0, fatigue: "99%" },
                events: [
                { id: 'e41', time: "09:40", icon: "Home", title: "é€€æˆ¿", desc: "å‰å¾€æ©Ÿå ´", type: "start", transportTime: "", transportCost: 0, transportMode: "" },
                { id: 'e42', time: "09:50", icon: "Train", title: "åœ°ä¸‹éµç§»å‹•", desc: "ä¸Šå‰æ´¥ -> é‡‘å±±", type: "travel", transportTime: "10m", transportCost: 210, transportMode: "Train" },
                { id: 'e43', time: "10:18", icon: "Train", title: "åéµç‰¹æ€¥ Î¼-SKY", desc: "é‡‘å±± -> æ©Ÿå ´", type: "travel", transportTime: "28m", transportCost: 1250, transportMode: "Train" },
                { id: 'e44', time: "10:50", icon: "MapPin", title: "æŠµé”æ©Ÿå ´ T1", desc: "å‰å¾€äº¤é€šå»£å ´", type: "checkpoint", transportTime: "5m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e45', time: "11:05", icon: "Footprints", title: "æ­¥è¡Œè‡³ T2", desc: "é•·è·é›¢ç§»å‹•", type: "move", transportTime: "15m", transportCost: 0, transportMode: "Footprints" },
                { id: 'e46', time: "11:05", icon: "Plane", title: "å ±åˆ° & è¨—é‹", desc: "IT779 (13:15)", type: "action", transportTime: "0m", transportCost: 0, transportMode: "" },
                { id: 'e47', time: "13:15", icon: "Plane", title: "è¿”èˆª: IT779", desc: "é£›å¾€æ¡ƒåœ’", type: "travel", transportTime: "", transportCost: 0, transportMode: "Plane" },
                { id: 'e48', time: "15:25", icon: "Home", title: "Mission Complete", desc: "ä»»å‹™çµæŸ", type: "end", transportTime: "3h 10m", transportCost: 0, transportMode: "Plane" },
                ]
            }
        ];

        const EXPENSE_TYPES = [
            { id: 'loot', label: 'ç¾é£Ÿ', color: 'bg-yellow-600 text-yellow-100', border: 'border-yellow-500' },
            { id: 'travel', label: 'äº¤é€š', color: 'bg-blue-600 text-blue-100', border: 'border-blue-500' },
            { id: 'save', label: 'ä½å®¿', color: 'bg-green-600 text-green-100', border: 'border-green-500' },
            { id: 'trade', label: 'è³¼ç‰©', color: 'bg-pink-300 text-pink-900', border: 'border-pink-300' },
            { id: 'other', label: 'å…¶ä»–', color: 'bg-slate-600 text-slate-100', border: 'border-slate-500' },
        ];

        const TRANSPORT_MODES = [
            { id: 'Footprints', icon: Footprints, label: 'æ­¥è¡Œ' },
            { id: 'Train', icon: Train, label: 'é›»è»Š' },
            { id: 'Bus', icon: Bus, label: 'å…¬è»Š' },
            { id: 'Car', icon: Car, label: 'é–‹è»Š' },
            { id: 'Plane', icon: Plane, label: 'é£›æ©Ÿ' },
        ];

        // --- Custom Hook for Firestore ---
        function useFirestoreData(user, collectionName, initialData) {
            const [data, setData] = useState(initialData);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) {
                    setData(initialData); 
                    setLoading(false);
                    return;
                }

                let collectionRef;
                if (typeof __app_id !== 'undefined') {
                    collectionRef = collection(db, 'artifacts', __app_id, 'users', user.uid, collectionName);
                } else {
                    collectionRef = collection(db, 'users', user.uid, collectionName);
                }

                const docRef = doc(collectionRef, 'main'); 

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setData(docSnap.data().items);
                    } else {
                        setDoc(docRef, { items: initialData });
                        setData(initialData);
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore Read Error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, collectionName]);

            const updateData = (newData) => {
                setData(newData);
                if (!user) return;

                let collectionRef;
                if (typeof __app_id !== 'undefined') {
                    collectionRef = collection(db, 'artifacts', __app_id, 'users', user.uid, collectionName);
                } else {
                    collectionRef = collection(db, 'users', user.uid, collectionName);
                }
                const docRef = doc(collectionRef, 'main');
                setDoc(docRef, { items: newData }).catch(e => {
                    console.error("Firestore Write Error:", e);
                    if (e.code === 'resource-exhausted' || e.message.includes('exceeded')) {
                        alert("âš ï¸ é›²ç«¯å„²å­˜ç©ºé–“ä¸è¶³ (è¶…é 1MB é™åˆ¶)\n\nè«‹åˆªé™¤éƒ¨åˆ†ç…§ç‰‡æˆ–æ¸›å°‘å…§å®¹å¾Œå†è©¦ä¸€æ¬¡ã€‚");
                    }
                });
            };

            return [data, updateData, loading];
        }

        // --- Main Component ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            // Auth Listener
            useEffect(() => {
                if (!auth) return;
                
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch(e) { console.error("Token login failed", e); }
                    } else if (USE_REAL_GOOGLE_AUTH === false && typeof __app_id !== 'undefined') {
                        try {
                            await signInAnonymously(auth);
                        } catch(e) { console.error("Anon login failed", e); }
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setAuthLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const loginWithGoogle = async () => {
                if (!auth) return;
                if (USE_REAL_GOOGLE_AUTH) {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        alert("ç™»å…¥å¤±æ•—: " + error.message);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            };

            const handleLogout = () => {
                if(auth) signOut(auth);
            };

            // Main State
            const [activeTab, setActiveTab] = useState('quest'); 
            const [activeLevel, setActiveLevel] = useState(0); 
            const [exchangeRate, setExchangeRate] = useState(0.22);
            const [currentTime, setCurrentTime] = useState("");

            // --- Firestore Hooks ---
            const [checklist, setChecklist] = useFirestoreData(user, 'checklist', INITIAL_CHECKLIST);
            const [expenses, setExpenses] = useFirestoreData(user, 'expenses', INITIAL_EXPENSES);
            const [quests, setQuests] = useFirestoreData(user, 'quests', INITIAL_QUEST_DATA);
            const [budget, setBudget] = useState(100000); 

            // --- Modal & Input States ---
            const [isAddingEvent, setIsAddingEvent] = useState(false);
            const [newEventData, setNewEventData] = useState({
                time: "10:00", title: "", desc: "", type: "action", locationQuery: "",
                transportTime: "", transportCost: "", transportMode: "Footprints" 
            });

            // Transit Search State
            const [transitFrom, setTransitFrom] = useState("");
            const [transitTo, setTransitTo] = useState("");

            // Checklist Edit State
            const [isEditingChecklist, setIsEditingChecklist] = useState(false);
            const [newChecklistItem, setNewChecklistItem] = useState("");

            // Inventory Input State
            const [editingId, setEditingId] = useState(null);
            const [newExpenseName, setNewExpenseName] = useState("");
            const [newExpenseCost, setNewExpenseCost] = useState("");
            const [newExpenseDate, setNewExpenseDate] = useState(new Date().toISOString().split('T')[0]);
            const [newExpenseType, setNewExpenseType] = useState('loot');
            const [newExpenseCurrency, setNewExpenseCurrency] = useState('JPY'); // Default JPY

            const [transInput, setTransInput] = useState("");
            const [transResult, setTransResult] = useState("");
            const [isTranslating, setIsTranslating] = useState(false);
            const [selectedSpell, setSelectedSpell] = useState(null);
            const [countdown, setCountdown] = useState("");
            const [weatherTemp, setWeatherTemp] = useState(12);
            const [expandedGuideId, setExpandedGuideId] = useState(null); 

            const fileInputRef = useRef(null);
            const [uploadingEventId, setUploadingEventId] = useState(null);

            useEffect(() => {
                const targetDate = new Date('2026-03-02T16:45:00').getTime();
                const interval = setInterval(() => {
                    const now = new Date();
                    const nowTime = now.getTime();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    setCurrentTime(`${hours}:${minutes}`);

                    const distance = targetDate - nowTime;
                    if (distance < 0) {
                        setCountdown("ä»»å‹™é€²è¡Œä¸­");
                    } else {
                        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        setCountdown(`${d}å¤©${h}æ™‚`);
                    }
                }, 1000);
                
                fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                .then(res => res.json())
                .then(data => {
                    if(data && data.rates && data.rates.TWD) setExchangeRate(data.rates.TWD);
                })
                .catch(err => console.log('Rate fetch failed'));

                return () => clearInterval(interval);
            }, []);

            // --- Handlers ---
            const searchTransit = (engine) => {
                const from = transitFrom.trim() || "ç¾åœ¨ä½ç½®";
                const to = transitTo.trim();
                if(!to) { alert("è«‹è¼¸å…¥ç›®çš„åœ°"); return; }
                let url = "";
                if(engine === 'google') {
                    const origin = from === "ç¾åœ¨ä½ç½®" ? "" : encodeURIComponent(from);
                    url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${encodeURIComponent(to)}&travelmode=transit`;
                } else if(engine === 'yahoo') {
                    url = `https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(from === "ç¾åœ¨ä½ç½®" ? "ç¾åœ¨åœ°" : from)}&to=${encodeURIComponent(to)}`;
                }
                window.open(url, '_blank');
            };

            const swapTransitPoints = () => {
                const temp = transitFrom;
                setTransitFrom(transitTo);
                setTransitTo(temp);
            };

            const speakJapanese = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                window.speechSynthesis.speak(utterance);
            };

            const openDailyMap = (dayIndex) => {
                const dayEvents = quests[dayIndex].events;
                const locations = dayEvents.map(e => e.locationQuery || e.title).filter(l => l && !l.includes("è‡ªç”±") && !l.includes("æ©Ÿ"));
                if(locations.length < 2) { alert("æ™¯é»ä¸è¶³ä»¥å»ºç«‹è·¯ç·š"); return; }
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                const waypoints = locations.slice(1, -1).map(l => encodeURIComponent(l)).join('/');
                const url = `https://www.google.com/maps/dir/${origin}/${waypoints}/${destination}`;
                window.open(url, '_blank');
            };

            const triggerImageUpload = (eventId) => {
                setUploadingEventId(eventId);
                fileInputRef.current.click();
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !uploadingEventId) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; // Limit width
                        const scale = maxWidth / img.width;
                        const width = Math.min(img.width, maxWidth);
                        const height = img.height * (width / img.width);
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Increase compression to avoid Firestore limits (0.5 quality)
                        const base64 = canvas.toDataURL('image/jpeg', 0.5);
                        
                        const newQuests = [...quests];
                        const dayEvents = newQuests[activeLevel].events;
                        const eventIdx = dayEvents.findIndex(e => e.id === uploadingEventId);
                        if(eventIdx > -1) {
                            dayEvents[eventIdx].image = base64;
                            setQuests(newQuests);
                        }
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const getExpenseStats = () => {
                const stats = { travel: 0, save: 0, loot: 0, trade: 0, other: 0 };
                let total = 0;
                expenses.forEach(e => {
                    const cost = Math.abs(e.cost);
                    total += cost;
                    if(e.type === 'travel') stats.travel += cost;
                    else if(e.type === 'save') stats.save += cost;
                    else if(e.type === 'loot') stats.loot += cost;
                    else if(e.type === 'trade') stats.trade += cost;
                    else stats.other += cost;
                });
                const pTravel = (stats.travel / total) * 100 || 0;
                const pSave = (stats.save / total) * 100 || 0;
                const pLoot = (stats.loot / total) * 100 || 0;
                const pTrade = (stats.trade / total) * 100 || 0;
                const gradient = `#3b82f6 0% ${pTravel}%, #22c55e ${pTravel}% ${pTravel + pSave}%, #eab308 ${pTravel + pSave}% ${pTravel + pSave + pLoot}%, #f9a8d4 ${pTravel + pSave + pLoot}% ${pTravel + pSave + pLoot + pTrade}%, #64748b ${pTravel + pSave + pLoot + pTrade}% 100%`;
                return { gradient, stats, total };
            };

            const deleteEvent = (dayIndex, eventId) => {
                if(!window.confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                const newQuests = [...quests];
                newQuests[dayIndex].events = newQuests[dayIndex].events.filter(e => e.id !== eventId);
                setQuests(newQuests);
            };

            const openAddModal = () => {
                setNewEventData({
                    time: "10:00", title: "", desc: "", type: "action", locationQuery: "",
                    transportTime: "", transportCost: "", transportMode: "Footprints"
                });
                setIsAddingEvent(true);
            };

            const saveNewEvent = () => {
                if (!newEventData.title) { alert("è«‹è¼¸å…¥æ¨™é¡Œ"); return; }
                let iconName = "MapPin";
                switch(newEventData.type) {
                    case 'checkpoint': iconName = "MapPin"; break;
                    case 'move': iconName = "Footprints"; break;
                    case 'travel': iconName = "Train"; break;
                    case 'save': iconName = "Home"; break;
                    case 'start': iconName = "Home"; break;
                    case 'loot': iconName = "Utensils"; break;
                    case 'action': iconName = "Camera"; break;
                    case 'heal': iconName = "Coffee"; break;
                    case 'boss': iconName = "Utensils"; break;
                    case 'dungeon': iconName = "MapPin"; break;
                    case 'trade': iconName = "ShoppingBag"; break;
                    case 'end': iconName = "Plane"; break;
                }
                const newEvent = {
                    id: Date.now().toString(),
                    time: newEventData.time,
                    icon: iconName,
                    title: newEventData.title,
                    desc: newEventData.desc,
                    type: newEventData.type,
                    locationQuery: newEventData.locationQuery || newEventData.title,
                    transportTime: newEventData.transportTime,
                    transportCost: parseInt(newEventData.transportCost) || 0,
                    transportMode: newEventData.transportMode
                };
                const newQuests = [...quests];
                newQuests[activeLevel].events.push(newEvent);
                newQuests[activeLevel].events.sort((a, b) => a.time.localeCompare(b.time));
                setQuests(newQuests);
                setIsAddingEvent(false);
            };

            const addChecklistItem = () => {
                if (!newChecklistItem.trim()) return;
                setChecklist([...checklist, { id: Date.now(), text: newChecklistItem, checked: false }]);
                setNewChecklistItem("");
            };

            const deleteChecklistItem = (id) => {
                if(window.confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) setChecklist(checklist.filter(item => item.id !== id));
            };

            const getCurrentDayGold = useMemo(() => {
                const targetDate = quests[activeLevel].date;
                const dailyExpenses = expenses.filter(e => e.date === targetDate);
                return dailyExpenses.reduce((acc, curr) => acc + curr.cost, 0);
            }, [expenses, activeLevel, quests]);

            const getOutfitAdvice = (temp) => {
                if (temp <= 5) return "æ¥µå¯’ï¼šç™¼ç†±è¡£ + ç¾½çµ¨è¡£ + åœå·¾æ‰‹å¥—";
                if (temp <= 12) return "å¯’å†·ï¼šå¤§è¡£ + æ¯›è¡£ + åœå·¾";
                if (temp <= 20) return "æ¶¼çˆ½ï¼šè–„å¤–å¥— + é•·è¢–Tæ¤";
                return "æº«æš–ï¼šçŸ­è¢– + è–„è¥¯è¡«";
            };

            const handleEdit = (expense) => {
                setEditingId(expense.id);
                setNewExpenseName(expense.item);
                setNewExpenseCost(expense.cost);
                setNewExpenseDate(expense.date || new Date().toISOString().split('T')[0]);
                setNewExpenseType(expense.type || 'loot');
                // Reset currency to JPY on edit start for simplicity or check if needed
                setNewExpenseCurrency('JPY'); 
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setNewExpenseName("");
                setNewExpenseCost("");
                setNewExpenseDate(new Date().toISOString().split('T')[0]);
                setNewExpenseType('loot');
                setNewExpenseCurrency('JPY');
            };

            const handleDelete = (id) => {
                if(window.confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) setExpenses(expenses.filter(e => e.id !== id));
            };

            const addOrUpdateExpense = () => {
                if (!newExpenseName || !newExpenseCost || !newExpenseDate) return;
                
                // Currency conversion logic
                let finalCost = parseInt(newExpenseCost);
                if (newExpenseCurrency === 'TWD') {
                    // Convert TWD to JPY
                    finalCost = Math.round(finalCost / exchangeRate);
                }

                if (editingId) {
                    setExpenses(expenses.map(e => 
                        e.id === editingId ? { ...e, item: newExpenseName, cost: finalCost, date: newExpenseDate, type: newExpenseType } : e
                    ));
                    handleCancelEdit();
                } else {
                    setExpenses([
                        { id: Date.now(), item: newExpenseName, cost: finalCost, type: newExpenseType, date: newExpenseDate }, 
                        ...expenses
                    ]);
                    setNewExpenseName("");
                    setNewExpenseCost("");
                    // Keep type and currency selection or reset? Resetting currency
                    setNewExpenseCurrency('JPY');
                }
            };

            const handleTranslate = async () => {
                if (!transInput) return;
                setIsTranslating(true);
                setTransResult("");
                try {
                const apiKey = ""; 
                if (!apiKey) {
                    setTransResult("éŒ¯èª¤ï¼šè«‹è¨­å®š API Key");
                    setIsTranslating(false);
                    return;
                }
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Translate Traditional Chinese to Japanese (Polite/Travel). Output ONLY Japanese. Input: "${transInput}"` }] }]
                    })
                    }
                );
                const data = await response.json();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (resultText) setTransResult(resultText.trim());
                else setTransResult("è© å”±å¤±æ•—...");
                } catch (error) {
                setTransResult("é­”åŠ›ä¸è¶³");
                } finally {
                setIsTranslating(false);
                }
            };

            const toggleCheck = (id) => {
                setChecklist(checklist.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
            };

            const totalSpentJPY = useMemo(() => expenses.reduce((acc, curr) => acc + curr.cost, 0), [expenses]);
            const totalSpentTWD = Math.round(totalSpentJPY * exchangeRate); 
            const remainingGold = budget - totalSpentJPY;
            const expenseStats = getExpenseStats();

            const getEventStyle = (type) => {
                switch (type) {
                case 'boss': return "border-red-500 bg-red-900/20 text-red-200";
                case 'loot': return "border-yellow-500 bg-yellow-900/20 text-yellow-200";
                case 'dungeon': return "border-purple-500 bg-purple-900/20 text-purple-200";
                case 'save': return "border-green-500 bg-green-900/20 text-green-200";
                case 'travel': return "border-blue-500 bg-blue-900/20 text-blue-200";
                case 'trade': return "border-orange-500 bg-orange-900/20 text-orange-200";
                case 'move': return "border-slate-500 bg-slate-800/50 text-slate-300";
                case 'heal': return "border-teal-500 bg-teal-900/20 text-teal-200";
                default: return "border-slate-600 bg-slate-800/50 text-slate-300";
                }
            };

            // --- Sub-Views ---

            const LoginView = () => (
                <div className="flex flex-col items-center justify-center min-h-[80vh] animate-enter">
                    <div className="bg-slate-800 border-2 border-yellow-500 p-8 rounded-lg shadow-2xl text-center max-w-xs w-full relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-yellow-500 to-red-500"></div>
                        <div className="mb-6">
                            <div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto border-4 border-yellow-500 mb-4 shadow-[0_0_20px_rgba(234,179,8,0.5)]">
                                <Shield size={40} className="text-yellow-500" />
                            </div>
                            <h2 className="text-2xl font-bold text-yellow-400 mb-1">å†’éšªè€…ç™»å…¥</h2>
                            <p className="text-xs text-slate-400 font-mono">ADVENTURER LOGIN</p>
                        </div>
                        
                        <button 
                            onClick={loginWithGoogle}
                            className="w-full bg-white hover:bg-slate-200 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-3 transition group"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg>
                            {USE_REAL_GOOGLE_AUTH ? "ä½¿ç”¨ Google å¸³è™Ÿ" : "ä»¥è¨ªå®¢èº«ä»½é€²å…¥"}
                        </button>
                        
                        <div className="mt-6 text-[10px] text-slate-500">
                            {USE_REAL_GOOGLE_AUTH 
                                ? "è³‡æ–™å°‡å®‰å…¨å„²å­˜æ–¼é›²ç«¯è³‡æ–™åº«" 
                                : "ç›®å‰ç‚ºå±•ç¤ºæ¨¡å¼ (Demo Mode)"}
                        </div>
                    </div>
                </div>
            );

            // ... QuestView, InventoryView, GrimoireView, GuideView, InfoView (Content same as before but using user/quests props) ...
            
            const QuestView = () => (
                <div className="animate-enter w-full pb-20">
                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    <div className="flex w-full overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar px-1">
                        {quests.map((quest, index) => (
                        <button key={index} onClick={() => setActiveLevel(index)} className={`flex-shrink-0 px-4 py-2 border-2 text-xs font-bold transition-all duration-200 whitespace-nowrap rounded-sm ${activeLevel === index ? "bg-blue-600 border-blue-400 text-white translate-y-1 shadow-[0_0_10px_rgba(37,99,235,0.5)]" : "bg-slate-800 border-slate-600 text-slate-400 hover:bg-slate-700"}`}>
                            {index === 0 ? "åºç« " : index === 4 ? "çµ‚ç« " : `ç¬¬ ${index} ç« `}
                        </button>
                        ))}
                    </div>
                    <div className="w-full bg-slate-800 border-2 border-slate-600 p-4 mb-6 rounded-sm relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-1 bg-yellow-600 text-[10px] text-black font-bold font-mono px-2">CURRENT QUEST</div>
                        <div className="flex justify-between items-start">
                            <h2 className="text-xl font-bold text-green-400 mb-1">{quests[activeLevel].title}</h2>
                            <button onClick={() => openDailyMap(activeLevel)} className="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded border border-blue-500 flex items-center gap-1 hover:bg-blue-800 transition"><Navigation size={12} /> è·¯ç·šåœ–</button>
                        </div>
                        <div className="text-sm text-slate-400 mb-4 flex justify-between items-center"><span className="flex items-center gap-1"><Calendar size={12}/> {quests[activeLevel].date}</span><span className="text-blue-400 font-mono text-xs border border-blue-900 bg-blue-900/30 px-2 py-0.5 rounded">T-{countdown}</span></div>
                        <div className="grid grid-cols-3 gap-2 text-xs border-t border-slate-700 pt-3">
                            <div className="text-center"><div className="text-slate-500 mb-1">ç²å¾—ç¶“é©—</div><div className="text-purple-400 font-mono">{quests[activeLevel].stats.xp}</div></div>
                            <div className="text-center border-l border-slate-700"><div className="text-slate-500 mb-1">æœ¬ç« æ”¯å‡º</div><div className="text-yellow-400 font-mono">{getCurrentDayGold > 0 ? `-Â¥${getCurrentDayGold.toLocaleString()}` : "Â¥0"}</div></div>
                            <div className="text-center border-l border-slate-700"><div className="text-slate-500 mb-1">ç–²å‹åº¦</div><div className="text-red-400 font-mono">{quests[activeLevel].stats.fatigue}</div></div>
                        </div>
                    </div>
                    <div className="w-full relative pl-4">
                        <div className="absolute left-[27px] top-4 bottom-4 w-1 bg-slate-700 z-0"></div>
                        {quests[activeLevel].events.map((event, idx) => {
                            const IconComponent = ICON_MAP[event.icon] || MapPin;
                            const isCurrent = event.time <= currentTime && (idx === quests[activeLevel].events.length - 1 || quests[activeLevel].events[idx+1].time > currentTime);
                            const TransportIcon = ICON_MAP[event.transportMode] || Footprints;
                            return (
                                <div key={event.id || idx} className="relative z-10 mb-6 group" >
                                    {(event.transportTime || event.transportCost > 0) && (
                                        <div className="flex items-center ml-[19px] mb-3 relative animate-in slide-in-from-left-2 duration-300">
                                            <div className="w-2 h-2 bg-slate-600 rounded-full border-2 border-slate-900 z-20"></div>
                                            <div className="ml-4 flex items-center gap-2 text-[10px] text-slate-400 bg-slate-900/90 px-2 py-1 rounded border border-slate-700 shadow-md">
                                                <div className="relative mr-1"><TransportIcon size={14} className={event.transportCost > 0 ? "text-yellow-100" : "text-slate-400"} />{event.transportCost > 0 && (<div className="absolute -top-1 -right-1 bg-yellow-600 text-slate-900 rounded-full p-[1px] border border-slate-900"><Ticket size={6} /></div>)}</div>
                                                {event.transportTime && <span className="flex items-center gap-1"><Timer size={10} className="text-blue-400"/> {event.transportTime}</span>}
                                                {event.transportTime && event.transportCost > 0 && <span className="text-slate-600">|</span>}
                                                {event.transportCost > 0 && <span className="flex items-center gap-1 text-yellow-500"><Coins size={10}/> Â¥{event.transportCost}</span>}
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex items-start">
                                        <div className={`w-12 h-12 flex-shrink-0 rounded-lg border-2 flex items-center justify-center bg-slate-900 shadow-lg z-10 ${event.type === 'boss' ? 'border-red-500 text-red-500' : event.type === 'travel' ? 'border-blue-500 text-blue-500' : 'border-slate-500 text-slate-400'} ${isCurrent ? 'glow-border' : ''}`}><IconComponent className="w-5 h-5" /></div>
                                        <div className={`ml-4 flex-1 border-2 p-3 rounded-lg relative transition-transform ${getEventStyle(event.type)} ${isCurrent ? 'ring-2 ring-blue-400/50' : ''}`}>
                                            <div className={`absolute top-4 -left-2 w-3 h-3 border-l-2 border-b-2 bg-inherit transform rotate-45 ${event.type === 'boss' ? 'border-red-500 bg-slate-900' : 'border-inherit bg-slate-900'}`}></div>
                                            {isCurrent && (<div className="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold animate-pulse shadow-lg z-20">NOW</div>)}
                                            {event.image && (<div className="mb-3 rounded overflow-hidden border border-slate-600"><img src={event.image} alt="Diary" className="w-full h-32 object-cover" /></div>)}
                                            <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => triggerImageUpload(event.id)} className="text-slate-500 hover:text-blue-400 p-1"><ImageIcon size={14} /></button><button onClick={() => deleteEvent(activeLevel, event.id)} className="text-slate-500 hover:text-red-400 p-1"><Trash2 size={14} /></button></div>
                                            <div className="flex justify-between items-start mb-1 pr-6">{(event.locationQuery || event.title) ? (<a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.locationQuery || event.title)}`} target="_blank" className="font-bold text-sm tracking-wide hover:text-blue-300 flex items-center gap-1 border-b border-dashed border-slate-500/50 pb-0.5">{event.title} <ExternalLink size={10} className="inline opacity-70"/></a>) : (<span className="font-bold text-sm tracking-wide">{event.title}</span>)}<span className="text-xs font-mono bg-black/30 px-1 rounded text-slate-200">{event.time}</span></div>
                                            <p className="text-xs opacity-90 leading-relaxed text-slate-300">{event.desc}</p>
                                        </div>
                                    </div>
                                    {idx !== quests[activeLevel].events.length - 1 && (<div className="absolute left-[22px] -bottom-4 text-slate-600"><ArrowDown size={12} /></div>)}
                                </div>
                            );
                        })}
                        <div className="relative z-10 mt-4 mb-10 pl-16">
                            <button onClick={openAddModal} className="w-full border-2 border-dashed border-slate-600 text-slate-500 rounded-lg p-3 hover:border-yellow-500 hover:text-yellow-400 transition flex items-center justify-center gap-2 group">
                                <PlusCircle className="group-hover:rotate-90 transition-transform" /><span className="text-xs font-bold">æ–°å¢è¡Œç¨‹ (ADD DATA)</span>
                            </button>
                        </div>
                        <div className="flex items-center mt-8 mb-8 opacity-50"><div className="w-3 h-3 bg-slate-600 rounded-full mx-auto relative right-2"></div><div className="text-xs text-slate-500 ml-4 font-mono">// LOG END</div></div>
                    </div>
                    {isAddingEvent && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter">
                            <div className="bg-slate-900 border-2 border-yellow-600 w-full max-w-sm rounded-lg p-5 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                                <button onClick={() => setIsAddingEvent(false)} className="absolute top-3 right-3 text-slate-500 hover:text-white"><X size={20}/></button>
                                <h3 className="text-yellow-500 font-bold mb-4 flex items-center gap-2"><Edit size={18} /> æ–°å¢è¡Œç¨‹ç¯€é»</h3>
                                <div className="space-y-3">
                                    <div><label className="text-[10px] text-slate-400 block mb-1">æ™‚é–“</label><div className="flex items-center bg-slate-800 border border-slate-600 rounded px-3 py-2"><Clock size={14} className="text-slate-400 mr-2"/><input type="time" value={newEventData.time} onChange={e => setNewEventData({...newEventData, time: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none font-mono"/></div></div>
                                    <div className="grid grid-cols-2 gap-2"><div><label className="text-[10px] text-blue-400 block mb-1">å‰ç½®ç§»å‹•æ™‚é–“</label><div className="flex items-center bg-slate-800 border border-slate-600 rounded px-3 py-2"><Timer size={14} className="text-slate-400 mr-2"/><input type="text" placeholder="15m" value={newEventData.transportTime} onChange={e => setNewEventData({...newEventData, transportTime: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none"/></div></div><div><label className="text-[10px] text-yellow-400 block mb-1">é ä¼°è²»ç”¨</label><div className="flex items-center bg-slate-800 border border-slate-600 rounded px-3 py-2"><Coins size={14} className="text-slate-400 mr-2"/><input type="number" placeholder="Â¥" value={newEventData.transportCost} onChange={e => setNewEventData({...newEventData, transportCost: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none"/></div></div></div>
                                    <div><label className="text-[10px] text-blue-300 block mb-1">äº¤é€šæ–¹å¼</label><div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">{TRANSPORT_MODES.map(mode => { const ModeIcon = mode.icon; return (<button key={mode.id} onClick={() => setNewEventData({...newEventData, transportMode: mode.id})} className={`flex flex-col items-center justify-center p-2 rounded border min-w-[50px] ${newEventData.transportMode === mode.id ? 'bg-blue-900 border-blue-500 text-blue-200' : 'bg-slate-800 border-slate-600 text-slate-500'}`}><ModeIcon size={16} className="mb-1" /><span className="text-[10px]">{mode.label}</span></button>)})}</div></div>
                                    <div><label className="text-[10px] text-slate-400 block mb-1">æ¨™é¡Œ / åœ°é»</label><div className="flex items-center bg-slate-800 border border-slate-600 rounded px-3 py-2"><MapPin size={14} className="text-slate-400 mr-2"/><input type="text" placeholder="åå¤å±‹åŸ" value={newEventData.title} onChange={e => setNewEventData({...newEventData, title: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none"/></div></div>
                                    <div><label className="text-[10px] text-slate-400 block mb-1">èªªæ˜</label><div className="bg-slate-800 border border-slate-600 rounded px-3 py-2"><textarea rows="2" placeholder="è©³ç´°è³‡è¨Š..." value={newEventData.desc} onChange={e => setNewEventData({...newEventData, desc: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none resize-none"/></div></div>
                                    <div><label className="text-[10px] text-slate-400 block mb-1">é¡å‹</label><div className="grid grid-cols-3 gap-2">{[{id: 'checkpoint', label: 'æ‰“å¡', color: 'border-slate-500'},{id: 'move', label: 'ç§»å‹•', color: 'border-slate-500'},{id: 'travel', label: 'äº¤é€š', color: 'border-blue-500 text-blue-400'},{id: 'loot', label: 'ç¾é£Ÿ', color: 'border-yellow-500 text-yellow-400'},{id: 'action', label: 'æ™¯é»', color: 'border-white'},{id: 'heal', label: 'ä¼‘æ¯', color: 'border-teal-500 text-teal-400'},{id: 'trade', label: 'è³¼ç‰©', color: 'border-orange-500 text-orange-400'},{id: 'boss', label: 'å¤§é¤', color: 'border-red-500 text-red-400'},{id: 'save', label: 'ä½å®¿', color: 'border-green-500 text-green-400'},].map(t => (<button key={t.id} onClick={() => setNewEventData({...newEventData, type: t.id})} className={`text-xs py-2 rounded border ${newEventData.type === t.id ? `${t.color} bg-slate-800 font-bold` : 'border-slate-700 text-slate-500 bg-slate-900'}`}>{t.label}</button>))}</div></div>
                                    <div><label className="text-[10px] text-slate-400 block mb-1">Google Maps é—œéµå­—</label><div className="flex items-center bg-slate-800 border border-slate-600 rounded px-3 py-2"><Map size={14} className="text-slate-400 mr-2"/><input type="text" placeholder="è‹¥ä¸åŒæ–¼æ¨™é¡Œè«‹è¼¸å…¥..." value={newEventData.locationQuery} onChange={e => setNewEventData({...newEventData, locationQuery: e.target.value})} className="bg-transparent text-white text-sm w-full outline-none"/></div></div>
                                </div>
                                <button onClick={saveNewEvent} className="w-full mt-6 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded flex items-center justify-center gap-2"><Save size={18}/> å¯«å…¥æ—¥èªŒ (SAVE)</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            const InventoryView = () => (
                <div className="w-full animate-enter pb-32 relative min-h-[500px]">
                    <div className="bg-slate-800 border-2 border-yellow-600 p-4 mb-6 rounded-sm text-center shadow-[0_0_15px_rgba(234,179,8,0.15)] flex justify-between items-center">
                        <div className="text-left"><div className="text-xs text-yellow-600 font-bold mb-1 tracking-widest">CURRENT GOLD</div><div className="text-3xl text-yellow-400 font-mono font-bold glow-text">Â¥{remainingGold.toLocaleString()}</div><div className="text-[10px] text-slate-500 mt-1 font-mono"><span>SPENT: Â¥{totalSpentJPY.toLocaleString()}</span></div></div>
                        <div className="pie-chart" style={{'--pie-gradient': expenseStats.gradient}}></div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 mb-4 text-[10px] text-slate-400">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-blue-500 rounded-full"></div> äº¤é€š: Â¥{expenseStats.stats.travel.toLocaleString()}</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div> ä½å®¿: Â¥{expenseStats.stats.save.toLocaleString()}</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-yellow-500 rounded-full"></div> ç¾é£Ÿ: Â¥{expenseStats.stats.loot.toLocaleString()}</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-pink-300 rounded-full"></div> è³¼ç‰©: Â¥{expenseStats.stats.trade.toLocaleString()}</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-slate-500 rounded-full"></div> å…¶ä»–: Â¥{expenseStats.stats.other.toLocaleString()}</div>
                    </div>
                    <div className={`bg-slate-800 border-2 ${editingId ? 'border-green-500' : 'border-slate-700'} p-3 mb-6 rounded-sm transition-colors duration-300`}>
                        <div className="flex justify-between items-center mb-2"><h3 className={`text-xs font-bold ${editingId ? 'text-green-400' : 'text-slate-400'} uppercase`}>{editingId ? "ä¿®æ”¹äº¤æ˜“ç´€éŒ„" : "æ–°å¢äº¤æ˜“ç´€éŒ„"}</h3>{editingId && (<button onClick={handleCancelEdit} className="text-[10px] text-red-400 hover:underline">å–æ¶ˆ</button>)}</div>
                        <div className="flex gap-2 mb-2 overflow-x-auto pb-1 no-scrollbar">{EXPENSE_TYPES.map(t => (<button key={t.id} onClick={() => setNewExpenseType(t.id)} className={`px-3 py-1 text-[10px] rounded-full border ${newExpenseType === t.id ? `${t.color} ${t.border}` : 'bg-slate-900 border-slate-700 text-slate-500'}`}>{t.label}</button>))}</div>
                        <div className="flex items-center gap-2 mb-2 bg-slate-900 border border-slate-600 rounded p-2"><Calendar className="w-4 h-4 text-slate-400" /><input type="date" value={newExpenseDate} onChange={(e) => setNewExpenseDate(e.target.value)} className="bg-transparent text-xs text-white outline-none w-full font-mono uppercase"/></div>
                        
                        {/* Currency Toggle + Input */}
                        <div className="flex gap-2 mb-2">
                            <input type="text" placeholder="é“å…·åç¨±" value={newExpenseName} onChange={(e) => setNewExpenseName(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 p-2 text-xs text-white rounded focus:border-yellow-500 outline-none"/>
                            
                            <div className="flex flex-col w-32 relative">
                                <div className="flex border border-slate-600 rounded overflow-hidden">
                                    <input type="number" placeholder="Â¥" value={newExpenseCost} onChange={(e) => setNewExpenseCost(e.target.value)} className="w-full p-2 text-xs bg-slate-900 text-white outline-none"/>
                                    <button 
                                        onClick={() => setNewExpenseCurrency(newExpenseCurrency === 'JPY' ? 'TWD' : 'JPY')}
                                        className={`text-[10px] px-2 font-bold transition-colors ${newExpenseCurrency === 'TWD' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                    >
                                        {newExpenseCurrency}
                                    </button>
                                </div>
                                
                                {/* Real-time conversion preview */}
                                {newExpenseCost && (
                                    <div className="absolute top-full right-0 text-[9px] text-slate-400 mt-1 pointer-events-none whitespace-nowrap">
                                        {newExpenseCurrency === 'JPY' 
                                            ? `â‰ˆ NT$${Math.round(newExpenseCost * exchangeRate).toLocaleString()}`
                                            : `â‰ˆ Â¥${Math.round(newExpenseCost / exchangeRate).toLocaleString()}`
                                        }
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <button onClick={addOrUpdateExpense} className={`w-full ${editingId ? 'bg-green-900/50 border-green-600 text-green-500 hover:bg-green-900' : 'bg-yellow-900/50 border-yellow-600 text-yellow-500 hover:bg-yellow-900'} border py-2 text-xs font-bold transition flex items-center justify-center gap-2 rounded mt-4`}>{editingId ? <RefreshCw size={14} /> : <PlusCircle size={14} />} {editingId ? "UPDATE LOG" : "ADD TO LOG"}</button>
                    </div>
                    <div className="space-y-2">
                        {expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).map((exp) => (
                        <div key={exp.id} className={`flex flex-col p-3 bg-slate-800/50 border-b ${editingId === exp.id ? 'border-green-500 bg-green-900/10' : 'border-slate-700'}`}>
                            <div className="flex justify-between items-center mb-1"><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${exp.type === 'travel' ? 'bg-blue-500' : exp.type === 'save' ? 'bg-green-500' : exp.type === 'loot' ? 'bg-yellow-500' : exp.type === 'trade' ? 'bg-pink-300' : 'bg-slate-500'}`}></div><span className="text-sm font-bold">{exp.item}</span></div><div className="flex items-center gap-2"><span className={`text-sm font-mono ${exp.cost > 0 ? 'text-red-300' : 'text-green-300'}`}>{exp.cost > 0 ? '-' : '+'}Â¥{Math.abs(exp.cost).toLocaleString()}</span><button onClick={() => handleEdit(exp)} className="text-slate-500 hover:text-green-400 p-1"><Edit size={12} /></button><button onClick={() => handleDelete(exp.id)} className="text-slate-500 hover:text-red-400 p-1"><Trash2 size={12} /></button></div></div>
                            <div className="text-[10px] text-slate-500 flex items-center gap-1 font-mono"><Calendar size={10} /> {exp.date}</div>
                        </div>
                        ))}
                    </div>
                    <div className="fixed bottom-[72px] left-0 right-0 max-w-md mx-auto bg-slate-900/95 backdrop-blur border-t-2 border-slate-700 p-3 shadow-lg z-10 flex justify-between items-center"><div className="text-[10px] text-slate-400"><div>RATE: {exchangeRate}</div><div>NTD EST.</div></div><div className="text-xl font-mono text-slate-300 font-bold">â‰ˆ ${totalSpentTWD.toLocaleString()}</div></div>
                </div>
            );

            // ... GuideView, GrimoireView, InfoView (omitted for brevity, assume same content) ...
            
            const GuideView = () => (<div className="w-full animate-enter pb-20"><div className="space-y-4">{GUIDE_DETAILS.map((place) => (<div key={place.id} className="bg-slate-800 border-2 border-slate-600 rounded-lg overflow-hidden transition-all duration-300"><div className="p-4 cursor-pointer hover:bg-slate-700/50 flex items-center gap-4" onClick={() => setExpandedGuideId(expandedGuideId === place.id ? null : place.id)}><div className="text-4xl">{place.image}</div><div className="flex-1"><h3 className="font-bold text-lg text-yellow-400">{place.title}</h3><p className="text-xs text-slate-400 mb-1">{place.subtitle}</p><div className="flex gap-1 flex-wrap">{place.tags.map(tag => (<span key={tag} className="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-blue-300 border border-slate-600">#{tag}</span>))}</div></div><div className={`transition-transform duration-300 ${expandedGuideId === place.id ? 'rotate-180' : ''}`}><ArrowDown size={16} className="text-slate-500" /></div></div>{expandedGuideId === place.id && (<div className="p-4 pt-0 border-t border-slate-700 bg-slate-900/50 animate-in slide-in-from-top-2"><div className="text-sm text-slate-300 mb-4 leading-relaxed mt-4">{place.desc}</div><div className="space-y-3 text-xs"><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-blue-400 mb-1 flex items-center gap-2"><Clock size={12}/> æ­·å²å°çŸ¥è­˜</h4><p className="text-slate-400">{place.content.history}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-yellow-400 mb-1 flex items-center gap-2"><Star size={12} /> ç‰¹è‰²èˆ‡å¿…çœ‹</h4><p className="text-slate-400">{place.content.features}</p></div><div className="bg-slate-800 p-3 rounded border border-slate-700"><h4 className="font-bold text-green-400 mb-1 flex items-center gap-2"><MapPin size={12}/> æ”»ç•¥ Tips</h4><p className="text-slate-400">{place.content.tips}</p></div><div className="bg-red-900/20 p-3 rounded border border-red-900/50"><h4 className="font-bold text-red-400 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> æ³¨æ„äº‹é …</h4><p className="text-red-200/80">{place.content.warning}</p></div></div></div>)}</div>))}</div></div>);
            
            const GrimoireView = () => (<div className="w-full animate-enter pb-20"><div className="bg-slate-800 border-2 border-blue-500 p-4 rounded-sm mb-6 relative overflow-hidden shadow-[0_0_15px_rgba(59,130,246,0.2)]"><div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">LIVE TRANSLATE</div><div className="flex items-center gap-2 mb-3"><Globe className="text-blue-400" size={20} /><h3 className="font-bold text-blue-300">é€šç”¨èªç¿»è­¯è¡“</h3></div><div className="flex gap-2"><input type="text" placeholder="è¼¸å…¥ä¸­æ–‡å’’èª..." value={transInput} onChange={(e) => setTransInput(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400 placeholder:text-slate-600"/><button onClick={handleTranslate} disabled={isTranslating} className="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:text-gray-400 text-white px-4 rounded font-bold text-xs transition flex items-center gap-1 whitespace-nowrap">{isTranslating ? <Loader2 className="animate-spin" size={14} /> : "è© å”±"}</button></div>{transResult && (<div className="mt-3 p-3 bg-slate-900 border border-blue-500/50 rounded animate-enter flex justify-between items-start"><div><div className="text-[10px] text-blue-400 mb-1 font-bold font-mono">RESULT</div><div className="text-lg text-white font-bold leading-relaxed">{transResult}</div></div><button onClick={() => speakJapanese(transResult)} className="text-blue-400 hover:text-white p-2"><Volume2 size={20} /></button></div>)}</div><div className="text-center mb-4 flex items-center justify-center gap-2 opacity-80"><div className="h-[1px] bg-slate-700 w-10"></div><h2 className="text-sm font-bold text-purple-400">å¸¸ç”¨æºé€šå¡ç‰Œ</h2><div className="h-[1px] bg-slate-700 w-10"></div></div><div className="grid grid-cols-2 gap-3">{SPELL_DATA.map((spell, idx) => (<div key={idx} onClick={() => setSelectedSpell(spell)} className="bg-slate-800 border border-slate-600 p-3 rounded hover:border-purple-500 transition group cursor-pointer relative overflow-hidden flex flex-col items-center text-center shadow-md active:scale-[0.98]"><div className="text-3xl mb-2 group-hover:scale-110 transition-transform">{spell.icon}</div><div className="font-bold text-purple-300 text-sm mb-1">{spell.title}</div><div className="text-[10px] text-slate-500">{spell.zh}</div><div className="absolute top-2 right-2 text-slate-500 hover:text-white" onClick={(e) => { e.stopPropagation(); speakJapanese(spell.jp); }}><Volume2 size={16} /></div></div>))}</div>{selectedSpell && (<div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-enter" onClick={() => setSelectedSpell(null)}><div className="bg-slate-900 border-4 border-purple-500 p-6 rounded-lg max-w-sm w-full relative shadow-[0_0_50px_rgba(168,85,247,0.5)] flex flex-col items-center" onClick={e => e.stopPropagation()}><button onClick={() => setSelectedSpell(null)} className="absolute top-2 right-2 text-slate-400 hover:text-white p-2"><X size={24} /></button><div className="text-8xl mb-6 animate-bounce">{selectedSpell.icon}</div><div className="text-2xl font-bold text-purple-300 mb-6 border-b-2 border-purple-800 pb-2 w-full text-center">{selectedSpell.title}</div><div className="bg-white text-black p-6 rounded-lg mb-4 shadow-inner w-full flex justify-between items-center"><div className="text-2xl font-black leading-snug text-center flex-1">{selectedSpell.jp}</div><button onClick={() => speakJapanese(selectedSpell.jp)} className="ml-2 text-purple-600 p-2 bg-purple-100 rounded-full hover:bg-purple-200"><Volume2 size={24} /></button></div><div className="text-lg text-slate-400">{selectedSpell.zh}</div><div className="mt-8 text-[10px] text-purple-500 font-mono tracking-[0.2em] animate-pulse">SPELL CARD ACTIVE</div></div></div>)}</div>);

            const InfoView = () => (
                <div className="w-full animate-enter pb-20 space-y-6">
                    <div className="bg-slate-800 border-2 border-blue-500 rounded-lg p-4 shadow-[0_0_15px_rgba(59,130,246,0.15)] relative overflow-hidden"><div className="absolute top-0 right-0 bg-blue-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">TRANSIT SYSTEM</div><h3 className="font-bold text-blue-300 mb-4 flex items-center gap-2"><Train className="w-5 h-5" /> æ›ä¹˜å³æ™‚æŸ¥è©¢</h3><div className="flex flex-col gap-2 relative"><div className="flex items-center gap-2"><div className="w-8 flex justify-center"><div className="w-2 h-2 rounded-full border-2 border-blue-500"></div></div><input type="text" placeholder="èµ·é» (é è¨­: ç¾åœ¨ä½ç½®)" value={transitFrom} onChange={(e) => setTransitFrom(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400 placeholder:text-slate-600"/></div><div className="absolute left-4 top-4 bottom-4 w-[1px] bg-slate-700 -z-10"></div><button onClick={swapTransitPoints} className="absolute right-4 top-[50%] -translate-y-[50%] bg-slate-700 p-1.5 rounded-full hover:bg-blue-600 transition z-10 border border-slate-600"><ArrowRightLeft size={12} className="text-white"/></button><div className="flex items-center gap-2"><div className="w-8 flex justify-center"><MapPin size={14} className="text-red-500"/></div><input type="text" placeholder="ç›®çš„åœ° (ä¾‹: åå¤å±‹åŸ)" value={transitTo} onChange={(e) => setTransitTo(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 p-2 text-sm text-white rounded outline-none focus:border-blue-400 placeholder:text-slate-600"/></div></div><div className="grid grid-cols-2 gap-2 mt-4"><button onClick={() => searchTransit('google')} className="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition"><Map size={14} /> Google Maps</button><button onClick={() => searchTransit('yahoo')} className="bg-red-600 hover:bg-red-500 text-white py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition"><Search size={14} /> Yahoo! ä¹˜æ›</button></div></div>
                    <div className="grid grid-cols-2 gap-3"><a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" className="bg-slate-800 p-4 rounded border border-slate-600 flex flex-col items-center justify-center hover:bg-slate-700 transition gap-2"><Cloud className="text-blue-400" /><span className="text-xs font-bold text-blue-100">æ—¥æœ¬æ°£è±¡å»³</span></a><div className="bg-slate-800 p-4 rounded border border-slate-600 flex flex-col items-center justify-center gap-1 relative group overflow-hidden"><div className="flex items-center gap-2 text-yellow-400 mb-1"><Coins size={18} /><span className="text-xs font-bold text-yellow-100">åŒ¯ç‡åƒè€ƒ (JPY)</span></div><div className="text-2xl font-mono font-bold text-white tracking-wider">{exchangeRate}</div><div className="text-[10px] text-slate-500 font-mono">1 JPY â‰ˆ {exchangeRate} TWD</div><RefreshCw size={12} className="absolute top-2 right-2 text-slate-600 hover:text-white transition-colors cursor-pointer" onClick={() => fetchRate()} /></div></div>
                    <div className="bg-red-900/20 border-2 border-red-500/50 p-4 rounded-sm relative overflow-hidden"><div className="absolute top-0 right-0 bg-red-600 text-[10px] px-2 py-0.5 text-white font-bold font-mono">EMERGENCY</div><h3 className="font-bold text-red-400 mb-4 flex items-center gap-2"><Siren className="w-5 h-5 animate-pulse" /> ç·Šæ€¥è¯çµ¡</h3><div className="space-y-3"><div className="flex items-center justify-between bg-black/40 p-2 rounded border border-red-900/50"><span className="text-sm font-bold text-white flex items-center gap-2"><Phone size={14}/> è­¦å¯Ÿå±€</span><span className="text-xl font-mono text-red-400 font-bold">110</span></div><div className="flex items-center justify-between bg-black/40 p-2 rounded border border-red-900/50"><span className="text-sm font-bold text-white flex items-center gap-2"><PlusCircle size={14}/> æ•‘è­·/ç«è­¦</span><span className="text-xl font-mono text-red-400 font-bold">119</span></div><div className="mt-2 text-xs text-slate-400 p-2 border-t border-red-900/30"><div className="font-bold text-red-300 mb-1">å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™• (ç·Šæ€¥)</div><div className="font-mono selectable select-all">+81-80-1009-7179</div><div className="text-[10px] opacity-70 mt-1">â€»åƒ…é™æ€¥é›£æ•‘åŠ©ä½¿ç”¨ (è»Šç¦ã€è­·ç…§éºå¤±ç­‰)</div></div></div></div>
                    <div className="bg-slate-800 border border-yellow-600/30 p-4 rounded-sm"><h3 className="font-bold text-yellow-500 mb-3 flex items-center gap-2"><AlertTriangle className="w-4 h-4" /> å†’éšªé ˆçŸ¥ (Taboos)</h3><ul className="text-xs text-slate-300 space-y-2 list-disc list-inside opacity-90"><li><strong className="text-yellow-200">åˆºé’ï¼š</strong>å¤§éƒ¨åˆ†æº«æ³‰/å¤§çœ¾æ¾¡å ‚ç¦æ­¢é€²å…¥ã€‚</li><li><strong className="text-yellow-200">é›»è»Šï¼š</strong>è»Šå»‚å…§ç¦æ­¢è¬›é›»è©±ï¼Œè«‹é–‹éœéŸ³æ¨¡å¼ã€‚</li><li><strong className="text-yellow-200">æ‹ç…§ï¼š</strong>æœªç¶“å…è¨±è«‹å‹¿ç›´æ¥æ‹æ”è·¯äººæˆ–åº—å“¡ã€‚</li><li><strong className="text-yellow-200">çµå¸³ï¼š</strong>è«‹å°‡éŒ¢æ”¾åœ¨æ«ƒå°çš„å°ç›¤å­(Cash Tray)ä¸Šã€‚</li><li><strong className="text-yellow-200">å…¥å¢ƒï¼š</strong>è‚‰é¡è£½å“(å«è‚‰ä¹¾)ã€ç”Ÿé®®æ°´æœåš´ç¦æ”œå¸¶ã€‚</li></ul></div>
                    
                    <div className="bg-slate-800 border border-slate-600 p-4 rounded-sm">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-slate-300 flex items-center gap-2">
                                <Shield className="w-4 h-4 text-blue-400" /> è£å‚™æª¢æŸ¥
                            </h3>
                            <div className="flex gap-2">
                                 <button onClick={() => setIsEditingChecklist(!isEditingChecklist)} className={`text-[10px] px-2 py-1 rounded border ${isEditingChecklist ? 'bg-yellow-600 border-yellow-500 text-white' : 'border-slate-600 text-slate-500 hover:text-white'}`}>
                                    {isEditingChecklist ? 'âœ… å®Œæˆ' : 'âœï¸ ç·¨è¼¯'}
                                </button>
                                {!isEditingChecklist && <button onClick={() => {if(window.confirm('ç¢ºå®šé‡ç½®?')) setChecklist(INITIAL_CHECKLIST)}} className="text-[10px] text-slate-500 hover:text-white underline">é‡ç½®</button>}
                            </div>
                        </div>
                        {isEditingChecklist && (
                            <div className="flex gap-2 mb-2">
                                <input 
                                    type="text" 
                                    placeholder="æ–°å¢é …ç›®..." 
                                    value={newChecklistItem}
                                    onChange={(e) => setNewChecklistItem(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white outline-none"
                                    onKeyPress={(e) => e.key === 'Enter' && addChecklistItem()}
                                />
                                <button onClick={addChecklistItem} className="bg-blue-600 text-white px-2 rounded"><PlusCircle size={14}/></button>
                            </div>
                        )}
                        <div className="space-y-2">
                        {checklist.map((item) => (
                            <div 
                            key={item.id} 
                            onClick={() => !isEditingChecklist && toggleCheck(item.id)}
                            className={`flex items-center gap-3 p-3 rounded border transition select-none ${isEditingChecklist ? 'bg-slate-800 border-slate-600' : 'cursor-pointer hover:bg-slate-700'} ${!isEditingChecklist && item.checked ? 'bg-green-900/20 border-green-900 opacity-60' : 'bg-slate-900 border-slate-700'}`}
                            >
                            {!isEditingChecklist && (
                                <div className={`w-5 h-5 border-2 flex-shrink-0 flex items-center justify-center rounded-sm transition-colors ${item.checked ? 'bg-green-600 border-green-600' : 'border-slate-500'}`}>
                                    {item.checked && <CheckSquare className="w-3 h-3 text-white" />}
                                </div>
                            )}
                            {isEditingChecklist && (
                                 <button onClick={() => deleteChecklistItem(item.id)} className="text-red-400 p-1"><Trash2 size={14}/></button>
                            )}
                            <span className={`text-sm ${!isEditingChecklist && item.checked ? 'line-through text-slate-500' : 'text-slate-200'}`}>{item.text}</span>
                            </div>
                        ))}
                        </div>
                    </div>

                    <div className="bg-slate-900/50 border border-slate-700 p-3 rounded flex items-start gap-3">
                        <Shirt className="w-5 h-5 text-blue-400 mt-1 flex-shrink-0" />
                        <div><div className="text-xs text-blue-400 font-bold mb-1 font-mono">OUTFIT ADVICE ({weatherTemp}Â°C)</div><div className="text-sm text-slate-300">{getOutfitAdvice(weatherTemp)}</div></div>
                    </div>
                    
                    <div className="mt-8 text-center">
                        <button onClick={handleLogout} className="text-xs text-slate-500 hover:text-red-400 underline flex items-center justify-center gap-1 mx-auto">
                            <LogOut size={12}/> ç™»å‡º (Logout)
                        </button>
                    </div>
                </div>
            );

            // If not logged in, show LoginView
            if (!user && authLoading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white"><Loader2 className="animate-spin text-yellow-500" size={40}/></div>;
            if (!user) return (
                <div className="min-h-screen max-w-md mx-auto shadow-2xl border-x border-slate-800 bg-slate-900 relative">
                    <LoginView />
                </div>
            );

            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto shadow-2xl border-x border-slate-800 bg-slate-900 relative">
                
                <div className="w-full mb-6 border-b border-slate-800 pb-4 text-center sticky top-0 bg-slate-900/95 backdrop-blur z-20 pt-4 px-4 shadow-lg">
                    <h1 className="text-xl font-bold tracking-widest text-yellow-400 mb-2 uppercase drop-shadow-[0_2px_10px_rgba(250,204,21,0.2)] flex items-center justify-center gap-2">
                        <MapPin size={18} /> åå¤å±‹å†’éšªæ—¥èªŒ
                    </h1>
                    <div className="text-[10px] text-slate-400 flex justify-center gap-4 uppercase tracking-wider font-mono">
                    <span className="flex items-center gap-1"><Shield className="w-3 h-3" /> LV.5 Traveler</span>
                    </div>
                </div>

                <div className="px-4">
                    {activeTab === 'quest' && <QuestView />}
                    {activeTab === 'inventory' && <InventoryView />}
                    {activeTab === 'grimoire' && <GrimoireView />}
                    {activeTab === 'guide' && <GuideView />}
                    {activeTab === 'info' && <InfoView />}
                </div>

                <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900 border-t border-slate-700 p-2 z-30 pb-safe">
                    <div className="grid grid-cols-5 gap-1">
                    <button onClick={() => setActiveTab('quest')} className={`flex flex-col items-center justify-center p-2 rounded transition-all duration-300 ${activeTab === 'quest' ? 'text-yellow-400 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}>
                        <Scroll className={`w-5 h-5 mb-1 ${activeTab === 'quest' ? 'drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]' : ''}`} />
                        <span className="text-[10px] font-bold">ä»»å‹™</span>
                    </button>
                    <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center justify-center p-2 rounded transition-all duration-300 ${activeTab === 'inventory' ? 'text-yellow-400 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}>
                        <Coins className={`w-5 h-5 mb-1 ${activeTab === 'inventory' ? 'drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]' : ''}`} />
                        <span className="text-[10px] font-bold">è¡Œå›Š</span>
                    </button>
                    <button onClick={() => setActiveTab('grimoire')} className={`flex flex-col items-center justify-center p-2 rounded transition-all duration-300 ${activeTab === 'grimoire' ? 'text-yellow-400 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}>
                        <BookOpen className={`w-5 h-5 mb-1 ${activeTab === 'grimoire' ? 'drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]' : ''}`} />
                        <span className="text-[10px] font-bold">é­”å°æ›¸</span>
                    </button>
                    <button onClick={() => setActiveTab('guide')} className={`flex flex-col items-center justify-center p-2 rounded transition-all duration-300 ${activeTab === 'guide' ? 'text-yellow-400 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}>
                        <Compass className={`w-5 h-5 mb-1 ${activeTab === 'guide' ? 'drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]' : ''}`} />
                        <span className="text-[10px] font-bold">å°è¦½</span>
                    </button>
                    <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center justify-center p-2 rounded transition-all duration-300 ${activeTab === 'info' ? 'text-yellow-400 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}>
                        <Info className={`w-5 h-5 mb-1 ${activeTab === 'info' ? 'drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]' : ''}`} />
                        <span className="text-[10px] font-bold">è³‡è¨Š</span>
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>